name: Cleanup Preview

on:
  delete:
  pull_request:
    types: [closed]

concurrency:
  group: preview-deploy
  cancel-in-progress: false

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    # Only run for claude/* branches in this repo (not forks)
    if: >-
      (github.event_name == 'delete' && startsWith(github.event.ref, 'claude/')) ||
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository && startsWith(github.event.pull_request.head.ref, 'claude/'))
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Remove preview directory
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH="${{ github.event.pull_request.head.ref }}"
          else
            BRANCH="${{ github.event.ref }}"
          fi
          SAFE_NAME=$(echo "${BRANCH}" | sed 's/[^a-zA-Z0-9-]/-/g')

          if [ -d "docs/preview/${SAFE_NAME}" ]; then
            rm -rf "docs/preview/${SAFE_NAME}"

            # Regenerate or remove preview index
            if ls docs/preview/*/index.html 1>/dev/null 2>&1; then
              cd docs/preview
              cat > index.html << 'INDEXEOF'
              <!DOCTYPE html>
              <html><head><meta charset="utf-8"><title>Preview Builds</title>
              <style>body{font-family:system-ui,sans-serif;max-width:600px;margin:2rem auto;padding:0 1rem}
              a{display:block;padding:.5rem 0;font-size:1.1rem}</style></head>
              <body><h1>Preview Builds</h1><ul>
          INDEXEOF
              for dir in */; do
                [ "$dir" = "*/" ] && continue
                name="${dir%/}"
                echo "<li><a href=\"${name}/\">${name}</a></li>" >> index.html
              done
              echo "</ul></body></html>" >> index.html
              cd ../..
            else
              # No previews left â€” remove the whole directory
              rm -rf docs/preview
            fi

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A docs/preview
            git commit -m "Cleanup preview: ${BRANCH}"
            git push origin main
          else
            echo "No preview directory found for ${SAFE_NAME}, skipping."
          fi
