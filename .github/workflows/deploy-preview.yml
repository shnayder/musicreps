name: Deploy Preview

on:
  push:
    branches:
      - 'claude/**'
  pull_request:
    types: [opened]
    branches:
      - main

concurrency:
  group: gh-pages-deploy
  cancel-in-progress: false

jobs:
  deploy:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout feature branch
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Lint
        run: deno lint

      - name: Format check
        run: deno fmt --check

      - name: Setup Node (for esbuild)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Type check
        run: deno check src/**/*.ts

      - name: Test
        run: deno test --no-check --allow-read

      - name: Build
        run: deno task build

      - name: Deploy preview
        run: bash scripts/deploy-gh-pages.sh preview "${{ github.ref_name }}"

      - name: Comment preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const safeName = branch.replace(/[^a-zA-Z0-9-]/g, '-');
            const previewUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}/preview/${safeName}/`;

            // Find open PRs for this branch
            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open',
            });

            const marker = '<!-- preview-bot -->';
            const body = `${marker}\n**Preview deployed:** ${previewUrl}`;

            for (const pr of pulls.data) {
              // Check if we already commented
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
              });
              const existing = comments.data.find(c => c.body.includes(marker));

              if (existing) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existing.id,
                  body,
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body,
                });
              }
            }

  # Post preview comment when a PR is opened (handles PR created after push)
  comment-on-open:
    if: >-
      github.event_name == 'pull_request' &&
      startsWith(github.event.pull_request.head.ref, 'claude/')
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Comment preview URL on new PR
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;
            const safeName = branch.replace(/[^a-zA-Z0-9-]/g, '-');
            const previewUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}/preview/${safeName}/`;

            const marker = '<!-- preview-bot -->';
            const body = `${marker}\n**Preview deployed:** ${previewUrl}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body,
            });
