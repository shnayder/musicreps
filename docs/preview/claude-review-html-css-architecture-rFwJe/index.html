<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fretboard Trainer</title>
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">

  <style>
    :root {
  /* Semantic colors */
  --color-success: #4CAF50;
  --color-success-dark: #388E3C;
  --color-success-bg: #e8f5e9;
  --color-success-text: #2e7d32;
  --color-error: #f44336;
  --color-error-bg: #ffebee;
  --color-error-text: #c62828;
  --color-focus: #2196F3;
  --color-focus-bg: #e3f2fd;
  --color-recommended: #FF9800;
  --color-highlight: #FFD700;

  /* Text */
  --color-text: #333;
  --color-text-muted: #666;
  --color-text-light: #999;

  /* Surfaces & backgrounds */
  --color-bg: #fff;
  --color-surface: #f5f5f5;
  --color-surface-hover: #f0f0f0;
  --color-surface-alt: #eee;
  --color-surface-pressed: #d0d0d0;

  /* Borders */
  --color-border: #999;
  --color-border-light: #ccc;
  --color-border-lighter: #ddd;

  /* Heatmap scale (green → red, shared across retention & speed) */
  --heatmap-none: #ddd;
  --heatmap-5: hsl(120, 60%, 65%);
  --heatmap-4: hsl(80, 60%, 65%);
  --heatmap-3: hsl(50, 60%, 65%);
  --heatmap-2: hsl(30, 60%, 65%);
  --heatmap-1: hsl(0, 60%, 65%);
}

* { -webkit-tap-highlight-color: transparent; }
body {
  font-family: system-ui, -apple-system, sans-serif;
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 1rem;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  min-height: 100dvh;
}

/* --- Top bar & navigation --- */
.top-bar {
  display: flex;
  align-items: center;
  padding: 0.5rem 0;
  position: relative;
}
.hamburger {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.25rem 0.5rem;
  margin: 0;
  line-height: 1;
  color: var(--color-text);
}
.top-bar h1 {
  margin: 0;
  font-size: 1.3rem;
  flex: 1;
  text-align: center;
}
.version {
  font-size: 0.75rem;
  color: var(--color-text-light);
  padding-right: 0.25rem;
}
.nav-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.3);
  z-index: 99;
}
.nav-overlay.open {
  display: block;
}
.nav-drawer {
  position: fixed;
  top: 0;
  left: -280px;
  width: 260px;
  height: 100%;
  background: var(--color-bg);
  box-shadow: 2px 0 8px rgba(0,0,0,0.15);
  z-index: 100;
  transition: left 0.2s ease;
  padding: 1rem 0;
  overflow-y: auto;
}
.nav-drawer.open {
  left: 0;
}
.nav-drawer button {
  display: block;
  width: 100%;
  text-align: left;
  padding: 0.75rem 1.5rem;
  border: none;
  background: none;
  font-size: 1rem;
  cursor: pointer;
  color: var(--color-text);
  margin: 0;
}
.nav-drawer button:hover {
  background: var(--color-surface-hover);
}
.nav-drawer button.active {
  background: var(--color-success-bg);
  color: var(--color-success-text);
  font-weight: 600;
}

/* --- Mode screens --- */
.mode-screen {
  padding-top: 0.5rem;
  flex: 1;
}

/* --- Fretboard --- */
#mode-fretboard {
  display: flex;
  flex-direction: column;
}
#mode-fretboard .fretboard-wrapper {
  order: -1;
}
#mode-fretboard.quiz-active .fretboard-wrapper {
  order: 0;
}
.fretboard-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
}
.string-toggles {
  display: flex;
  flex-direction: row;
  gap: 2px;
  justify-content: center;
}
.string-toggle {
  width: 28px;
  height: 28px;
  border: 1px solid var(--color-border);
  border-radius: 4px;
  background: var(--color-surface);
  color: var(--color-border);
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  padding: 0;
  margin: 0;
}
.string-toggle.active {
  background: var(--color-success);
  color: white;
  border-color: var(--color-success);
}
.string-toggle.recommended {
  box-shadow: 0 0 0 2px var(--color-recommended);
}
.string-toggle.active.recommended {
  border-color: var(--color-recommended);
}
.distance-toggles {
  display: flex;
  flex-direction: row;
  gap: 2px;
  justify-content: center;
}
.distance-toggle {
  height: 28px;
  border: 1px solid var(--color-border);
  border-radius: 4px;
  background: var(--color-surface);
  color: var(--color-border);
  font-size: 0.75rem;
  font-weight: 500;
  cursor: pointer;
  padding: 0 0.4rem;
  margin: 0;
}
.distance-toggle.active {
  background: var(--color-success);
  color: white;
  border-color: var(--color-success);
}
.distance-toggle.recommended {
  box-shadow: 0 0 0 2px var(--color-recommended);
}
.distance-toggle.active.recommended {
  border-color: var(--color-recommended);
}
.fretboard-container {
  position: relative;
  flex: 1;
  min-width: 0;
  max-width: 1200px;
}
.fretboard {
  width: 100%;
  height: auto;
  display: block;
  background: var(--color-bg);
  touch-action: manipulation;
}
.fret-numbers {
  position: relative;
  height: 1.5rem;
  width: 100%;
}
.fret-number {
  position: absolute;
  transform: translateX(-50%);
  font-size: 0.9rem;
  color: var(--color-text-muted);
}

/* --- Quiz controls (shared) --- */
.quiz-controls {
  text-align: center;
  margin: 1rem 0;
}
.settings-row {
  display: flex;
  align-items: center;
  gap: 1rem;
  justify-content: center;
  margin-bottom: 0.5rem;
}
button {
  padding: 0.5rem 1.5rem;
  font-size: 1rem;
  cursor: pointer;
  margin: 0 0.5rem;
}
.mastery-message {
  background: var(--color-success-bg);
  color: var(--color-success-text);
  font-weight: bold;
  font-size: 0.95rem;
  padding: 0.5rem 1rem;
  margin-bottom: 0.5rem;
  border-radius: 6px;
  text-align: center;
}
/* --- Quiz header (shown during quiz) --- */
.quiz-header {
  display: none;
  align-items: center;
  padding: 0.4rem 0;
  border-bottom: 1px solid var(--color-surface-alt);
  margin-bottom: 0.5rem;
}
.quiz-header-title {
  flex: 1;
  font-size: 1rem;
  font-weight: 500;
  color: var(--color-text-muted);
}
.quiz-header-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--color-text-light);
  cursor: pointer;
  padding: 0 0.25rem;
  line-height: 1;
  margin: 0;
}
.quiz-header-close:hover {
  color: var(--color-text);
}

/* --- Session stats (question count + elapsed time) --- */
.session-stats {
  display: none;
  justify-content: center;
  gap: 1.5rem;
  font-size: 0.85rem;
  color: var(--color-text-light);
  margin-bottom: 0.5rem;
}
.session-stats span {
  font-variant-numeric: tabular-nums;
}

/* --- Progress bar --- */
.progress-bar {
  display: none;
  width: 100%;
  max-width: 300px;
  height: 20px;
  background: var(--color-surface-alt);
  border-radius: 10px;
  margin: 0 auto 0.75rem;
  overflow: hidden;
  position: relative;
}
.progress-fill {
  height: 100%;
  background: var(--color-success);
  border-radius: 10px;
  transition: width 0.3s ease;
  min-width: 0;
}
.progress-text {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--color-text);
  pointer-events: none;
}

.quiz-area {
  display: none;
  text-align: center;
  margin: 1rem 0;
}
.quiz-area.active {
  display: block;
}
.countdown-container {
  width: 200px;
  height: 8px;
  background: var(--color-surface-alt);
  margin: 1rem auto;
  border-radius: 4px;
  overflow: hidden;
}
.countdown-bar {
  height: 100%;
  background: var(--color-success);
  transition: width 0.1s linear;
}
.countdown-bar.expired {
  background: var(--color-error);
}

/* --- Note buttons --- */
.note-buttons {
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start;
  gap: 0.25rem;
  margin: 0.5rem auto 0.5rem 0;
  max-width: 220px;
}
.note-btn {
  min-width: 50px;
  height: 48px;
  font-size: 1.15rem;
  font-weight: 500;
  border: 2px solid var(--color-text-muted);
  border-radius: 8px;
  background: var(--color-bg);
  cursor: pointer;
  padding: 0 0.5rem;
  touch-action: manipulation;
}
.note-btn.accidental {
  background: #e8e8e8;
}
.note-btn:active {
  background: var(--color-surface-pressed);
}
.note-btn:disabled {
  opacity: 0.5;
  cursor: default;
}
.note-btn.hidden {
  display: none;
}

/* --- Quiz prompt (text modes) --- */
.quiz-prompt {
  font-size: 2rem;
  font-weight: 600;
  margin: 1rem 0;
  min-height: 2.5rem;
}

/* --- Answer buttons grid (shared by new modes) --- */
.answer-buttons {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0.4rem;
  max-width: 360px;
  margin: 0.5rem auto;
}
.answer-btn {
  height: 48px;
  font-size: 1.1rem;
  font-weight: 500;
  border: 2px solid var(--color-text-muted);
  border-radius: 8px;
  background: var(--color-bg);
  cursor: pointer;
  padding: 0 0.25rem;
  touch-action: manipulation;
}
.answer-btn:active {
  background: var(--color-surface-pressed);
}
.answer-btn:disabled {
  opacity: 0.5;
  cursor: default;
}
.answer-buttons-intervals {
  grid-template-columns: repeat(3, 1fr);
}

/* --- Calibration overlay: hide all mode chrome, show only quiz-area --- */
.mode-screen.calibrating > *:not(.quiz-area) {
  display: none !important;
}
.mode-screen.calibrating .answer-buttons:not(.calibration-active),
.mode-screen.calibrating .note-buttons:not(.calibration-active) {
  display: none !important;
}
.mode-screen.calibrating .answer-buttons.calibration-active {
  display: grid !important;
}
.mode-screen.calibrating .note-buttons.calibration-active {
  display: flex !important;
}
.mode-screen.calibrating .speed-tap-prompt,
.mode-screen.calibrating .speed-tap-status {
  display: none !important;
}
.mode-screen.calibrating .countdown-container,
.mode-screen.calibrating .quiz-prompt,
.mode-screen.calibrating .chord-slots {
  display: none !important;
}
.calibration-close-btn {
  position: absolute;
  top: 0;
  right: 0;
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--color-text-light);
  cursor: pointer;
  padding: 0.25rem 0.5rem;
  line-height: 1;
  margin: 0;
}
.calibration-close-btn:hover {
  color: var(--color-text);
}

/* --- Calibration highlight --- */
.calibration-target {
  background: var(--color-success) !important;
  border-color: var(--color-success-dark) !important;
  color: white !important;
  box-shadow: 0 0 12px rgba(76, 175, 80, 0.6);
}
.calibration-progress {
  font-size: 0.9rem;
  color: var(--color-text-muted);
  margin-top: 0.5rem;
}
.calibration-action-btn {
  display: block;
  margin: 1.5rem auto 0;
  padding: 0.75rem 2.5rem;
  font-size: 1.1rem;
  font-weight: 600;
  background: var(--color-success);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
.calibration-action-btn:active {
  background: var(--color-success-dark);
}
.calibration-results {
  text-align: center;
  margin: 1rem auto;
  max-width: 420px;
}
.calibration-baseline {
  font-size: 1.1rem;
  font-weight: 600;
  margin: 0.5rem 0 1rem;
}
.calibration-thresholds {
  border-collapse: collapse;
  margin: 0 auto 1rem;
  font-size: 0.85rem;
  width: 100%;
}
.calibration-thresholds th,
.calibration-thresholds td {
  border: 1px solid var(--color-border-light);
  padding: 0.35rem 0.5rem;
  text-align: left;
}
.calibration-thresholds th {
  background: var(--color-surface);
  font-weight: 600;
}
.calibration-thresholds td:first-child {
  font-weight: 600;
  white-space: nowrap;
}
.calibration-thresholds td:nth-child(2) {
  white-space: nowrap;
  font-variant-numeric: tabular-nums;
}

/* --- Feedback --- */
.feedback {
  font-size: 1.5rem;
  margin: 1rem 0;
  min-height: 2rem;
}
.correct {
  color: var(--color-success);
}
.incorrect {
  color: var(--color-error);
}
.time-display {
  color: var(--color-text-muted);
  font-size: 0.9rem;
  margin-top: 0.5rem;
}
.hint {
  color: var(--color-text-muted);
  font-size: 1rem;
  margin-top: 1rem;
}
.stats {
  margin-top: 1rem;
  font-size: 0.9rem;
  color: var(--color-text-muted);
}

/* --- Heatmap legends --- */
.heatmap-legend {
  display: none;
  justify-content: center;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin: 0.75rem 0;
}
.heatmap-legend.active {
  display: flex;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 0.2rem;
  font-size: 0.75rem;
  color: var(--color-text-muted);
}
.legend-swatch {
  width: 12px;
  height: 12px;
  border-radius: 3px;
  border: 1px solid var(--color-border);
}
.setting-group {
  display: flex;
  align-items: center;
  gap: 0.3rem;
  font-size: 0.9rem;
  color: var(--color-text-muted);
  cursor: pointer;
}

/* --- Stats tables (lookup modes) --- */
.stats-container {
  text-align: center;
  margin: 0.5rem 0;
}
.stats-table {
  border-collapse: collapse;
  margin: 0.5rem auto;
  font-size: 0.9rem;
}
.stats-table th, .stats-table td {
  border: 1px solid var(--color-border-light);
  padding: 0.3rem 0.6rem;
  text-align: center;
}
.stats-table th {
  background: var(--color-surface);
  font-weight: 600;
}
.stats-cell {
  width: 36px;
  height: 24px;
  border-radius: 2px;
  padding: 0;
  box-sizing: border-box;
}

/* --- Stats grids (math modes) --- */
.stats-grid-wrapper {
  overflow-x: auto;
  margin: 0.5rem 0;
}
.stats-grid {
  border-collapse: collapse;
  margin: 0 auto;
  font-size: 0.8rem;
}
.stats-grid th, .stats-grid td {
  border: 1px solid var(--color-border-light);
  padding: 0.15rem 0.25rem;
  text-align: center;
}
.stats-grid th {
  background: var(--color-surface);
  font-weight: 600;
  font-size: 0.75rem;
}
.stats-grid .stats-cell {
  width: 26px;
  height: 22px;
}
.stats-grid-row-label {
  font-weight: 600;
  background: var(--color-surface);
  padding: 0.15rem 0.4rem;
}

/* --- Speed Tap mode --- */
.speed-tap-prompt {
  font-size: 2rem;
  font-weight: 600;
  margin: 1rem 0 0.5rem;
}
.speed-tap-status {
  display: flex;
  justify-content: center;
  gap: 1.5rem;
  font-size: 1.3rem;
  margin: 0.5rem 0;
}
.speed-tap-progress {
  font-weight: 500;
}
.speed-tap-timer {
  color: var(--color-text-muted);
  font-variant-numeric: tabular-nums;
}
.speed-tap-stats {
  font-size: 0.75rem;
}
.speed-tap-stats th, .speed-tap-stats td {
  padding: 0.2rem 0.3rem;
}
.speed-tap-stats .stats-cell {
  width: 24px;
  height: 20px;
}

/* --- Stats controls (divider between stats and quiz sections) --- */
.stats-controls {
  text-align: center;
  margin: 0.5rem 0;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--color-border-lighter);
}

/* --- Stats mode toggle (Recall / Speed) --- */
.stats-toggle {
  display: inline-flex;
  border: 2px solid var(--color-border);
  border-radius: 6px;
  overflow: hidden;
}
.stats-toggle-btn {
  padding: 0.35rem 1rem;
  font-size: 0.9rem;
  font-weight: 500;
  border: none;
  border-radius: 0;
  background: var(--color-bg);
  color: var(--color-text-muted);
  cursor: pointer;
  margin: 0;
  transition: background 0.15s, color 0.15s;
}
.stats-toggle-btn + .stats-toggle-btn {
  border-left: 1px solid var(--color-border-light);
}
.stats-toggle-btn.active {
  background: var(--color-success);
  color: var(--color-bg);
}
.stats-toggle-btn:not(.active):hover {
  background: var(--color-surface-hover);
}

/* --- Key signature answer buttons --- */
.answer-buttons-keysig {
  grid-template-columns: repeat(4, 1fr);
}

/* --- Degree answer buttons --- */
.answer-buttons-degrees {
  grid-template-columns: repeat(4, 1fr);
}

/* --- Roman numeral answer buttons --- */
.answer-buttons-numerals {
  grid-template-columns: repeat(4, 1fr);
}

/* --- Chord spelling slots --- */
.chord-slots {
  display: flex;
  justify-content: center;
  gap: 0.5rem;
  margin: 0.75rem 0;
  min-height: 2.5rem;
}
.chord-slot {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 3rem;
  height: 2.5rem;
  border: 2px solid var(--color-border);
  border-radius: 6px;
  font-size: 1.2rem;
  font-weight: 600;
  background: var(--color-surface);
}
.chord-slot.active {
  border-color: var(--color-focus);
  background: var(--color-focus-bg);
}
.chord-slot.correct {
  border-color: var(--color-success);
  background: var(--color-success-bg);
  color: var(--color-success-text);
}
.chord-slot.wrong {
  border-color: var(--color-error);
  background: var(--color-error-bg);
  color: var(--color-error-text);
}

/* Mobile layout */
@media (max-width: 599px) {
  body {
    margin: 0;
    padding: 0 2px;
  }

  .top-bar {
    padding: 0.25rem 0;
  }

  .fretboard-container {
    width: 100%;
    max-width: none;
  }

  .answer-buttons {
    grid-template-columns: repeat(3, 1fr);
    max-width: 280px;
  }

  .quiz-prompt {
    font-size: 1.6rem;
  }

  /* Prevent iOS zoom on input focus */
  input, button { font-size: 16px; }
}

  </style>
</head>
<body>
  <!-- Navigation -->
  <div class="nav-overlay"></div>
  <div class="nav-drawer" id="nav-drawer">
    <button data-mode="fretboard">Fretboard</button>
    <button data-mode="speedTap">Speed Tap</button>
    <button data-mode="noteSemitones">Note ↔ Semitones</button>
    <button data-mode="intervalSemitones">Interval ↔ Semitones</button>
    <button data-mode="semitoneMath">Semitone Math</button>
    <button data-mode="intervalMath">Interval Math</button>
    <button data-mode="keySignatures">Key Signatures</button>
    <button data-mode="scaleDegrees">Scale Degrees</button>
    <button data-mode="diatonicChords">Diatonic Chords</button>
    <button data-mode="chordSpelling">Chord Spelling</button>
  </div>

  <div class="top-bar">
    <button class="hamburger" type="button" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="nav-drawer">☰</button>
    <h1 id="mode-title">Fretboard</h1>
    <div class="version">v3.7</div>
  </div>

  <!-- Fretboard mode -->
  <div class="mode-screen" id="mode-fretboard">
    <div class="stats-container"></div>
    <div class="stats-controls">
      <div class="stats-toggle"><button class="stats-toggle-btn active" data-mode="retention">Recall</button><button class="stats-toggle-btn" data-mode="speed">Speed</button></div>
      <span class="stats"></span>
    </div>
    <div class="quiz-controls">
      <div class="settings-row">
        <div class="string-toggles" id="string-toggles">
          <button class="string-toggle" data-string="0">e</button>
          <button class="string-toggle" data-string="1">B</button>
          <button class="string-toggle" data-string="2">G</button>
          <button class="string-toggle" data-string="3">D</button>
          <button class="string-toggle" data-string="4">A</button>
          <button class="string-toggle active" data-string="5">E</button>
        </div>
        <label class="setting-group">
          <input type="checkbox" id="naturals-only" checked>
          Natural only
        </label>
      </div>
      <div class="mastery-message" style="display: none;">Looks like you've got this!</div>
      <div>
        <button class="start-btn">Start Quiz</button>
        <button class="stop-btn" style="display: none;">Stop Quiz</button>
        <button class="recalibrate-btn" style="display: none;">Redo speed check</button>
      </div>
    </div>
    <div class="quiz-header" style="display: none;">
      <span class="quiz-header-title">Practicing</span>
      <button class="quiz-header-close" aria-label="Stop quiz">×</button>
    </div>
    <div class="session-stats" style="display: none;">
      <span><span class="question-count">0</span> questions</span>
      <span class="elapsed-time">0s</span>
    </div>
    <div class="progress-bar" style="display: none;">
      <div class="progress-fill" style="width: 0%"></div>
      <div class="progress-text">0 / 0</div>
    </div>
    <div class="fretboard-wrapper">
      <div class="fretboard-container">
        <svg class="fretboard" id="fretboard" viewBox="0 0 600 240">
          <!-- Nut (thick line at fret 0) -->
          <line x1="65" y1="0" x2="65" y2="240" stroke="#333" stroke-width="4"/>
          <!-- Frets (vertical lines) -->
          <line x1="65" y1="0" x2="65" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="126" y1="0" x2="126" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="183" y1="0" x2="183" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="237" y1="0" x2="237" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="288" y1="0" x2="288" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="336" y1="0" x2="336" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="381" y1="0" x2="381" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="423" y1="0" x2="423" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="463" y1="0" x2="463" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="500" y1="0" x2="500" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="535" y1="0" x2="535" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="568" y1="0" x2="568" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="600" y1="0" x2="600" y2="240" stroke="#333" stroke-width="1"/>
          <!-- Strings (horizontal lines) -->
          <line x1="0" y1="20" x2="600" y2="20" stroke="#333" stroke-width="1"/>
      <line x1="0" y1="60" x2="600" y2="60" stroke="#333" stroke-width="1.5"/>
      <line x1="0" y1="100" x2="600" y2="100" stroke="#333" stroke-width="2"/>
      <line x1="0" y1="140" x2="600" y2="140" stroke="#333" stroke-width="2.5"/>
      <line x1="0" y1="180" x2="600" y2="180" stroke="#333" stroke-width="3"/>
      <line x1="0" y1="220" x2="600" y2="220" stroke="#333" stroke-width="3.5"/>
          <!-- Note circles -->
          <circle
      class="note-circle"
      data-string="0"
      data-fret="0"
      cx="32.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="0"
      x="32.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="1"
      cx="95.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="1"
      x="95.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="2"
      cx="154.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="2"
      x="154.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="3"
      cx="210"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="3"
      x="210"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="4"
      cx="262.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="4"
      x="262.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="5"
      cx="312"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="5"
      x="312"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="6"
      cx="358.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="6"
      x="358.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="7"
      cx="402"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="7"
      x="402"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="8"
      cx="443"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="8"
      x="443"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="9"
      cx="481.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="9"
      x="481.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="10"
      cx="517.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="10"
      x="517.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="11"
      cx="551.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="11"
      x="551.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="12"
      cx="584"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="12"
      x="584"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="0"
      cx="32.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="0"
      x="32.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="1"
      cx="95.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="1"
      x="95.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="2"
      cx="154.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="2"
      x="154.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="3"
      cx="210"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="3"
      x="210"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="4"
      cx="262.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="4"
      x="262.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="5"
      cx="312"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="5"
      x="312"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="6"
      cx="358.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="6"
      x="358.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="7"
      cx="402"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="7"
      x="402"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="8"
      cx="443"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="8"
      x="443"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="9"
      cx="481.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="9"
      x="481.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="10"
      cx="517.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="10"
      x="517.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="11"
      cx="551.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="11"
      x="551.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="12"
      cx="584"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="12"
      x="584"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="0"
      cx="32.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="0"
      x="32.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="1"
      cx="95.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="1"
      x="95.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="2"
      cx="154.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="2"
      x="154.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="3"
      cx="210"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="3"
      x="210"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="4"
      cx="262.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="4"
      x="262.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="5"
      cx="312"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="5"
      x="312"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="6"
      cx="358.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="6"
      x="358.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="7"
      cx="402"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="7"
      x="402"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="8"
      cx="443"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="8"
      x="443"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="9"
      cx="481.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="9"
      x="481.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="10"
      cx="517.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="10"
      x="517.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="11"
      cx="551.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="11"
      x="551.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="12"
      cx="584"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="12"
      x="584"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="0"
      cx="32.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="0"
      x="32.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="1"
      cx="95.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="1"
      x="95.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="2"
      cx="154.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="2"
      x="154.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="3"
      cx="210"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="3"
      x="210"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="4"
      cx="262.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="4"
      x="262.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="5"
      cx="312"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="5"
      x="312"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="6"
      cx="358.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="6"
      x="358.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="7"
      cx="402"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="7"
      x="402"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="8"
      cx="443"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="8"
      x="443"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="9"
      cx="481.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="9"
      x="481.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="10"
      cx="517.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="10"
      x="517.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="11"
      cx="551.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="11"
      x="551.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="12"
      cx="584"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="12"
      x="584"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="0"
      cx="32.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="0"
      x="32.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="1"
      cx="95.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="1"
      x="95.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="2"
      cx="154.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="2"
      x="154.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="3"
      cx="210"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="3"
      x="210"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="4"
      cx="262.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="4"
      x="262.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="5"
      cx="312"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="5"
      x="312"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="6"
      cx="358.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="6"
      x="358.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="7"
      cx="402"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="7"
      x="402"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="8"
      cx="443"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="8"
      x="443"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="9"
      cx="481.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="9"
      x="481.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="10"
      cx="517.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="10"
      x="517.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="11"
      cx="551.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="11"
      x="551.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="12"
      cx="584"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="12"
      x="584"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="0"
      cx="32.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="0"
      x="32.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="1"
      cx="95.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="1"
      x="95.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="2"
      cx="154.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="2"
      x="154.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="3"
      cx="210"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="3"
      x="210"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="4"
      cx="262.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="4"
      x="262.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="5"
      cx="312"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="5"
      x="312"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="6"
      cx="358.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="6"
      x="358.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="7"
      cx="402"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="7"
      x="402"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="8"
      cx="443"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="8"
      x="443"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="9"
      cx="481.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="9"
      x="481.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="10"
      cx="517.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="10"
      x="517.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="11"
      cx="551.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="11"
      x="551.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="12"
      cx="584"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="12"
      x="584"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
        </svg>
        <div class="fret-numbers">
          <div class="fret-number" style="left: 35%">3</div>
    <div class="fret-number" style="left: 52%">5</div>
    <div class="fret-number" style="left: 67%">7</div>
    <div class="fret-number" style="left: 80.25%">9</div>
    <div class="fret-number" style="left: 97.33333333333334%">12</div>
        </div>
      </div>
    </div>
    <div class="quiz-area">
      <div class="countdown-container">
        <div class="countdown-bar"></div>
      </div>
      <div class="note-buttons">
        <button class="note-btn" data-note="C">C</button>
        <button class="note-btn accidental" data-note="C#">C#</button>
        <button class="note-btn" data-note="D">D</button>
        <button class="note-btn accidental" data-note="D#">D#</button>
        <button class="note-btn" data-note="E">E</button>
        <button class="note-btn" data-note="F">F</button>
        <button class="note-btn accidental" data-note="F#">F#</button>
        <button class="note-btn" data-note="G">G</button>
        <button class="note-btn accidental" data-note="G#">G#</button>
        <button class="note-btn" data-note="A">A</button>
        <button class="note-btn accidental" data-note="A#">A#</button>
        <button class="note-btn" data-note="B">B</button>
      </div>
      <div class="feedback"></div>
      <div class="time-display"></div>
      <div class="hint"></div>
    </div>
  </div>

  <!-- Speed Tap mode -->
  <div class="mode-screen" id="mode-speedTap">
    <div class="stats-container"></div>
    <div class="stats-controls">
      <div class="stats-toggle"><button class="stats-toggle-btn active" data-mode="retention">Recall</button><button class="stats-toggle-btn" data-mode="speed">Speed</button></div>
      <span class="stats"></span>
    </div>
    <div class="quiz-controls">
      <div class="settings-row">
        <label class="setting-group">
          <input type="checkbox" id="speed-tap-naturals-only" checked>
          Natural only
        </label>
      </div>
      <div class="mastery-message" style="display: none;">Looks like you've got this!</div>
      <div>
        <button class="start-btn">Start Quiz</button>
        <button class="stop-btn" style="display: none;">Stop Quiz</button>
        <button class="recalibrate-btn" style="display: none;">Redo speed check</button>
      </div>
    </div>
    <div class="quiz-header" style="display: none;">
      <span class="quiz-header-title">Practicing</span>
      <button class="quiz-header-close" aria-label="Stop quiz">×</button>
    </div>
    <div class="session-stats" style="display: none;">
      <span><span class="question-count">0</span> rounds</span>
      <span class="elapsed-time">0s</span>
    </div>
    <div class="progress-bar" style="display: none;">
      <div class="progress-fill" style="width: 0%"></div>
      <div class="progress-text">0 / 0</div>
    </div>
    <div class="quiz-area">
      <div class="speed-tap-prompt"></div>
      <div class="speed-tap-status">
        <span class="speed-tap-progress"></span>
        <span class="speed-tap-timer"></span>
      </div>
      <div class="fretboard-wrapper">
      <div class="fretboard-container">
        <svg class="fretboard" viewBox="0 0 600 240">
          <!-- Nut (thick line at fret 0) -->
          <line x1="65" y1="0" x2="65" y2="240" stroke="#333" stroke-width="4"/>
          <!-- Frets (vertical lines) -->
          <line x1="65" y1="0" x2="65" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="126" y1="0" x2="126" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="183" y1="0" x2="183" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="237" y1="0" x2="237" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="288" y1="0" x2="288" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="336" y1="0" x2="336" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="381" y1="0" x2="381" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="423" y1="0" x2="423" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="463" y1="0" x2="463" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="500" y1="0" x2="500" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="535" y1="0" x2="535" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="568" y1="0" x2="568" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="600" y1="0" x2="600" y2="240" stroke="#333" stroke-width="1"/>
          <!-- Strings (horizontal lines) -->
          <line x1="0" y1="20" x2="600" y2="20" stroke="#333" stroke-width="1"/>
      <line x1="0" y1="60" x2="600" y2="60" stroke="#333" stroke-width="1.5"/>
      <line x1="0" y1="100" x2="600" y2="100" stroke="#333" stroke-width="2"/>
      <line x1="0" y1="140" x2="600" y2="140" stroke="#333" stroke-width="2.5"/>
      <line x1="0" y1="180" x2="600" y2="180" stroke="#333" stroke-width="3"/>
      <line x1="0" y1="220" x2="600" y2="220" stroke="#333" stroke-width="3.5"/>
          <!-- Note circles -->
          <circle
      class="note-circle"
      data-string="0"
      data-fret="0"
      cx="32.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="0"
      x="32.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="1"
      cx="95.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="1"
      x="95.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="2"
      cx="154.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="2"
      x="154.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="3"
      cx="210"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="3"
      x="210"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="4"
      cx="262.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="4"
      x="262.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="5"
      cx="312"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="5"
      x="312"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="6"
      cx="358.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="6"
      x="358.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="7"
      cx="402"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="7"
      x="402"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="8"
      cx="443"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="8"
      x="443"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="9"
      cx="481.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="9"
      x="481.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="10"
      cx="517.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="10"
      x="517.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="11"
      cx="551.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="11"
      x="551.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="12"
      cx="584"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="12"
      x="584"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="0"
      cx="32.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="0"
      x="32.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="1"
      cx="95.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="1"
      x="95.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="2"
      cx="154.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="2"
      x="154.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="3"
      cx="210"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="3"
      x="210"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="4"
      cx="262.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="4"
      x="262.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="5"
      cx="312"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="5"
      x="312"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="6"
      cx="358.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="6"
      x="358.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="7"
      cx="402"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="7"
      x="402"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="8"
      cx="443"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="8"
      x="443"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="9"
      cx="481.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="9"
      x="481.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="10"
      cx="517.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="10"
      x="517.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="11"
      cx="551.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="11"
      x="551.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="12"
      cx="584"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="12"
      x="584"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="0"
      cx="32.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="0"
      x="32.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="1"
      cx="95.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="1"
      x="95.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="2"
      cx="154.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="2"
      x="154.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="3"
      cx="210"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="3"
      x="210"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="4"
      cx="262.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="4"
      x="262.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="5"
      cx="312"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="5"
      x="312"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="6"
      cx="358.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="6"
      x="358.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="7"
      cx="402"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="7"
      x="402"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="8"
      cx="443"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="8"
      x="443"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="9"
      cx="481.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="9"
      x="481.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="10"
      cx="517.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="10"
      x="517.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="11"
      cx="551.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="11"
      x="551.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="12"
      cx="584"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="12"
      x="584"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="0"
      cx="32.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="0"
      x="32.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="1"
      cx="95.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="1"
      x="95.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="2"
      cx="154.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="2"
      x="154.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="3"
      cx="210"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="3"
      x="210"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="4"
      cx="262.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="4"
      x="262.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="5"
      cx="312"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="5"
      x="312"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="6"
      cx="358.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="6"
      x="358.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="7"
      cx="402"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="7"
      x="402"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="8"
      cx="443"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="8"
      x="443"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="9"
      cx="481.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="9"
      x="481.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="10"
      cx="517.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="10"
      x="517.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="11"
      cx="551.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="11"
      x="551.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="12"
      cx="584"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="12"
      x="584"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="0"
      cx="32.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="0"
      x="32.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="1"
      cx="95.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="1"
      x="95.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="2"
      cx="154.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="2"
      x="154.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="3"
      cx="210"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="3"
      x="210"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="4"
      cx="262.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="4"
      x="262.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="5"
      cx="312"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="5"
      x="312"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="6"
      cx="358.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="6"
      x="358.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="7"
      cx="402"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="7"
      x="402"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="8"
      cx="443"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="8"
      x="443"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="9"
      cx="481.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="9"
      x="481.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="10"
      cx="517.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="10"
      x="517.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="11"
      cx="551.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="11"
      x="551.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="12"
      cx="584"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="12"
      x="584"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="0"
      cx="32.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="0"
      x="32.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="1"
      cx="95.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="1"
      x="95.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="2"
      cx="154.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="2"
      x="154.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="3"
      cx="210"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="3"
      x="210"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="4"
      cx="262.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="4"
      x="262.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="5"
      cx="312"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="5"
      x="312"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="6"
      cx="358.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="6"
      x="358.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="7"
      cx="402"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="7"
      x="402"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="8"
      cx="443"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="8"
      x="443"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="9"
      cx="481.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="9"
      x="481.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="10"
      cx="517.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="10"
      x="517.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="11"
      cx="551.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="11"
      x="551.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="12"
      cx="584"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="12"
      x="584"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
        </svg>
        <div class="fret-numbers">
          <div class="fret-number" style="left: 35%">3</div>
    <div class="fret-number" style="left: 52%">5</div>
    <div class="fret-number" style="left: 67%">7</div>
    <div class="fret-number" style="left: 80.25%">9</div>
    <div class="fret-number" style="left: 97.33333333333334%">12</div>
        </div>
      </div>
    </div>
      <div class="answer-buttons answer-buttons-notes" style="display: none;">
        <button class="answer-btn answer-btn-note" data-note="C">C</button>
        <button class="answer-btn answer-btn-note" data-note="C#">C#/Db</button>
        <button class="answer-btn answer-btn-note" data-note="D">D</button>
        <button class="answer-btn answer-btn-note" data-note="D#">D#/Eb</button>
        <button class="answer-btn answer-btn-note" data-note="E">E</button>
        <button class="answer-btn answer-btn-note" data-note="F">F</button>
        <button class="answer-btn answer-btn-note" data-note="F#">F#/Gb</button>
        <button class="answer-btn answer-btn-note" data-note="G">G</button>
        <button class="answer-btn answer-btn-note" data-note="G#">G#/Ab</button>
        <button class="answer-btn answer-btn-note" data-note="A">A</button>
        <button class="answer-btn answer-btn-note" data-note="A#">A#/Bb</button>
        <button class="answer-btn answer-btn-note" data-note="B">B</button>
      </div>
      <div class="feedback"></div>
      <div class="time-display"></div>
      <div class="hint"></div>
    </div>
  </div>

  <!-- Note Semitones mode -->
  <div class="mode-screen" id="mode-noteSemitones">
    <div class="stats-container"></div>
    <div class="stats-controls">
      <div class="stats-toggle"><button class="stats-toggle-btn active" data-mode="retention">Recall</button><button class="stats-toggle-btn" data-mode="speed">Speed</button></div>
      <span class="stats"></span>
    </div>
    <div class="quiz-controls">
      <div class="mastery-message" style="display: none;">Looks like you've got this!</div>
      <div>
        <button class="start-btn">Start Quiz</button>
        <button class="stop-btn" style="display: none;">Stop Quiz</button>
        <button class="recalibrate-btn" style="display: none;">Redo speed check</button>
      </div>
    </div>
    <div class="quiz-header" style="display: none;">
      <span class="quiz-header-title">Practicing</span>
      <button class="quiz-header-close" aria-label="Stop quiz">×</button>
    </div>
    <div class="session-stats" style="display: none;">
      <span><span class="question-count">0</span> questions</span>
      <span class="elapsed-time">0s</span>
    </div>
    <div class="progress-bar" style="display: none;">
      <div class="progress-fill" style="width: 0%"></div>
      <div class="progress-text">0 / 0</div>
    </div>
    <div class="quiz-area">
      <div class="countdown-container"><div class="countdown-bar"></div></div>
      <div class="quiz-prompt"></div>
      <div class="answer-buttons answer-buttons-notes">
        <button class="answer-btn answer-btn-note" data-note="C">C</button>
        <button class="answer-btn answer-btn-note" data-note="C#">C#/Db</button>
        <button class="answer-btn answer-btn-note" data-note="D">D</button>
        <button class="answer-btn answer-btn-note" data-note="D#">D#/Eb</button>
        <button class="answer-btn answer-btn-note" data-note="E">E</button>
        <button class="answer-btn answer-btn-note" data-note="F">F</button>
        <button class="answer-btn answer-btn-note" data-note="F#">F#/Gb</button>
        <button class="answer-btn answer-btn-note" data-note="G">G</button>
        <button class="answer-btn answer-btn-note" data-note="G#">G#/Ab</button>
        <button class="answer-btn answer-btn-note" data-note="A">A</button>
        <button class="answer-btn answer-btn-note" data-note="A#">A#/Bb</button>
        <button class="answer-btn answer-btn-note" data-note="B">B</button>
      </div>
      <div class="answer-buttons answer-buttons-numbers">
        <button class="answer-btn answer-btn-num" data-num="0">0</button>
        <button class="answer-btn answer-btn-num" data-num="1">1</button>
        <button class="answer-btn answer-btn-num" data-num="2">2</button>
        <button class="answer-btn answer-btn-num" data-num="3">3</button>
        <button class="answer-btn answer-btn-num" data-num="4">4</button>
        <button class="answer-btn answer-btn-num" data-num="5">5</button>
        <button class="answer-btn answer-btn-num" data-num="6">6</button>
        <button class="answer-btn answer-btn-num" data-num="7">7</button>
        <button class="answer-btn answer-btn-num" data-num="8">8</button>
        <button class="answer-btn answer-btn-num" data-num="9">9</button>
        <button class="answer-btn answer-btn-num" data-num="10">10</button>
        <button class="answer-btn answer-btn-num" data-num="11">11</button>
      </div>
      <div class="feedback"></div>
      <div class="time-display"></div>
      <div class="hint"></div>
    </div>
  </div>

  <!-- Interval Semitones mode -->
  <div class="mode-screen" id="mode-intervalSemitones">
    <div class="stats-container"></div>
    <div class="stats-controls">
      <div class="stats-toggle"><button class="stats-toggle-btn active" data-mode="retention">Recall</button><button class="stats-toggle-btn" data-mode="speed">Speed</button></div>
      <span class="stats"></span>
    </div>
    <div class="quiz-controls">
      <div class="mastery-message" style="display: none;">Looks like you've got this!</div>
      <div>
        <button class="start-btn">Start Quiz</button>
        <button class="stop-btn" style="display: none;">Stop Quiz</button>
        <button class="recalibrate-btn" style="display: none;">Redo speed check</button>
      </div>
    </div>
    <div class="quiz-header" style="display: none;">
      <span class="quiz-header-title">Practicing</span>
      <button class="quiz-header-close" aria-label="Stop quiz">×</button>
    </div>
    <div class="session-stats" style="display: none;">
      <span><span class="question-count">0</span> questions</span>
      <span class="elapsed-time">0s</span>
    </div>
    <div class="progress-bar" style="display: none;">
      <div class="progress-fill" style="width: 0%"></div>
      <div class="progress-text">0 / 0</div>
    </div>
    <div class="quiz-area">
      <div class="countdown-container"><div class="countdown-bar"></div></div>
      <div class="quiz-prompt"></div>
      <div class="answer-buttons answer-buttons-intervals">
        <button class="answer-btn answer-btn-interval" data-interval="m2">m2</button>
        <button class="answer-btn answer-btn-interval" data-interval="M2">M2</button>
        <button class="answer-btn answer-btn-interval" data-interval="m3">m3</button>
        <button class="answer-btn answer-btn-interval" data-interval="M3">M3</button>
        <button class="answer-btn answer-btn-interval" data-interval="P4">P4</button>
        <button class="answer-btn answer-btn-interval" data-interval="TT">TT</button>
        <button class="answer-btn answer-btn-interval" data-interval="P5">P5</button>
        <button class="answer-btn answer-btn-interval" data-interval="m6">m6</button>
        <button class="answer-btn answer-btn-interval" data-interval="M6">M6</button>
        <button class="answer-btn answer-btn-interval" data-interval="m7">m7</button>
        <button class="answer-btn answer-btn-interval" data-interval="M7">M7</button>
        <button class="answer-btn answer-btn-interval" data-interval="P8">P8</button>
      </div>
      <div class="answer-buttons answer-buttons-numbers">
        <button class="answer-btn answer-btn-num" data-num="1">1</button>
        <button class="answer-btn answer-btn-num" data-num="2">2</button>
        <button class="answer-btn answer-btn-num" data-num="3">3</button>
        <button class="answer-btn answer-btn-num" data-num="4">4</button>
        <button class="answer-btn answer-btn-num" data-num="5">5</button>
        <button class="answer-btn answer-btn-num" data-num="6">6</button>
        <button class="answer-btn answer-btn-num" data-num="7">7</button>
        <button class="answer-btn answer-btn-num" data-num="8">8</button>
        <button class="answer-btn answer-btn-num" data-num="9">9</button>
        <button class="answer-btn answer-btn-num" data-num="10">10</button>
        <button class="answer-btn answer-btn-num" data-num="11">11</button>
        <button class="answer-btn answer-btn-num" data-num="12">12</button>
      </div>
      <div class="feedback"></div>
      <div class="time-display"></div>
      <div class="hint"></div>
    </div>
  </div>

  <!-- Semitone Math mode -->
  <div class="mode-screen" id="mode-semitoneMath">
    <div class="stats-container"></div>
    <div class="stats-controls">
      <div class="stats-toggle"><button class="stats-toggle-btn active" data-mode="retention">Recall</button><button class="stats-toggle-btn" data-mode="speed">Speed</button></div>
      <span class="stats"></span>
    </div>
    <div class="quiz-controls">
      <div class="settings-row">
        <div class="distance-toggles"></div>
      </div>
      <div class="mastery-message" style="display: none;">Looks like you've got this!</div>
      <div>
        <button class="start-btn">Start Quiz</button>
        <button class="stop-btn" style="display: none;">Stop Quiz</button>
        <button class="recalibrate-btn" style="display: none;">Redo speed check</button>
      </div>
    </div>
    <div class="quiz-header" style="display: none;">
      <span class="quiz-header-title">Practicing</span>
      <button class="quiz-header-close" aria-label="Stop quiz">×</button>
    </div>
    <div class="session-stats" style="display: none;">
      <span><span class="question-count">0</span> questions</span>
      <span class="elapsed-time">0s</span>
    </div>
    <div class="progress-bar" style="display: none;">
      <div class="progress-fill" style="width: 0%"></div>
      <div class="progress-text">0 / 0</div>
    </div>
    <div class="quiz-area">
      <div class="countdown-container"><div class="countdown-bar"></div></div>
      <div class="quiz-prompt"></div>
      <div class="answer-buttons answer-buttons-notes">
        <button class="answer-btn answer-btn-note" data-note="C">C</button>
        <button class="answer-btn answer-btn-note" data-note="C#">C#/Db</button>
        <button class="answer-btn answer-btn-note" data-note="D">D</button>
        <button class="answer-btn answer-btn-note" data-note="D#">D#/Eb</button>
        <button class="answer-btn answer-btn-note" data-note="E">E</button>
        <button class="answer-btn answer-btn-note" data-note="F">F</button>
        <button class="answer-btn answer-btn-note" data-note="F#">F#/Gb</button>
        <button class="answer-btn answer-btn-note" data-note="G">G</button>
        <button class="answer-btn answer-btn-note" data-note="G#">G#/Ab</button>
        <button class="answer-btn answer-btn-note" data-note="A">A</button>
        <button class="answer-btn answer-btn-note" data-note="A#">A#/Bb</button>
        <button class="answer-btn answer-btn-note" data-note="B">B</button>
      </div>
      <div class="feedback"></div>
      <div class="time-display"></div>
      <div class="hint"></div>
    </div>
  </div>

  <!-- Interval Math mode -->
  <div class="mode-screen" id="mode-intervalMath">
    <div class="stats-container"></div>
    <div class="stats-controls">
      <div class="stats-toggle"><button class="stats-toggle-btn active" data-mode="retention">Recall</button><button class="stats-toggle-btn" data-mode="speed">Speed</button></div>
      <span class="stats"></span>
    </div>
    <div class="quiz-controls">
      <div class="settings-row">
        <div class="distance-toggles"></div>
      </div>
      <div class="mastery-message" style="display: none;">Looks like you've got this!</div>
      <div>
        <button class="start-btn">Start Quiz</button>
        <button class="stop-btn" style="display: none;">Stop Quiz</button>
        <button class="recalibrate-btn" style="display: none;">Redo speed check</button>
      </div>
    </div>
    <div class="quiz-header" style="display: none;">
      <span class="quiz-header-title">Practicing</span>
      <button class="quiz-header-close" aria-label="Stop quiz">×</button>
    </div>
    <div class="session-stats" style="display: none;">
      <span><span class="question-count">0</span> questions</span>
      <span class="elapsed-time">0s</span>
    </div>
    <div class="progress-bar" style="display: none;">
      <div class="progress-fill" style="width: 0%"></div>
      <div class="progress-text">0 / 0</div>
    </div>
    <div class="quiz-area">
      <div class="countdown-container"><div class="countdown-bar"></div></div>
      <div class="quiz-prompt"></div>
      <div class="answer-buttons answer-buttons-notes">
        <button class="answer-btn answer-btn-note" data-note="C">C</button>
        <button class="answer-btn answer-btn-note" data-note="C#">C#/Db</button>
        <button class="answer-btn answer-btn-note" data-note="D">D</button>
        <button class="answer-btn answer-btn-note" data-note="D#">D#/Eb</button>
        <button class="answer-btn answer-btn-note" data-note="E">E</button>
        <button class="answer-btn answer-btn-note" data-note="F">F</button>
        <button class="answer-btn answer-btn-note" data-note="F#">F#/Gb</button>
        <button class="answer-btn answer-btn-note" data-note="G">G</button>
        <button class="answer-btn answer-btn-note" data-note="G#">G#/Ab</button>
        <button class="answer-btn answer-btn-note" data-note="A">A</button>
        <button class="answer-btn answer-btn-note" data-note="A#">A#/Bb</button>
        <button class="answer-btn answer-btn-note" data-note="B">B</button>
      </div>
      <div class="feedback"></div>
      <div class="time-display"></div>
      <div class="hint"></div>
    </div>
  </div>

  <!-- Key Signatures mode -->
  <div class="mode-screen" id="mode-keySignatures">
    <div class="stats-container"></div>
    <div class="stats-controls">
      <div class="stats-toggle"><button class="stats-toggle-btn active" data-mode="retention">Recall</button><button class="stats-toggle-btn" data-mode="speed">Speed</button></div>
      <span class="stats"></span>
    </div>
    <div class="quiz-controls">
      <div class="settings-row">
        <div class="distance-toggles"></div>
      </div>
      <div class="mastery-message" style="display: none;">Looks like you've got this!</div>
      <div>
        <button class="start-btn">Start Quiz</button>
        <button class="stop-btn" style="display: none;">Stop Quiz</button>
        <button class="recalibrate-btn" style="display: none;">Redo speed check</button>
      </div>
    </div>
    <div class="quiz-header" style="display: none;">
      <span class="quiz-header-title">Practicing</span>
      <button class="quiz-header-close" aria-label="Stop quiz">×</button>
    </div>
    <div class="session-stats" style="display: none;">
      <span><span class="question-count">0</span> questions</span>
      <span class="elapsed-time">0s</span>
    </div>
    <div class="progress-bar" style="display: none;">
      <div class="progress-fill" style="width: 0%"></div>
      <div class="progress-text">0 / 0</div>
    </div>
    <div class="quiz-area">
      <div class="countdown-container"><div class="countdown-bar"></div></div>
      <div class="quiz-prompt"></div>
      <div class="answer-buttons answer-buttons-keysig">
        <button class="answer-btn answer-btn-keysig" data-sig="0">0</button>
        <button class="answer-btn answer-btn-keysig" data-sig="1#">1#</button>
        <button class="answer-btn answer-btn-keysig" data-sig="2#">2#</button>
        <button class="answer-btn answer-btn-keysig" data-sig="3#">3#</button>
        <button class="answer-btn answer-btn-keysig" data-sig="4#">4#</button>
        <button class="answer-btn answer-btn-keysig" data-sig="5#">5#</button>
        <button class="answer-btn answer-btn-keysig" data-sig="6#">6#</button>
        <button class="answer-btn answer-btn-keysig" data-sig="7#">7#</button>
        <button class="answer-btn answer-btn-keysig" data-sig="1b">1b</button>
        <button class="answer-btn answer-btn-keysig" data-sig="2b">2b</button>
        <button class="answer-btn answer-btn-keysig" data-sig="3b">3b</button>
        <button class="answer-btn answer-btn-keysig" data-sig="4b">4b</button>
        <button class="answer-btn answer-btn-keysig" data-sig="5b">5b</button>
        <button class="answer-btn answer-btn-keysig" data-sig="6b">6b</button>
        <button class="answer-btn answer-btn-keysig" data-sig="7b">7b</button>
      </div>
      <div class="answer-buttons answer-buttons-notes" style="display: none;">
        <button class="answer-btn answer-btn-note" data-note="C">C</button>
        <button class="answer-btn answer-btn-note" data-note="C#">C#/Db</button>
        <button class="answer-btn answer-btn-note" data-note="D">D</button>
        <button class="answer-btn answer-btn-note" data-note="D#">D#/Eb</button>
        <button class="answer-btn answer-btn-note" data-note="E">E</button>
        <button class="answer-btn answer-btn-note" data-note="F">F</button>
        <button class="answer-btn answer-btn-note" data-note="F#">F#/Gb</button>
        <button class="answer-btn answer-btn-note" data-note="G">G</button>
        <button class="answer-btn answer-btn-note" data-note="G#">G#/Ab</button>
        <button class="answer-btn answer-btn-note" data-note="A">A</button>
        <button class="answer-btn answer-btn-note" data-note="A#">A#/Bb</button>
        <button class="answer-btn answer-btn-note" data-note="B">B</button>
      </div>
      <div class="feedback"></div>
      <div class="time-display"></div>
      <div class="hint"></div>
    </div>
  </div>

  <!-- Scale Degrees mode -->
  <div class="mode-screen" id="mode-scaleDegrees">
    <div class="stats-container"></div>
    <div class="stats-controls">
      <div class="stats-toggle"><button class="stats-toggle-btn active" data-mode="retention">Recall</button><button class="stats-toggle-btn" data-mode="speed">Speed</button></div>
      <span class="stats"></span>
    </div>
    <div class="quiz-controls">
      <div class="settings-row">
        <div class="distance-toggles"></div>
      </div>
      <div class="mastery-message" style="display: none;">Looks like you've got this!</div>
      <div>
        <button class="start-btn">Start Quiz</button>
        <button class="stop-btn" style="display: none;">Stop Quiz</button>
        <button class="recalibrate-btn" style="display: none;">Redo speed check</button>
      </div>
    </div>
    <div class="quiz-header" style="display: none;">
      <span class="quiz-header-title">Practicing</span>
      <button class="quiz-header-close" aria-label="Stop quiz">×</button>
    </div>
    <div class="session-stats" style="display: none;">
      <span><span class="question-count">0</span> questions</span>
      <span class="elapsed-time">0s</span>
    </div>
    <div class="progress-bar" style="display: none;">
      <div class="progress-fill" style="width: 0%"></div>
      <div class="progress-text">0 / 0</div>
    </div>
    <div class="quiz-area">
      <div class="countdown-container"><div class="countdown-bar"></div></div>
      <div class="quiz-prompt"></div>
      <div class="answer-buttons answer-buttons-notes">
        <button class="answer-btn answer-btn-note" data-note="C">C</button>
        <button class="answer-btn answer-btn-note" data-note="C#">C#/Db</button>
        <button class="answer-btn answer-btn-note" data-note="D">D</button>
        <button class="answer-btn answer-btn-note" data-note="D#">D#/Eb</button>
        <button class="answer-btn answer-btn-note" data-note="E">E</button>
        <button class="answer-btn answer-btn-note" data-note="F">F</button>
        <button class="answer-btn answer-btn-note" data-note="F#">F#/Gb</button>
        <button class="answer-btn answer-btn-note" data-note="G">G</button>
        <button class="answer-btn answer-btn-note" data-note="G#">G#/Ab</button>
        <button class="answer-btn answer-btn-note" data-note="A">A</button>
        <button class="answer-btn answer-btn-note" data-note="A#">A#/Bb</button>
        <button class="answer-btn answer-btn-note" data-note="B">B</button>
      </div>
      <div class="answer-buttons answer-buttons-degrees" style="display: none;">
        <button class="answer-btn answer-btn-degree" data-degree="1">1st</button>
        <button class="answer-btn answer-btn-degree" data-degree="2">2nd</button>
        <button class="answer-btn answer-btn-degree" data-degree="3">3rd</button>
        <button class="answer-btn answer-btn-degree" data-degree="4">4th</button>
        <button class="answer-btn answer-btn-degree" data-degree="5">5th</button>
        <button class="answer-btn answer-btn-degree" data-degree="6">6th</button>
        <button class="answer-btn answer-btn-degree" data-degree="7">7th</button>
      </div>
      <div class="feedback"></div>
      <div class="time-display"></div>
      <div class="hint"></div>
    </div>
  </div>

  <!-- Diatonic Chords mode -->
  <div class="mode-screen" id="mode-diatonicChords">
    <div class="stats-container"></div>
    <div class="stats-controls">
      <div class="stats-toggle"><button class="stats-toggle-btn active" data-mode="retention">Recall</button><button class="stats-toggle-btn" data-mode="speed">Speed</button></div>
      <span class="stats"></span>
    </div>
    <div class="quiz-controls">
      <div class="settings-row">
        <div class="distance-toggles"></div>
      </div>
      <div class="mastery-message" style="display: none;">Looks like you've got this!</div>
      <div>
        <button class="start-btn">Start Quiz</button>
        <button class="stop-btn" style="display: none;">Stop Quiz</button>
        <button class="recalibrate-btn" style="display: none;">Redo speed check</button>
      </div>
    </div>
    <div class="quiz-header" style="display: none;">
      <span class="quiz-header-title">Practicing</span>
      <button class="quiz-header-close" aria-label="Stop quiz">×</button>
    </div>
    <div class="session-stats" style="display: none;">
      <span><span class="question-count">0</span> questions</span>
      <span class="elapsed-time">0s</span>
    </div>
    <div class="progress-bar" style="display: none;">
      <div class="progress-fill" style="width: 0%"></div>
      <div class="progress-text">0 / 0</div>
    </div>
    <div class="quiz-area">
      <div class="countdown-container"><div class="countdown-bar"></div></div>
      <div class="quiz-prompt"></div>
      <div class="answer-buttons answer-buttons-notes">
        <button class="answer-btn answer-btn-note" data-note="C">C</button>
        <button class="answer-btn answer-btn-note" data-note="C#">C#/Db</button>
        <button class="answer-btn answer-btn-note" data-note="D">D</button>
        <button class="answer-btn answer-btn-note" data-note="D#">D#/Eb</button>
        <button class="answer-btn answer-btn-note" data-note="E">E</button>
        <button class="answer-btn answer-btn-note" data-note="F">F</button>
        <button class="answer-btn answer-btn-note" data-note="F#">F#/Gb</button>
        <button class="answer-btn answer-btn-note" data-note="G">G</button>
        <button class="answer-btn answer-btn-note" data-note="G#">G#/Ab</button>
        <button class="answer-btn answer-btn-note" data-note="A">A</button>
        <button class="answer-btn answer-btn-note" data-note="A#">A#/Bb</button>
        <button class="answer-btn answer-btn-note" data-note="B">B</button>
      </div>
      <div class="answer-buttons answer-buttons-numerals" style="display: none;">
        <button class="answer-btn answer-btn-numeral" data-numeral="I">I</button>
        <button class="answer-btn answer-btn-numeral" data-numeral="ii">ii</button>
        <button class="answer-btn answer-btn-numeral" data-numeral="iii">iii</button>
        <button class="answer-btn answer-btn-numeral" data-numeral="IV">IV</button>
        <button class="answer-btn answer-btn-numeral" data-numeral="V">V</button>
        <button class="answer-btn answer-btn-numeral" data-numeral="vi">vi</button>
        <button class="answer-btn answer-btn-numeral" data-numeral="vii°">vii°</button>
      </div>
      <div class="feedback"></div>
      <div class="time-display"></div>
      <div class="hint"></div>
    </div>
  </div>

  <!-- Chord Spelling mode -->
  <div class="mode-screen" id="mode-chordSpelling">
    <div class="stats-container"></div>
    <div class="stats-controls">
      <div class="stats-toggle"><button class="stats-toggle-btn active" data-mode="retention">Recall</button><button class="stats-toggle-btn" data-mode="speed">Speed</button></div>
      <span class="stats"></span>
    </div>
    <div class="quiz-controls">
      <div class="settings-row">
        <div class="distance-toggles"></div>
      </div>
      <div class="mastery-message" style="display: none;">Looks like you've got this!</div>
      <div>
        <button class="start-btn">Start Quiz</button>
        <button class="stop-btn" style="display: none;">Stop Quiz</button>
        <button class="recalibrate-btn" style="display: none;">Redo speed check</button>
      </div>
    </div>
    <div class="quiz-header" style="display: none;">
      <span class="quiz-header-title">Practicing</span>
      <button class="quiz-header-close" aria-label="Stop quiz">×</button>
    </div>
    <div class="session-stats" style="display: none;">
      <span><span class="question-count">0</span> questions</span>
      <span class="elapsed-time">0s</span>
    </div>
    <div class="progress-bar" style="display: none;">
      <div class="progress-fill" style="width: 0%"></div>
      <div class="progress-text">0 / 0</div>
    </div>
    <div class="quiz-area">
      <div class="countdown-container"><div class="countdown-bar"></div></div>
      <div class="quiz-prompt"></div>
      <div class="chord-slots"></div>
      <div class="answer-buttons answer-buttons-notes">
        <button class="answer-btn answer-btn-note" data-note="C">C</button>
        <button class="answer-btn answer-btn-note" data-note="C#">C#/Db</button>
        <button class="answer-btn answer-btn-note" data-note="D">D</button>
        <button class="answer-btn answer-btn-note" data-note="D#">D#/Eb</button>
        <button class="answer-btn answer-btn-note" data-note="E">E</button>
        <button class="answer-btn answer-btn-note" data-note="F">F</button>
        <button class="answer-btn answer-btn-note" data-note="F#">F#/Gb</button>
        <button class="answer-btn answer-btn-note" data-note="G">G</button>
        <button class="answer-btn answer-btn-note" data-note="G#">G#/Ab</button>
        <button class="answer-btn answer-btn-note" data-note="A">A</button>
        <button class="answer-btn answer-btn-note" data-note="A#">A#/Bb</button>
        <button class="answer-btn answer-btn-note" data-note="B">B</button>
      </div>
      <div class="feedback"></div>
      <div class="time-display"></div>
      <div class="hint"></div>
    </div>
  </div>

  <script>
// Adaptive question selector: prioritizes items the user is slower on,
// with exploration boost for unseen items.
//
// This is the single source of truth. Tests import it as an ES module.
// main.ts reads it at build time and strips "export" for browser inlining.

const DEFAULT_CONFIG = {
  minTime: 1000,
  unseenBoost: 3,
  ewmaAlpha: 0.3,
  maxStoredTimes: 10,
  maxResponseTime: 9000,
  // Forgetting model
  initialStability: 4,       // hours — half-life after first correct answer
  maxStability: 336,         // hours (14 days) — stability ceiling
  stabilityGrowthBase: 2.0,  // multiplier on each correct answer
  stabilityDecayOnWrong: 0.3,// multiplier on wrong answer
  recallThreshold: 0.5,      // P(recall) below this = "due"
  expansionThreshold: 0.7,   // fraction of seen items that must be retained before suggesting new strings
  speedBonusMax: 1.5,        // fast answers grow stability up to this extra factor
  selfCorrectionThreshold: 1500, // ms — response time below this triggers self-correction
  automaticityTarget: 3000,      // ms — response time at which speedScore ≈ 0.5
};

// ---------------------------------------------------------------------------
// Pure functions
// ---------------------------------------------------------------------------

function computeEwma(oldEwma, newTime, alpha) {
  return alpha * newTime + (1 - alpha) * oldEwma;
}

/**
 * Predicted recall using half-life model: P = 2^(-t/S).
 * At t = stability, P = 0.5. Returns null for unseen items.
 */
function computeRecall(stabilityHours, elapsedHours) {
  if (stabilityHours == null || elapsedHours == null) return null;
  if (stabilityHours <= 0) return 0;
  if (elapsedHours <= 0) return 1;
  return Math.pow(2, -elapsedHours / stabilityHours);
}

/**
 * Speed score: maps EWMA onto [0, 1].
 * - minTime (1000ms) → 1.0 (fully automatic)
 * - automaticityTarget (3000ms) → 0.5
 * - Very slow → approaches 0
 * Uses exponential decay so the curve is smooth.
 */
function computeSpeedScore(ewmaMs, cfg) {
  if (ewmaMs == null) return null;
  const k = Math.LN2 / (cfg.automaticityTarget - cfg.minTime);
  return Math.exp(-k * Math.max(0, ewmaMs - cfg.minTime));
}

/**
 * Automaticity = recall * speedScore.
 * "Do I know this without thinking?" — combines "have I forgotten it?"
 * with "was I ever fast at it?" Returns null for unseen items.
 */
function computeAutomaticity(recall, speedScore) {
  if (recall == null || speedScore == null) return null;
  return recall * speedScore;
}

/**
 * Compute new stability after a correct answer.
 * - First correct: initialStability.
 * - Subsequent: grow by stabilityGrowthBase * speedFactor.
 * - Self-correction: if fast answer after long gap, back-calculate
 *   that true stability must be at least elapsedHours * 1.5.
 */
function updateStability(oldStability, responseTimeMs, elapsedHours, cfg) {
  if (oldStability == null) {
    return cfg.initialStability;
  }
  // Speed factor: fast answers grow stability more (0.5 to speedBonusMax)
  const range = cfg.maxResponseTime - cfg.minTime;
  const clamped = Math.max(cfg.minTime, Math.min(responseTimeMs, cfg.maxResponseTime));
  const t = range > 0 ? (cfg.maxResponseTime - clamped) / range : 0.5;
  const speedFactor = 0.5 + t * (cfg.speedBonusMax - 0.5);

  let newStability = oldStability * cfg.stabilityGrowthBase * speedFactor;

  // Self-correction: fast answer after long gap means true half-life is long
  if (elapsedHours > 0 && responseTimeMs < cfg.selfCorrectionThreshold) {
    newStability = Math.max(newStability, elapsedHours * 1.5);
  }

  return Math.min(newStability, cfg.maxStability);
}

/**
 * Compute new stability after a wrong answer.
 * Reduces stability but floors at initialStability.
 */
function computeStabilityAfterWrong(oldStability, cfg) {
  if (oldStability == null) return cfg.initialStability;
  return Math.max(cfg.initialStability, oldStability * cfg.stabilityDecayOnWrong);
}

/**
 * Compute selection weight for an item.
 * - Unseen items get unseenBoost (high weight for exploration).
 * - Seen items get ewma / minTime (slower = heavier),
 *   scaled by recall factor (low recall = more weight).
 */
function computeWeight(stats, cfg) {
  if (!stats) {
    return cfg.unseenBoost;
  }
  const speedWeight = Math.max(stats.ewma, cfg.minTime) / cfg.minTime;
  // If we have stability data, factor in recall
  if (stats.stability != null && stats.lastCorrectAt != null) {
    const elapsedHours = (Date.now() - stats.lastCorrectAt) / 3600000;
    const recall = computeRecall(stats.stability, elapsedHours);
    // recallWeight: 1.0 (perfect recall) to 2.0 (fully forgotten)
    const recallWeight = recall != null ? 1 + (1 - recall) : 1;
    return speedWeight * recallWeight;
  }
  return speedWeight;
}

/**
 * Weighted random selection. rand should be in [0, 1).
 * Injected for deterministic testing.
 */
function selectWeighted(items, weights, rand) {
  const totalWeight = weights.reduce((sum, w) => sum + w, 0);
  if (totalWeight === 0) {
    return items[Math.floor(rand * items.length)];
  }
  let remaining = rand * totalWeight;
  for (let i = 0; i < items.length; i++) {
    remaining -= weights[i];
    if (remaining <= 0) return items[i];
  }
  return items[items.length - 1];
}

/**
 * Derive a scaled config from a motor baseline measurement.
 * The default config assumes baseline = 1000ms. This scales all
 * absolute timing thresholds proportionally to the measured baseline.
 */
function deriveScaledConfig(motorBaseline, baseCfg = DEFAULT_CONFIG) {
  const scale = motorBaseline / 1000;
  return {
    ...baseCfg,
    minTime: Math.round(baseCfg.minTime * scale),
    automaticityTarget: Math.round(baseCfg.automaticityTarget * scale),
    selfCorrectionThreshold: Math.round(baseCfg.selfCorrectionThreshold * scale),
    maxResponseTime: Math.round(baseCfg.maxResponseTime * scale),
  };
}

/**
 * Compute median of a numeric array (non-mutating — copies and sorts internally).
 */
function computeMedian(values) {
  if (values.length === 0) return null;
  const sorted = [...values].sort((a, b) => a - b);
  const mid = Math.floor(sorted.length / 2);
  if (sorted.length % 2 === 1) return sorted[mid];
  return (sorted[mid - 1] + sorted[mid]) / 2;
}

// ---------------------------------------------------------------------------
// Selector factory (storage-injected — works with localStorage or Map)
// ---------------------------------------------------------------------------

function createAdaptiveSelector(
  storage,
  cfg = DEFAULT_CONFIG,
  randomFn = Math.random,
) {
  function recordResponse(itemId, timeMs, correct = true) {
    const clamped = Math.min(timeMs, cfg.maxResponseTime);
    const existing = storage.getStats(itemId);
    const now = Date.now();

    if (correct) {
      const elapsedHours = existing && existing.lastCorrectAt
        ? (now - existing.lastCorrectAt) / 3600000
        : null;
      if (existing) {
        const newEwma = computeEwma(existing.ewma, clamped, cfg.ewmaAlpha);
        const newTimes = [...existing.recentTimes, clamped].slice(
          -cfg.maxStoredTimes,
        );
        const newStability = updateStability(
          existing.stability ?? null, clamped, elapsedHours, cfg,
        );
        storage.saveStats(itemId, {
          recentTimes: newTimes,
          ewma: newEwma,
          sampleCount: existing.sampleCount + 1,
          lastSeen: now,
          stability: newStability,
          lastCorrectAt: now,
        });
      } else {
        storage.saveStats(itemId, {
          recentTimes: [clamped],
          ewma: clamped,
          sampleCount: 1,
          lastSeen: now,
          stability: cfg.initialStability,
          lastCorrectAt: now,
        });
      }
    } else {
      // Wrong answer: reduce stability, update lastSeen, don't touch EWMA
      if (existing) {
        const newStability = computeStabilityAfterWrong(
          existing.stability ?? null, cfg,
        );
        storage.saveStats(itemId, {
          ...existing,
          lastSeen: now,
          stability: newStability,
        });
      } else {
        // First interaction is wrong: create minimal stats
        storage.saveStats(itemId, {
          recentTimes: [],
          ewma: cfg.maxResponseTime,
          sampleCount: 0,
          lastSeen: now,
          stability: cfg.initialStability,
          lastCorrectAt: null,
        });
      }
    }
  }

  function getWeight(itemId) {
    return computeWeight(storage.getStats(itemId), cfg);
  }

  function getStats(itemId) {
    return storage.getStats(itemId);
  }

  function selectNext(validItems) {
    if (validItems.length === 0) {
      throw new Error("validItems cannot be empty");
    }
    if (validItems.length === 1) {
      storage.setLastSelected(validItems[0]);
      return validItems[0];
    }

    const lastSelected = storage.getLastSelected();
    const weights = validItems.map((id) =>
      id === lastSelected ? 0 : getWeight(id),
    );

    const selected = selectWeighted(validItems, weights, randomFn());
    storage.setLastSelected(selected);
    return selected;
  }

  function getRecall(itemId) {
    const stats = storage.getStats(itemId);
    if (!stats || stats.stability == null || stats.lastCorrectAt == null) {
      return null;
    }
    const elapsedHours = (Date.now() - stats.lastCorrectAt) / 3600000;
    return computeRecall(stats.stability, elapsedHours);
  }

  function getAutomaticity(itemId) {
    const stats = storage.getStats(itemId);
    if (!stats) return null;
    const recall = getRecall(itemId);
    const speed = computeSpeedScore(stats.ewma, cfg);
    return computeAutomaticity(recall, speed);
  }

  /**
   * Recommend strings to review. Returns array of
   * { string, dueCount, unseenCount, masteredCount, totalCount }
   * sorted by needsWork (dueCount + unseenCount) descending.
   * getItemIds(stringIndex) should return the item IDs for that string.
   *
   * - unseenCount: items with no recall data (never answered correctly)
   * - dueCount: items with established recall that dropped below threshold
   * - masteredCount: items with recall >= threshold (currently retained)
   */
  function getStringRecommendations(stringIndices, getItemIds) {
    const results = stringIndices.map((s) => {
      const items = getItemIds(s);
      let dueCount = 0;
      let unseenCount = 0;
      let masteredCount = 0;
      for (const id of items) {
        const recall = getRecall(id);
        if (recall === null) {
          unseenCount++;
        } else if (recall < cfg.recallThreshold) {
          dueCount++;
        } else {
          masteredCount++;
        }
      }
      return { string: s, dueCount, unseenCount, masteredCount, totalCount: items.length };
    });
    results.sort((a, b) => (b.dueCount + b.unseenCount) - (a.dueCount + a.unseenCount));
    return results;
  }

  /**
   * Check if all items have recall >= recallThreshold.
   * Returns false if any item is unseen or below threshold.
   */
  function checkAllMastered(items) {
    for (const id of items) {
      const recall = getRecall(id);
      if (recall === null || recall < cfg.recallThreshold) return false;
    }
    return items.length > 0;
  }

  /**
   * Check if previously-mastered material needs review.
   * Returns true only when ALL items had high prior skill (speedScore >= 0.5,
   * i.e. answering at or below the automaticity target, with at least 2
   * correct answers as evidence) but at least one item's recall has since
   * decayed below threshold.
   */
  function checkNeedsReview(items) {
    if (items.length === 0) return false;
    let hasDueItem = false;
    for (const id of items) {
      const stats = storage.getStats(id);
      if (!stats || stats.lastCorrectAt == null || stats.sampleCount < 2) return false;
      const speed = computeSpeedScore(stats.ewma, cfg);
      if (speed == null || speed < 0.5) return false;
      const recall = getRecall(id);
      if (recall !== null && recall < cfg.recallThreshold) hasDueItem = true;
    }
    return hasDueItem;
  }

  function updateConfig(newCfg) {
    cfg = { ...cfg, ...newCfg };
  }

  function getConfig() {
    return cfg;
  }

  return { recordResponse, selectNext, getStats, getWeight, getRecall, getAutomaticity, getStringRecommendations, checkAllMastered, checkNeedsReview, updateConfig, getConfig };
}

// ---------------------------------------------------------------------------
// In-memory storage (for tests)
// ---------------------------------------------------------------------------

function createMemoryStorage() {
  const stats = new Map();
  let lastSelected = null;

  return {
    getStats(itemId) {
      return stats.get(itemId) ?? null;
    },
    saveStats(itemId, s) {
      stats.set(itemId, s);
    },
    getLastSelected() {
      return lastSelected;
    },
    setLastSelected(itemId) {
      lastSelected = itemId;
    },
  };
}

// ---------------------------------------------------------------------------
// localStorage-backed storage (for browser)
// ---------------------------------------------------------------------------

function createLocalStorageAdapter(namespace) {
  const cache = {};
  const mkKey = (itemId) => `adaptive_${namespace}_${itemId}`;
  const lastKey = `adaptive_${namespace}_lastSelected`;

  return {
    getStats(itemId) {
      const k = mkKey(itemId);
      if (!(k in cache)) {
        const data = localStorage.getItem(k);
        try {
          cache[k] = data ? JSON.parse(data) : null;
        } catch {
          cache[k] = null;
        }
      }
      return cache[k];
    },
    saveStats(itemId, stats) {
      const k = mkKey(itemId);
      cache[k] = stats;
      localStorage.setItem(k, JSON.stringify(stats));
    },
    getLastSelected() {
      return localStorage.getItem(lastKey);
    },
    setLastSelected(itemId) {
      localStorage.setItem(lastKey, itemId);
    },
    /** Pre-populate cache to avoid localStorage reads during gameplay. */
    preload(itemIds) {
      for (const itemId of itemIds) {
        this.getStats(itemId);
      }
    },
  };
}

// Shared music theory data: notes, intervals, and helpers.
// Used by all quiz modes. This is an ES module — main.ts strips
// "export" keywords for browser inlining (same pattern as adaptive.js).

const NOTES = [
  { name: 'C',  displayName: 'C',     num: 0,  accepts: ['c'] },
  { name: 'C#', displayName: 'C#/Db', num: 1,  accepts: ['c#', 'db'] },
  { name: 'D',  displayName: 'D',     num: 2,  accepts: ['d'] },
  { name: 'D#', displayName: 'D#/Eb', num: 3,  accepts: ['d#', 'eb'] },
  { name: 'E',  displayName: 'E',     num: 4,  accepts: ['e'] },
  { name: 'F',  displayName: 'F',     num: 5,  accepts: ['f'] },
  { name: 'F#', displayName: 'F#/Gb', num: 6,  accepts: ['f#', 'gb'] },
  { name: 'G',  displayName: 'G',     num: 7,  accepts: ['g'] },
  { name: 'G#', displayName: 'G#/Ab', num: 8,  accepts: ['g#', 'ab'] },
  { name: 'A',  displayName: 'A',     num: 9,  accepts: ['a'] },
  { name: 'A#', displayName: 'A#/Bb', num: 10, accepts: ['a#', 'bb'] },
  { name: 'B',  displayName: 'B',     num: 11, accepts: ['b'] },
];

const NATURAL_NOTES = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];

const INTERVALS = [
  { name: 'minor 2nd',   num: 1,  abbrev: 'm2' },
  { name: 'Major 2nd',   num: 2,  abbrev: 'M2' },
  { name: 'minor 3rd',   num: 3,  abbrev: 'm3' },
  { name: 'Major 3rd',   num: 4,  abbrev: 'M3' },
  { name: 'Perfect 4th',  num: 5,  abbrev: 'P4' },
  { name: 'Tritone',      num: 6,  abbrev: 'TT', altAbbrevs: ['A4', 'd5'] },
  { name: 'Perfect 5th',  num: 7,  abbrev: 'P5' },
  { name: 'minor 6th',   num: 8,  abbrev: 'm6' },
  { name: 'Major 6th',   num: 9,  abbrev: 'M6' },
  { name: 'minor 7th',   num: 10, abbrev: 'm7' },
  { name: 'Major 7th',   num: 11, abbrev: 'M7' },
  { name: 'Octave',       num: 12, abbrev: 'P8' },
];

/** Look up a note by its semitone number (0–11). */
function noteByNum(num) {
  return NOTES[((num % 12) + 12) % 12];
}

/** Look up an interval by its semitone count (1–12). */
function intervalByNum(num) {
  return INTERVALS.find(i => i.num === num) || null;
}

/** Add semitones to a note number, wrapping at 12. Returns the result note. */
function noteAdd(noteNum, semitones) {
  return noteByNum(noteNum + semitones);
}

/** Subtract semitones from a note number, wrapping at 12. Returns the result note. */
function noteSub(noteNum, semitones) {
  return noteByNum(noteNum - semitones);
}

/** Pick a single accidental spelling from a displayName like 'C#/Db'. */
function pickAccidentalName(displayName, useFlats) {
  if (!displayName.includes('/')) return displayName;
  const [sharp, flat] = displayName.split('/');
  return useFlats ? flat : sharp;
}

/** Check if a user input matches any accepted answer for a note. */
function noteMatchesInput(note, input) {
  return note.accepts.includes(input.toLowerCase());
}

/** Check if a user input matches an interval abbreviation (case-sensitive). */
function intervalMatchesInput(interval, input) {
  if (input === interval.abbrev) return true;
  if (interval.altAbbrevs && interval.altAbbrevs.includes(input)) return true;
  return false;
}

// ---------------------------------------------------------------------------
// Letter-name arithmetic (for scale degrees, chord spelling, key sigs)
// ---------------------------------------------------------------------------

const LETTER_NAMES = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
const NATURAL_SEMITONES = { C: 0, D: 2, E: 4, F: 5, G: 7, A: 9, B: 11 };
const MAJOR_SCALE_STEPS = [0, 2, 4, 5, 7, 9, 11]; // cumulative semitones per degree

/** Parse a spelled note name like 'F#', 'Bb', 'Ebb' into { letter, accidental }. */
function parseSpelledNote(name) {
  const letter = name[0].toUpperCase();
  let acc = 0;
  for (let i = 1; i < name.length; i++) {
    if (name[i] === '#') acc++;
    else if (name[i] === 'b') acc--;
  }
  return { letter, accidental: acc };
}

/** Build a note name from letter + accidental offset. */
function spelledNoteName(letter, accidental) {
  if (accidental === 0) return letter;
  if (accidental > 0) return letter + '#'.repeat(accidental);
  return letter + 'b'.repeat(-accidental);
}

/** Get the semitone value (0-11) of a spelled note. */
function spelledNoteSemitone(name) {
  const { letter, accidental } = parseSpelledNote(name);
  return ((NATURAL_SEMITONES[letter] + accidental) % 12 + 12) % 12;
}

/**
 * Get the note name for a scale degree in a major key.
 * keyRoot: e.g., 'D', 'Bb', 'F#'
 * degree: 1-7 (1 = root)
 * Returns spelled note name, e.g., 'F#', 'Eb'.
 */
function getScaleDegreeNote(keyRoot, degree) {
  const root = parseSpelledNote(keyRoot);
  const rootLetterIdx = LETTER_NAMES.indexOf(root.letter);
  const rootSemitone = ((NATURAL_SEMITONES[root.letter] + root.accidental) % 12 + 12) % 12;

  const targetLetterIdx = (rootLetterIdx + degree - 1) % 7;
  const targetLetter = LETTER_NAMES[targetLetterIdx];
  const targetSemitone = (rootSemitone + MAJOR_SCALE_STEPS[degree - 1]) % 12;
  const naturalSemitone = NATURAL_SEMITONES[targetLetter];

  let acc = ((targetSemitone - naturalSemitone + 12) % 12);
  if (acc > 6) acc -= 12;

  return spelledNoteName(targetLetter, acc);
}

/**
 * Reverse lookup: given a key and a note, find which degree (1-7) it is.
 * Returns the degree number, or 0 if the note isn't in the scale.
 */
function findScaleDegree(keyRoot, noteName) {
  const noteSemitone = spelledNoteSemitone(noteName);
  for (let d = 1; d <= 7; d++) {
    const degreeName = getScaleDegreeNote(keyRoot, d);
    if (spelledNoteSemitone(degreeName) === noteSemitone) return d;
  }
  return 0;
}

// ---------------------------------------------------------------------------
// Key signatures
// ---------------------------------------------------------------------------

const MAJOR_KEYS = [
  { root: 'C',  sharps: 0, flats: 0, accidentalCount: 0,  accidentalType: 'none' },
  { root: 'G',  sharps: 1, flats: 0, accidentalCount: 1,  accidentalType: 'sharps' },
  { root: 'D',  sharps: 2, flats: 0, accidentalCount: 2,  accidentalType: 'sharps' },
  { root: 'A',  sharps: 3, flats: 0, accidentalCount: 3,  accidentalType: 'sharps' },
  { root: 'E',  sharps: 4, flats: 0, accidentalCount: 4,  accidentalType: 'sharps' },
  { root: 'B',  sharps: 5, flats: 0, accidentalCount: 5,  accidentalType: 'sharps' },
  { root: 'F#', sharps: 6, flats: 0, accidentalCount: 6,  accidentalType: 'sharps' },
  { root: 'F',  sharps: 0, flats: 1, accidentalCount: 1,  accidentalType: 'flats' },
  { root: 'Bb', sharps: 0, flats: 2, accidentalCount: 2,  accidentalType: 'flats' },
  { root: 'Eb', sharps: 0, flats: 3, accidentalCount: 3,  accidentalType: 'flats' },
  { root: 'Ab', sharps: 0, flats: 4, accidentalCount: 4,  accidentalType: 'flats' },
  { root: 'Db', sharps: 0, flats: 5, accidentalCount: 5,  accidentalType: 'flats' },
];

/** Build a display label for a key signature, e.g., '2#', '3b', '0'. */
function keySignatureLabel(key) {
  if (key.accidentalCount === 0) return '0';
  if (key.accidentalType === 'sharps') return key.accidentalCount + '#';
  return key.accidentalCount + 'b';
}

/** Find a key by its signature label (e.g., '2#' -> D major). */
function keyBySignatureLabel(label) {
  return MAJOR_KEYS.find(k => keySignatureLabel(k) === label) || null;
}

// ---------------------------------------------------------------------------
// Diatonic chords (major key harmonization)
// ---------------------------------------------------------------------------

const DIATONIC_CHORDS = [
  { degree: 1, numeral: 'I',     quality: 'major',      qualityLabel: '' },
  { degree: 2, numeral: 'ii',    quality: 'minor',      qualityLabel: 'm' },
  { degree: 3, numeral: 'iii',   quality: 'minor',      qualityLabel: 'm' },
  { degree: 4, numeral: 'IV',    quality: 'major',      qualityLabel: '' },
  { degree: 5, numeral: 'V',     quality: 'major',      qualityLabel: '' },
  { degree: 6, numeral: 'vi',    quality: 'minor',      qualityLabel: 'm' },
  { degree: 7, numeral: 'vii\u00B0', quality: 'diminished', qualityLabel: 'dim' },
];

const ROMAN_NUMERALS = DIATONIC_CHORDS.map(c => c.numeral);

// ---------------------------------------------------------------------------
// Chord types and spelling
// ---------------------------------------------------------------------------

// Letter offset from root for each chord-tone label
const DEGREE_LETTER_OFFSETS = {
  'R': 0, '2': 1, 'b3': 2, '3': 2, '4': 3,
  'b5': 4, '5': 4, '#5': 4, '6': 5, 'b7': 6, '7': 6,
};

const CHORD_TYPES = [
  { name: 'major',   symbol: '',      intervals: [0, 4, 7],      degrees: ['R', '3', '5'],  group: 0 },
  { name: 'minor',   symbol: 'm',     intervals: [0, 3, 7],      degrees: ['R', 'b3', '5'], group: 1 },
  { name: 'dom7',    symbol: '7',     intervals: [0, 4, 7, 10],  degrees: ['R', '3', '5', 'b7'], group: 2 },
  { name: 'maj7',    symbol: 'maj7',  intervals: [0, 4, 7, 11],  degrees: ['R', '3', '5', '7'],  group: 3 },
  { name: 'min7',    symbol: 'm7',    intervals: [0, 3, 7, 10],  degrees: ['R', 'b3', '5', 'b7'], group: 4 },
  { name: 'dim',     symbol: 'dim',   intervals: [0, 3, 6],      degrees: ['R', 'b3', 'b5'], group: 5 },
  { name: 'aug',     symbol: 'aug',   intervals: [0, 4, 8],      degrees: ['R', '3', '#5'],  group: 5 },
  { name: 'halfdim', symbol: 'm7b5',  intervals: [0, 3, 6, 10],  degrees: ['R', 'b3', 'b5', 'b7'], group: 5 },
  { name: 'sus2',    symbol: 'sus2',  intervals: [0, 2, 7],      degrees: ['R', '2', '5'],   group: 6 },
  { name: 'sus4',    symbol: 'sus4',  intervals: [0, 5, 7],      degrees: ['R', '4', '5'],   group: 6 },
  { name: '6',       symbol: '6',     intervals: [0, 4, 7, 9],   degrees: ['R', '3', '5', '6'], group: 6 },
];

/** Canonical root names for chord spelling (12 chromatic pitches). */
const CHORD_ROOTS = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'F#', 'G', 'Ab', 'A', 'Bb', 'B'];

/**
 * Compute the correctly-spelled chord tones for a given root and chord type.
 * Returns array of spelled note names, e.g., ['C', 'Eb', 'G'] for Cm.
 */
function getChordTones(rootName, chordType) {
  const root = parseSpelledNote(rootName);
  const rootLetterIdx = LETTER_NAMES.indexOf(root.letter);
  const rootSemitone = ((NATURAL_SEMITONES[root.letter] + root.accidental) % 12 + 12) % 12;

  return chordType.intervals.map((interval, i) => {
    const degreeLabel = chordType.degrees[i];
    const letterOffset = DEGREE_LETTER_OFFSETS[degreeLabel];
    const targetLetter = LETTER_NAMES[(rootLetterIdx + letterOffset) % 7];
    const targetSemitone = (rootSemitone + interval) % 12;
    const naturalSemitone = NATURAL_SEMITONES[targetLetter];

    let acc = ((targetSemitone - naturalSemitone + 12) % 12);
    if (acc > 6) acc -= 12;

    return spelledNoteName(targetLetter, acc);
  });
}

/** Build chord display name, e.g., 'Cm7', 'F#dim', 'Bbmaj7'. */
function chordDisplayName(rootName, chordType) {
  return rootName + chordType.symbol;
}

/**
 * Check if a user input matches a spelled note exactly (strict enharmonic).
 * Matches case-insensitively but requires correct letter + accidental.
 */
function spelledNoteMatchesInput(expectedName, input) {
  const expected = parseSpelledNote(expectedName);
  const given = parseSpelledNote(input);
  return given.letter.toUpperCase() === expected.letter.toUpperCase()
      && given.accidental === expected.accidental;
}

/**
 * Check if a user input matches a spelled note by semitone (lenient).
 * Used for button taps where user can't distinguish enharmonics.
 */
function spelledNoteMatchesSemitone(expectedName, input) {
  return spelledNoteSemitone(expectedName) === spelledNoteSemitone(input);
}

// Guitar-specific data
const STRING_NAMES = ['e', 'B', 'G', 'D', 'A', 'E'];
const STRING_OFFSETS = [4, 11, 7, 2, 9, 4]; // semitones from C

// Pure state transitions for the quiz engine.
// No DOM, no timers, no side effects — just data in, data out.
// ES module — exports stripped for browser inlining.

/**
 * Create the initial (idle) engine state.
 * @returns {EngineState}
 */
function initialEngineState() {
  return {
    phase: 'idle',          // 'idle' | 'active' | 'calibration-intro' | 'calibrating' | 'calibration-results'
    currentItemId: null,
    answered: false,
    questionStartTime: null,

    // Session tracking
    questionCount: 0,
    quizStartTime: null,

    // Progress tracking
    masteredCount: 0,
    totalEnabledCount: 0,

    // Feedback
    feedbackText: '',
    feedbackClass: 'feedback',
    timeDisplayText: '',
    hintText: '',

    // Mastery message
    masteryText: '',
    showMastery: false,

    // Calibration
    calibrationBaseline: null,

    // UI visibility
    showStartBtn: true,
    showStopBtn: false,
    showHeatmapBtn: true,
    showStatsControls: true,
    quizActive: false,
    answersEnabled: false,
  };
}

/**
 * Transition: start the quiz.
 * Caller should invoke mode.onStart() separately, then call engineNextQuestion.
 */
function engineStart(state) {
  return {
    ...state,
    phase: 'active',
    questionCount: 0,
    quizStartTime: Date.now(),
    showStartBtn: false,
    showStopBtn: false,
    showHeatmapBtn: false,
    showStatsControls: false,
    quizActive: true,
    showMastery: false,
  };
}

/**
 * Transition: present the next question.
 * @param {EngineState} state
 * @param {string} nextItemId - selected by the adaptive selector
 * @param {number} nowMs - current timestamp (Date.now())
 */
function engineNextQuestion(state, nextItemId, nowMs) {
  return {
    ...state,
    currentItemId: nextItemId,
    answered: false,
    questionStartTime: nowMs,
    questionCount: state.questionCount + 1,
    feedbackText: '',
    feedbackClass: 'feedback',
    timeDisplayText: '',
    hintText: '',
    answersEnabled: true,
  };
}

/**
 * Transition: submit an answer.
 * @param {EngineState} state
 * @param {boolean} isCorrect
 * @param {string} correctAnswer - display string for incorrect feedback
 * @param {number} responseTimeMs
 */
function engineSubmitAnswer(state, isCorrect, correctAnswer, responseTimeMs) {
  return {
    ...state,
    answered: true,
    answersEnabled: false,
    feedbackText: isCorrect ? 'Correct!' : 'Incorrect \u2014 ' + correctAnswer,
    feedbackClass: isCorrect ? 'feedback correct' : 'feedback incorrect',
    timeDisplayText: responseTimeMs + ' ms',
    hintText: 'Tap anywhere or press Space for next',
  };
}

/**
 * Transition: enter calibration intro screen.
 * Shows explanation and a Start button; quiz controls are hidden.
 */
function engineCalibrationIntro(state) {
  return {
    ...state,
    phase: 'calibration-intro',
    showStartBtn: false,
    showStopBtn: false,
    showHeatmapBtn: false,
    showStatsControls: false,
    showMastery: false,
    quizActive: true,
    answersEnabled: false,
    feedbackText: 'Quick Speed Check',
    feedbackClass: 'feedback',
    hintText: "We\u2019ll measure your tap speed to set personalized targets. Tap each highlighted button as fast as you can \u2014 10 taps total.",
    timeDisplayText: '',
    calibrationBaseline: null,
  };
}

/**
 * Transition: calibration trials are running.
 * Buttons enabled for tapping; trial counter shown in timeDisplay.
 */
function engineCalibrating(state) {
  return {
    ...state,
    phase: 'calibrating',
    answersEnabled: true,
    feedbackText: 'Speed check!',
    hintText: 'Tap the highlighted button as fast as you can',
  };
}

/**
 * Transition: calibration complete, show results.
 * @param {number} baseline - measured motor baseline in ms
 */
function engineCalibrationResults(state, baseline) {
  return {
    ...state,
    phase: 'calibration-results',
    answersEnabled: false,
    feedbackText: 'Speed Check Complete',
    feedbackClass: 'feedback',
    hintText: '',
    timeDisplayText: '',
    calibrationBaseline: baseline,
  };
}

/**
 * Transition: stop the quiz (return to idle).
 * Works from any phase — quiz, calibration, or already idle.
 */
function engineStop(state) {
  return initialEngineState();
}

/**
 * Transition: update the idle mastery/review message.
 * No-op if the engine is active.
 */
function engineUpdateIdleMessage(state, allMastered, needsReview) {
  if (state.phase !== 'idle') return state;
  if (allMastered) {
    return { ...state, masteryText: 'Looks like you\u2019ve got this!', showMastery: true };
  }
  if (needsReview) {
    return { ...state, masteryText: 'Time to review?', showMastery: true };
  }
  return { ...state, masteryText: '', showMastery: false };
}

/**
 * Transition: update mastery message after an answer (during quiz).
 */
function engineUpdateMasteryAfterAnswer(state, allMastered) {
  if (allMastered) {
    return { ...state, masteryText: 'Looks like you\u2019ve got this!', showMastery: true };
  }
  return { ...state, showMastery: false };
}

/**
 * Transition: update progress counts (mastered vs total enabled items).
 */
function engineUpdateProgress(state, masteredCount, totalEnabledCount) {
  return { ...state, masteredCount, totalEnabledCount };
}

/**
 * Route a keydown event to an action descriptor. Pure — no DOM.
 * @param {EngineState} state
 * @param {string} key - e.key value
 * @returns {{ action: string }} action is one of 'stop', 'next', 'delegate', 'ignore'
 */
function engineRouteKey(state, key) {
  if (state.phase === 'idle') return { action: 'ignore' };
  if (key === 'Escape') return { action: 'stop' };
  if (state.phase !== 'active') return { action: 'ignore' };
  if ((key === ' ' || key === 'Enter') && state.answered) return { action: 'next' };
  if (!state.answered) return { action: 'delegate' };
  return { action: 'ignore' };
}

// Shared quiz engine: manages adaptive selection, timing, countdown,
// feedback, and keyboard/tap handling for all quiz modes.
//
// Each quiz mode provides a config object; the engine handles the
// shared lifecycle. ES module — exports stripped for browser inlining.
//
// Depends on globals (from quiz-engine-state.js): initialEngineState,
// engineStart, engineNextQuestion, engineSubmitAnswer, engineStop,
// engineUpdateIdleMessage, engineUpdateMasteryAfterAnswer, engineUpdateProgress,
// engineRouteKey, engineCalibrationIntro, engineCalibrating,
// engineCalibrationResults

/**
 * Create a keyboard handler for note input (C D E F G A B + #/b for accidentals).
 * Used by any mode where the answer is a note name.
 *
 * The handler keeps an internal timeout to allow a short window after a note key
 * is pressed for an accidental key (`#` / `b`) to be entered. Callers should
 * invoke `reset()` when the quiz stops and before restarting to clear any pending
 * note and prevent stale input from being submitted after the quiz has ended.
 *
 * @param {function} submitAnswer - Called with the note string (e.g. 'C', 'C#', 'Db')
 * @param {function} [allowAccidentals] - Returns true if accidentals are enabled
 * @returns {{ handleKey(e): boolean, reset(): void }}
 */
function createNoteKeyHandler(submitAnswer, allowAccidentals = () => true) {
  let pendingNote = null;
  let pendingTimeout = null;

  function reset() {
    if (pendingTimeout) clearTimeout(pendingTimeout);
    pendingNote = null;
    pendingTimeout = null;
  }

  function handleKey(e) {
    const key = e.key.toUpperCase();

    // Handle # for sharps or b for flats after a pending note
    if (pendingNote && allowAccidentals()) {
      if (e.key === '#' || (e.shiftKey && e.key === '3')) {
        e.preventDefault();
        clearTimeout(pendingTimeout);
        submitAnswer(pendingNote + '#');
        pendingNote = null;
        pendingTimeout = null;
        return true;
      }
      if (e.key === 'b' || e.key === 'B') {
        e.preventDefault();
        clearTimeout(pendingTimeout);
        submitAnswer(pendingNote + 'b');
        pendingNote = null;
        pendingTimeout = null;
        return true;
      }
    }

    if ('CDEFGAB'.includes(key)) {
      e.preventDefault();
      if (pendingTimeout) clearTimeout(pendingTimeout);

      if (!allowAccidentals()) {
        submitAnswer(key);
      } else {
        pendingNote = key;
        pendingTimeout = setTimeout(() => {
          submitAnswer(pendingNote);
          pendingNote = null;
          pendingTimeout = null;
        }, 400);
      }
      return true;
    }

    return false;
  }

  return { handleKey, reset };
}

/**
 * Build human-readable threshold descriptions from a motor baseline.
 * Returns an array of { label, maxMs, meaning } objects describing the
 * heatmap speed bands. Used by the calibration results screen.
 *
 * @param {number} baseline - Motor baseline in ms
 * @returns {{ label: string, maxMs: number|null, meaning: string }[]}
 */
function getCalibrationThresholds(baseline) {
  return [
    { label: 'Automatic', maxMs: Math.round(baseline * 1.5), meaning: 'Fully memorized — instant recall' },
    { label: 'Good',      maxMs: Math.round(baseline * 3.0), meaning: 'Solid recall, minor hesitation' },
    { label: 'Developing', maxMs: Math.round(baseline * 4.5), meaning: 'Working on it — needs practice' },
    { label: 'Slow',      maxMs: Math.round(baseline * 6.0), meaning: 'Significant hesitation' },
    { label: 'Very slow', maxMs: null,                        meaning: 'Not yet learned' },
  ];
}

/**
 * Update aggregate stats display for a set of item IDs.
 * Currently a no-op (median display was removed).
 */
function updateModeStats(selector, itemIds, statsEl) {
  if (!statsEl) return;
  statsEl.textContent = '';
}

/**
 * Determine the keyboard key that would activate a given button.
 * Returns null if no single-key shortcut exists (e.g. sharps, two-digit numbers).
 */
function getKeyForButton(btn) {
  const note = btn.dataset.note;
  if (note && note.length === 1 && 'CDEFGAB'.includes(note.toUpperCase())) return note.toUpperCase();
  const num = btn.dataset.num;
  if (num !== undefined && num.length === 1) return num;
  return null;
}

/**
 * Run a motor-baseline calibration sequence.
 * Highlights random buttons one at a time; user taps or types to respond.
 *
 * @param {object}   opts
 * @param {Element[]} opts.buttons    - answer buttons to use for calibration
 * @param {object}   opts.els        - engine DOM elements (feedback, hint, timeDisplay)
 * @param {Element}  opts.container  - mode container element
 * @param {function} opts.onComplete - called with median time in ms
 */
function runCalibration(opts) {
  const { buttons, els, container, onComplete } = opts;
  const TRIAL_COUNT = 10;
  const PAUSE_MS = 400;

  const times = [];
  let trialIndex = 0;
  let targetBtn = null;
  let trialStartTime = null;
  let prevBtnIndex = -1;
  let canceled = false;
  let pendingTimeout = null;

  function startTrial() {
    if (canceled) return;
    if (trialIndex >= TRIAL_COUNT) {
      cleanup();
      const median = computeMedian(times);
      onComplete(median);
      return;
    }

    // Pick random button (not same as previous)
    let idx;
    do {
      idx = Math.floor(Math.random() * buttons.length);
    } while (idx === prevBtnIndex && buttons.length > 1);
    prevBtnIndex = idx;

    targetBtn = buttons[idx];
    targetBtn.classList.add('calibration-target');
    trialStartTime = Date.now();

    if (els.timeDisplay) els.timeDisplay.textContent = (trialIndex + 1) + ' / ' + TRIAL_COUNT;
  }

  function recordTrial() {
    const elapsed = Date.now() - trialStartTime;
    times.push(elapsed);
    targetBtn.classList.remove('calibration-target');
    targetBtn = null;
    trialIndex++;
    pendingTimeout = setTimeout(startTrial, PAUSE_MS);
  }

  function handleCalibrationClick(e) {
    if (!targetBtn) return;
    const clicked = e.target.closest('.note-btn, .answer-btn');
    if (clicked === targetBtn) {
      recordTrial();
    }
  }

  function handleCalibrationKey(e) {
    if (!targetBtn) return;
    const expectedKey = getKeyForButton(targetBtn);
    if (expectedKey && e.key.toUpperCase() === expectedKey) {
      e.preventDefault();
      recordTrial();
    }
  }

  function cleanup() {
    canceled = true;
    if (pendingTimeout !== null) {
      clearTimeout(pendingTimeout);
      pendingTimeout = null;
    }
    container.removeEventListener('click', handleCalibrationClick);
    document.removeEventListener('keydown', handleCalibrationKey);
    if (targetBtn) {
      targetBtn.classList.remove('calibration-target');
      targetBtn = null;
    }
  }

  container.addEventListener('click', handleCalibrationClick);
  document.addEventListener('keydown', handleCalibrationKey);

  startTrial();

  // Return cleanup function in case the quiz is stopped during calibration
  return cleanup;
}

/**
 * Create a quiz engine for a given mode.
 *
 * @param {object} mode - Quiz mode configuration:
 *   mode.id           - Unique mode identifier
 *   mode.storageNamespace - Key prefix for adaptive storage
 *   mode.getEnabledItems() - Returns array of item IDs eligible for quiz
 *   mode.presentQuestion(itemId) - Updates DOM to show the question
 *   mode.checkAnswer(itemId, input) - Returns { correct, correctAnswer }
 *   mode.onStart()    - Called when quiz starts (optional)
 *   mode.onStop()     - Called when quiz stops (optional)
 *   mode.handleKey(e, state) - Mode-specific key handling, return true if handled (optional)
 *   mode.getCalibrationButtons() - Returns array of DOM elements for calibration (optional)
 *
 * @param {HTMLElement} container - Root element containing quiz DOM elements.
 *   Expected children (found by class):
 *     .countdown-bar, .feedback, .time-display, .hint,
 *     .start-btn, .stop-btn, .stats-toggle, .stats,
 *     .stats-controls, .mastery-message
 *
 * @returns {{ start, stop, submitAnswer, nextQuestion, attach, detach,
 *             updateIdleMessage, isActive, isAnswered, selector, storage, els, baseline }}
 */
function createQuizEngine(mode, container) {
  const storage = createLocalStorageAdapter(mode.storageNamespace);
  const selector = createAdaptiveSelector(storage);

  const provider = mode.calibrationProvider || 'button';
  const baselineKey = 'motorBaseline_' + provider;
  const legacyBaselineKey = 'motorBaseline_' + mode.storageNamespace;
  let motorBaseline = null;
  let calibrationCleanup = null;   // cancel function for running trials
  let calibrationContentEl = null; // dynamically-created DOM for intro/results

  // Load stored baseline and apply to config at init time.
  // Check shared provider key first; fall back to legacy per-mode key for migration.
  let storedBaseline = localStorage.getItem(baselineKey);
  if (!storedBaseline && legacyBaselineKey !== baselineKey) {
    storedBaseline = localStorage.getItem(legacyBaselineKey);
    if (storedBaseline) {
      // Migrate legacy baseline to shared provider key
      localStorage.setItem(baselineKey, storedBaseline);
    }
  }
  if (storedBaseline) {
    const parsed = parseInt(storedBaseline, 10);
    if (parsed > 0) {
      motorBaseline = parsed;
      selector.updateConfig(deriveScaledConfig(motorBaseline, DEFAULT_CONFIG));
    }
  }

  let state = initialEngineState();
  let countdownInterval = null;
  let elapsedTimeInterval = null;

  // DOM references (scoped to container)
  const els = {
    countdownBar: container.querySelector('.countdown-bar'),
    feedback: container.querySelector('.feedback'),
    timeDisplay: container.querySelector('.time-display'),
    hint: container.querySelector('.hint'),
    startBtn: container.querySelector('.start-btn'),
    stopBtn: container.querySelector('.stop-btn'),
    statsToggle: container.querySelector('.stats-toggle'),
    stats: container.querySelector('.stats'),
    statsControls: container.querySelector('.stats-controls'),
    quizArea: container.querySelector('.quiz-area'),
    masteryMessage: container.querySelector('.mastery-message'),
    recalibrateBtn: container.querySelector('.recalibrate-btn'),
    quizHeader: container.querySelector('.quiz-header'),
    quizHeaderClose: container.querySelector('.quiz-header-close'),
    sessionStats: container.querySelector('.session-stats'),
    questionCountEl: container.querySelector('.question-count'),
    elapsedTimeEl: container.querySelector('.elapsed-time'),
    progressBar: container.querySelector('.progress-bar'),
    progressFill: container.querySelector('.progress-fill'),
    progressText: container.querySelector('.progress-text'),
  };

  // --- Render: declaratively map state to DOM ---

  function clearCalibrationContent() {
    if (calibrationContentEl) {
      calibrationContentEl.remove();
      calibrationContentEl = null;
    }
  }

  function insertAfterHint(el) {
    if (els.hint && els.hint.parentNode) {
      els.hint.parentNode.insertBefore(el, els.hint.nextSibling);
    }
  }

  function renderCalibrationIntro() {
    clearCalibrationContent();
    const btn = document.createElement('button');
    btn.textContent = 'Start';
    btn.className = 'calibration-action-btn';
    btn.addEventListener('click', beginCalibrationTrials);
    calibrationContentEl = btn;
    insertAfterHint(btn);
  }

  function renderCalibrationResults() {
    clearCalibrationContent();
    const baseline = state.calibrationBaseline;
    const thresholds = getCalibrationThresholds(baseline);

    const div = document.createElement('div');
    div.className = 'calibration-results';

    const baselineP = document.createElement('p');
    baselineP.className = 'calibration-baseline';
    baselineP.textContent = 'Your baseline response time: ' + formatMs(baseline);
    div.appendChild(baselineP);

    const table = document.createElement('table');
    table.className = 'calibration-thresholds';

    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    ['Speed', 'Response time', 'Meaning'].forEach((text) => {
      const th = document.createElement('th');
      th.textContent = text;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    thresholds.forEach((t) => {
      const tr = document.createElement('tr');
      const tdLabel = document.createElement('td');
      tdLabel.textContent = t.label;
      tr.appendChild(tdLabel);

      const tdTime = document.createElement('td');
      tdTime.textContent = t.maxMs !== null ? '< ' + formatMs(t.maxMs) : '> ' + formatMs(thresholds[thresholds.length - 2].maxMs);
      tr.appendChild(tdTime);

      const tdMeaning = document.createElement('td');
      tdMeaning.textContent = t.meaning;
      tr.appendChild(tdMeaning);

      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    div.appendChild(table);

    const doneBtn = document.createElement('button');
    doneBtn.textContent = 'Done';
    doneBtn.className = 'calibration-action-btn';
    doneBtn.addEventListener('click', finishCalibration);
    div.appendChild(doneBtn);

    calibrationContentEl = div;
    insertAfterHint(div);
  }

  function render() {
    const inCalibration = state.phase === 'calibration-intro' ||
                          state.phase === 'calibrating' ||
                          state.phase === 'calibration-results';

    // Clear calibration content when leaving calibration phases
    const inCalibUI = state.phase === 'calibration-intro' || state.phase === 'calibration-results';
    if (!inCalibUI) {
      clearCalibrationContent();
    }

    // Toggle calibrating class on container for CSS-driven visibility
    container.classList.toggle('calibrating', inCalibration);

    // Mark the calibration button container so CSS can hide others
    if (inCalibration && !container.querySelector('.calibration-active')) {
      const buttons = getCalibrationButtons();
      if (buttons.length > 0) {
        const parent = buttons[0].closest('.answer-buttons, .note-buttons');
        if (parent) parent.classList.add('calibration-active');
      }
    }
    if (!inCalibration) {
      const activeEl = container.querySelector('.calibration-active');
      if (activeEl) activeEl.classList.remove('calibration-active');
    }

    // Show/hide close button
    if (inCalibration && !container.querySelector('.calibration-close-btn')) {
      const closeBtn = document.createElement('button');
      closeBtn.className = 'calibration-close-btn';
      closeBtn.textContent = '\u00D7';
      closeBtn.setAttribute('aria-label', 'Close speed check');
      closeBtn.addEventListener('click', stop);
      if (els.quizArea) {
        els.quizArea.style.position = 'relative';
        els.quizArea.appendChild(closeBtn);
      }
    }
    if (!inCalibration) {
      const closeBtn = container.querySelector('.calibration-close-btn');
      if (closeBtn) closeBtn.remove();
    }

    if (els.startBtn)      els.startBtn.style.display     = state.showStartBtn ? 'inline' : 'none';
    if (els.stopBtn)       els.stopBtn.style.display      = state.showStopBtn ? 'inline' : 'none';
    if (els.statsToggle)   els.statsToggle.style.display   = state.showHeatmapBtn ? '' : 'none';
    if (els.statsControls) els.statsControls.style.display = state.showStatsControls ? '' : 'none';
    if (els.quizArea)      els.quizArea.classList.toggle('active', state.quizActive);
    if (els.feedback) {
      els.feedback.textContent = state.feedbackText;
      els.feedback.className   = state.feedbackClass;
    }
    if (els.timeDisplay) els.timeDisplay.textContent = state.timeDisplayText;
    if (els.hint)        els.hint.textContent        = state.hintText;
    if (els.masteryMessage) {
      els.masteryMessage.textContent   = state.masteryText;
      els.masteryMessage.style.display = state.showMastery ? 'block' : 'none';
    }
    if (els.recalibrateBtn) {
      els.recalibrateBtn.style.display = (state.phase === 'idle' && motorBaseline) ? 'inline' : 'none';
    }
    if (els.countdownBar) {
      els.countdownBar.classList.remove('expired');
      if (state.phase !== 'active') els.countdownBar.style.width = '0%';
    }

    // Quiz header visibility — only during active quiz, not calibration
    if (els.quizHeader) {
      els.quizHeader.style.display = state.phase === 'active' ? 'flex' : 'none';
    }

    // Session stats (question count + elapsed time)
    if (els.sessionStats) {
      els.sessionStats.style.display = state.phase === 'active' ? 'flex' : 'none';
    }
    if (els.questionCountEl && state.phase === 'active') {
      els.questionCountEl.textContent = state.questionCount;
    }

    // Progress bar
    if (els.progressBar) {
      els.progressBar.style.display = state.quizActive && state.phase === 'active' ? 'block' : 'none';
    }
    if (els.progressFill) {
      const pct = state.totalEnabledCount > 0
        ? Math.round((state.masteredCount / state.totalEnabledCount) * 100)
        : 0;
      els.progressFill.style.width = pct + '%';
    }
    if (els.progressText) {
      els.progressText.textContent = state.masteredCount + ' / ' + state.totalEnabledCount;
    }

    setAnswerButtonsEnabled(state.answersEnabled);

    // Create calibration content when entering those phases
    if (state.phase === 'calibration-intro' && !calibrationContentEl) {
      renderCalibrationIntro();
    } else if (state.phase === 'calibration-results' && !calibrationContentEl) {
      renderCalibrationResults();
    }
  }

  // --- Elapsed time display ---

  function formatElapsedTime(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    if (minutes === 0) return seconds + 's';
    return minutes + 'm ' + (seconds < 10 ? '0' : '') + seconds + 's';
  }

  function updateElapsedTime() {
    if (!state.quizStartTime || !els.elapsedTimeEl) return;
    els.elapsedTimeEl.textContent = formatElapsedTime(Date.now() - state.quizStartTime);
  }

  function startElapsedTimer() {
    updateElapsedTime();
    elapsedTimeInterval = setInterval(updateElapsedTime, 1000);
  }

  function stopElapsedTimer() {
    if (elapsedTimeInterval) {
      clearInterval(elapsedTimeInterval);
      elapsedTimeInterval = null;
    }
  }

  // --- Countdown (purely DOM/timer — not part of state) ---

  function getTargetTime() {
    return selector.getConfig().automaticityTarget;
  }

  function startCountdown() {
    const bar = els.countdownBar;
    if (!bar) return;
    bar.style.width = '100%';
    bar.classList.remove('expired');

    if (countdownInterval) clearInterval(countdownInterval);

    const targetTime = getTargetTime();
    let expired = false;
    const startTime = Date.now();
    countdownInterval = setInterval(() => {
      const elapsed = Date.now() - startTime;
      const remaining = Math.max(0, targetTime - elapsed);
      bar.style.width = (remaining / targetTime) * 100 + '%';

      if (remaining === 0 && !expired) {
        expired = true;
        bar.classList.add('expired');
        clearInterval(countdownInterval);
      }
    }, 50);
  }

  function setAnswerButtonsEnabled(enabled) {
    container.querySelectorAll('.answer-btn, .note-btn').forEach(btn => {
      btn.disabled = !enabled;
      // pointer-events: none lets taps fall through to the parent so
      // the tap-to-advance handler still fires on mobile (disabled
      // buttons swallow click events and prevent bubbling).
      btn.style.pointerEvents = enabled ? '' : 'none';
    });
  }

  // --- Baseline application ---

  function applyBaseline(baseline) {
    motorBaseline = baseline;
    localStorage.setItem(baselineKey, String(baseline));
    selector.updateConfig(deriveScaledConfig(baseline, DEFAULT_CONFIG));
  }

  // --- Calibration ---

  function getCalibrationButtons() {
    if (mode.getCalibrationButtons) return mode.getCalibrationButtons();
    // Fallback: all visible note/answer buttons
    return Array.from(container.querySelectorAll('.note-btn:not(.hidden), .answer-btn'));
  }

  /**
   * Format milliseconds as a human-readable string (e.g., "0.9s" or "1.8s").
   */
  function formatMs(ms) {
    return (ms / 1000).toFixed(1) + 's';
  }

  /**
   * Enter the calibration intro screen.
   */
  function startCalibration() {
    if (mode.onStart) mode.onStart();
    state = engineCalibrationIntro(state);
    render();
  }

  /**
   * Called when user clicks Start on the intro screen — begin trials.
   */
  function beginCalibrationTrials() {
    const buttons = getCalibrationButtons();
    if (buttons.length < 2) {
      stop();
      return;
    }

    state = engineCalibrating(state);
    render();

    calibrationCleanup = runCalibration({
      buttons,
      els,
      container,
      onComplete: (median) => {
        calibrationCleanup = null;
        if (!Number.isFinite(median) || median <= 0) {
          // Invalid measurement — abort to idle
          stop();
          return;
        }
        const baseline = Math.round(median);
        applyBaseline(baseline);
        state = engineCalibrationResults(state, baseline);
        render();
      },
    });
  }

  /**
   * Called when user clicks Done on the results screen — return to idle.
   */
  function finishCalibration() {
    stop();
  }

  // --- Progress tracking ---

  function computeProgress() {
    const items = mode.getEnabledItems();
    let mastered = 0;
    for (const id of items) {
      const recall = selector.getRecall(id);
      if (recall !== null && recall >= selector.getConfig().recallThreshold) {
        mastered++;
      }
    }
    return { masteredCount: mastered, totalEnabledCount: items.length };
  }

  // --- Engine lifecycle ---

  function nextQuestion() {
    const items = mode.getEnabledItems();
    if (items.length === 0) return;

    const nextItemId = selector.selectNext(items);
    state = engineNextQuestion(state, nextItemId, Date.now());
    render();
    mode.presentQuestion(state.currentItemId);
    startCountdown();
  }

  function submitAnswer(input) {
    if (state.phase !== 'active' || state.answered) return;

    const responseTime = Date.now() - state.questionStartTime;

    if (countdownInterval) {
      clearInterval(countdownInterval);
      countdownInterval = null;
    }

    const result = mode.checkAnswer(state.currentItemId, input);
    selector.recordResponse(state.currentItemId, responseTime, result.correct);

    state = engineSubmitAnswer(state, result.correct, result.correctAnswer, responseTime);

    // Check if all enabled items are mastered
    const allMastered = selector.checkAllMastered(mode.getEnabledItems());
    state = engineUpdateMasteryAfterAnswer(state, allMastered);

    // Update progress
    const progress = computeProgress();
    state = engineUpdateProgress(state, progress.masteredCount, progress.totalEnabledCount);

    render();

    // Let the mode react to the answer (e.g., highlight correct position)
    if (mode.onAnswer) {
      mode.onAnswer(state.currentItemId, result, responseTime);
    }
  }

  function start() {
    state = engineStart(state);
    // Call onStart first so modes can tear down their idle UI (e.g. heatmap)
    // before the engine renders the quiz UI state.
    if (mode.onStart) mode.onStart();

    // Compute initial progress
    const progress = computeProgress();
    state = engineUpdateProgress(state, progress.masteredCount, progress.totalEnabledCount);

    render();
    startElapsedTimer();
    nextQuestion();
  }

  function recalibrate() {
    startCalibration();
  }

  function updateIdleMessage() {
    if (state.phase !== 'idle') return;
    const items = mode.getEnabledItems();
    state = engineUpdateIdleMessage(
      state,
      selector.checkAllMastered(items),
      selector.checkNeedsReview(items),
    );
    render();
  }

  function stop() {
    if (calibrationCleanup) {
      calibrationCleanup();
      calibrationCleanup = null;
    }
    if (countdownInterval) {
      clearInterval(countdownInterval);
      countdownInterval = null;
    }
    stopElapsedTimer();
    state = engineStop(state);
    render();   // render() clears calibrationContentEl when phase is idle
    if (mode.onStop) mode.onStop();
    updateIdleMessage();
  }

  // Keyboard handler — uses pure routing, delegates mode-specific keys
  function handleKeydown(e) {
    const routed = engineRouteKey(state, e.key);
    switch (routed.action) {
      case 'stop':
        stop();
        break;
      case 'next':
        e.preventDefault();
        nextQuestion();
        break;
      case 'delegate':
        if (mode.handleKey) mode.handleKey(e, { submitAnswer });
        break;
      case 'ignore':
        break;
    }
  }

  // Tap-to-advance handler
  function handleClick(e) {
    if (state.phase !== 'active' || !state.answered) return;
    if (e.target.closest('.answer-btn, .note-btn, .quiz-controls, .string-toggle')) return;
    nextQuestion();
  }

  // Attach event listeners: keyboard on document (global), clicks on container
  function attach() {
    document.addEventListener('keydown', handleKeydown);
    container.addEventListener('click', handleClick);
  }

  function detach() {
    document.removeEventListener('keydown', handleKeydown);
    container.removeEventListener('click', handleClick);
  }

  // Wire up recalibrate button
  if (els.recalibrateBtn) {
    els.recalibrateBtn.addEventListener('click', recalibrate);
  }

  // Wire up quiz header close button
  if (els.quizHeaderClose) {
    els.quizHeaderClose.addEventListener('click', stop);
  }

  /**
   * If no baseline exists, show the calibration intro screen.
   * Called by modes from their activate() hook.
   */
  function showCalibrationIfNeeded() {
    if (!motorBaseline && state.phase === 'idle') {
      startCalibration();
    }
  }

  return {
    start,
    stop,
    recalibrate,
    showCalibrationIfNeeded,
    submitAnswer,
    nextQuestion,
    attach,
    detach,
    updateIdleMessage,
    get isActive() { return state.phase === 'active'; },
    get isRunning() { return state.phase !== 'idle'; },
    get isAnswered() { return state.answered; },
    get baseline() { return motorBaseline; },
    selector,
    storage,
    els,
  };
}

// Stats display helpers: shared color functions, table rendering for lookup
// modes, and heatmap grid rendering for math modes.
//
// ES module — main.ts strips "export" keywords for browser inlining.
// Depends on globals (browser): NOTES, INTERVALS

// --- Heatmap color scale (read from CSS custom properties) ---

var _heatmapColors = null;

function cssVar(name) {
  try {
    var val = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    if (val) return val;
  } catch (_) { /* Node.js / test environment — fall through to default */ }
  return '';
}

function heatmapColors() {
  if (!_heatmapColors) {
    _heatmapColors = {
      none:  cssVar('--heatmap-none')  || '#ddd',
      level: [
        cssVar('--heatmap-1') || 'hsl(0, 60%, 65%)',
        cssVar('--heatmap-2') || 'hsl(30, 60%, 65%)',
        cssVar('--heatmap-3') || 'hsl(50, 60%, 65%)',
        cssVar('--heatmap-4') || 'hsl(80, 60%, 65%)',
        cssVar('--heatmap-5') || 'hsl(120, 60%, 65%)',
      ],
    };
  }
  return _heatmapColors;
}

// Labels for the retention legend (index matches heatmapColors().level)
var RETENTION_LABELS = [
  'Needs work (&lt;20%)',
  'Fading (&gt;20%)',
  'Getting there (&gt;40%)',
  'Solid (&gt;60%)',
  'Automatic (&gt;80%)',
];

function getAutomaticityColor(auto) {
  var c = heatmapColors();
  if (auto === null) return c.none;
  if (auto > 0.8) return c.level[4];
  if (auto > 0.6) return c.level[3];
  if (auto > 0.4) return c.level[2];
  if (auto > 0.2) return c.level[1];
  return c.level[0];
}

function getSpeedHeatmapColor(ms, baseline) {
  var c = heatmapColors();
  if (ms === null) return c.none;
  var b = baseline || 1000;
  if (ms < b * 1.5) return c.level[4];
  if (ms < b * 3.0) return c.level[3];
  if (ms < b * 4.5) return c.level[2];
  if (ms < b * 6.0) return c.level[1];
  return c.level[0];
}

function getStatsCellColor(selector, itemId, statsMode, baseline) {
  if (statsMode === 'retention') {
    return getAutomaticityColor(selector.getAutomaticity(itemId));
  }
  var stats = selector.getStats(itemId);
  return getSpeedHeatmapColor(stats ? stats.ewma : null, baseline);
}

/**
 * Average stats across multiple item IDs (e.g. both + and − directions).
 * Only items that have data contribute to the average.
 * Returns grey when no items have data.
 */
function getStatsCellColorMerged(selector, itemIds, statsMode, baseline) {
  if (typeof itemIds === 'string') return getStatsCellColor(selector, itemIds, statsMode, baseline);
  if (statsMode === 'retention') {
    var sum = 0, count = 0;
    for (var i = 0; i < itemIds.length; i++) {
      var a = selector.getAutomaticity(itemIds[i]);
      if (a !== null) { sum += a; count++; }
    }
    return getAutomaticityColor(count > 0 ? sum / count : null);
  }
  var sum2 = 0, count2 = 0;
  for (var j = 0; j < itemIds.length; j++) {
    var stats = selector.getStats(itemIds[j]);
    if (stats && stats.ewma != null) { sum2 += stats.ewma; count2++; }
  }
  return getSpeedHeatmapColor(count2 > 0 ? sum2 / count2 : null, baseline);
}

/**
 * Render a reference table for bidirectional lookup modes.
 *
 * @param {object}   selector  - adaptive selector instance
 * @param {Array}    rows      - [{ label, sublabel, _colHeader, fwdItemId, revItemId }]
 * @param {string}   fwdHeader - column header for forward direction (e.g. "N\u2192#")
 * @param {string}   revHeader - column header for reverse direction (e.g. "#\u2192N")
 * @param {string}   statsMode - 'retention' | 'speed'
 * @param {Element}  containerEl
 * @param {number}   [baseline] - motor baseline in ms (optional)
 */
function renderStatsTable(selector, rows, fwdHeader, revHeader, statsMode, containerEl, baseline) {
  if (!rows || rows.length === 0) { containerEl.innerHTML = ''; return; }
  var html = '<table class="stats-table"><thead><tr>';
  html += '<th>' + rows[0]._colHeader + '</th><th>#</th>';
  html += '<th>' + fwdHeader + '</th><th>' + revHeader + '</th>';
  html += '</tr></thead><tbody>';

  for (var i = 0; i < rows.length; i++) {
    var row = rows[i];
    var fwdColor = getStatsCellColor(selector, row.fwdItemId, statsMode, baseline);
    var revColor = getStatsCellColor(selector, row.revItemId, statsMode, baseline);
    html += '<tr>';
    html += '<td>' + row.label + '</td>';
    html += '<td>' + row.sublabel + '</td>';
    html += '<td class="stats-cell" style="background:' + fwdColor + '"></td>';
    html += '<td class="stats-cell" style="background:' + revColor + '"></td>';
    html += '</tr>';
  }

  html += '</tbody></table>';
  containerEl.innerHTML = html;
}

/**
 * Render a heatmap grid for math modes (12 notes x 11 offsets/intervals).
 *
 * @param {object}   selector    - adaptive selector instance
 * @param {Array}    colLabels   - column header labels (e.g. ["1","2",...] or ["m2","M2",...])
 * @param {Function} getItemId   - (noteName, colIndex) => itemId string or array of strings
 * @param {string}   statsMode   - 'retention' | 'speed'
 * @param {Element}  containerEl
 * @param {Array}    [notes]     - optional notes array (defaults to global NOTES)
 * @param {number}   [baseline]  - motor baseline in ms (optional)
 */
function renderStatsGrid(selector, colLabels, getItemId, statsMode, containerEl, notes, baseline) {
  var noteList = notes || NOTES;
  var html = '<table class="stats-grid"><thead><tr><th></th>';
  for (var c = 0; c < colLabels.length; c++) {
    html += '<th>' + colLabels[c] + '</th>';
  }
  html += '</tr></thead><tbody>';

  for (var n = 0; n < noteList.length; n++) {
    var note = noteList[n];
    html += '<tr><td class="stats-grid-row-label">' + (note.displayName || note.name) + '</td>';
    for (var i = 0; i < colLabels.length; i++) {
      var itemId = getItemId(note.name, i);
      var color = Array.isArray(itemId)
        ? getStatsCellColorMerged(selector, itemId, statsMode, baseline)
        : getStatsCellColor(selector, itemId, statsMode, baseline);
      html += '<td class="stats-cell" style="background:' + color + '"></td>';
    }
    html += '</tr>';
  }

  html += '</tbody></table>';
  containerEl.innerHTML = html;
}

/**
 * Create shared stats toggle controls for a mode.
 * Manages Recall/Speed toggle state, button wiring, show/hide of stats container.
 *
 * @param {Element}  container - mode's root container element
 * @param {Function} renderFn  - (mode, statsContainerEl) => void; populates stats content
 * @returns {{ show(mode), hide(), mode }}
 */
function createStatsControls(container, renderFn) {
  var statsMode = null;
  var statsContainer = container.querySelector('.stats-container');

  function show(mode) {
    statsMode = mode;
    statsContainer.innerHTML = '';
    renderFn(mode, statsContainer);
    statsContainer.style.display = '';
    container.querySelectorAll('.stats-toggle-btn').forEach(function(b) {
      b.classList.toggle('active', b.dataset.mode === mode);
    });
  }

  function hide() {
    statsMode = null;
    statsContainer.style.display = 'none';
    statsContainer.innerHTML = '';
  }

  // Wire toggle buttons
  container.querySelectorAll('.stats-toggle-btn').forEach(function(btn) {
    btn.addEventListener('click', function() { show(btn.dataset.mode); });
  });

  return {
    show: show,
    hide: hide,
    get mode() { return statsMode; },
  };
}

function formatThreshold(ms) {
  var s = ms / 1000;
  return s % 1 === 0 ? s + 's' : s.toFixed(1) + 's';
}

/**
 * Build a legend item HTML for a single heatmap level.
 */
function legendItem(color, label) {
  return '<div class="legend-item"><div class="legend-swatch" style="background:' + color + '"></div>' + label + '</div>';
}

/**
 * Build a shared legend HTML string.
 */
function buildStatsLegend(statsMode, baseline) {
  var c = heatmapColors();
  var html = '<div class="heatmap-legend active">';
  html += legendItem(c.none, 'No data');

  if (statsMode === 'retention') {
    for (var i = c.level.length - 1; i >= 0; i--) {
      html += legendItem(c.level[i], RETENTION_LABELS[i]);
    }
  } else {
    var b = baseline || 1000;
    var t1 = formatThreshold(b * 1.5);
    var t2 = formatThreshold(b * 3);
    var t3 = formatThreshold(b * 4.5);
    var t4 = formatThreshold(b * 6);
    html += legendItem(c.level[4], '&lt; ' + t1);
    html += legendItem(c.level[3], t1 + '\u2013' + t2);
    html += legendItem(c.level[2], t2 + '\u2013' + t3);
    html += legendItem(c.level[1], t3 + '\u2013' + t4);
    html += legendItem(c.level[0], '&ge; ' + t4);
  }

  html += '</div>';
  return html;
}

// Shared recommendation algorithm: consolidate-before-expanding.
// Extracts the duplicated logic from quiz-fretboard.js, quiz-semitone-math.js,
// and quiz-interval-math.js into a single pure function.
//
// This is an ES module — exports stripped for browser inlining.
// Pure w.r.t. configuration: callers pass `config.expansionThreshold`.

/**
 * Compute which subsets (strings, distance groups) to recommend and enable.
 *
 * @param {object} selector - Adaptive selector (provides getStringRecommendations)
 * @param {Array} allIndices - All subset indices (e.g. [0,1,2,3,4,5] for strings)
 * @param {function} getItemIds - (index) => array of item IDs for that subset
 * @param {object} config - Must have expansionThreshold
 * @param {object} [options]
 * @param {function} [options.sortUnstarted] - Comparator for unstarted items.
 *   If provided, sorts unstarted before picking next expansion.
 *   Default: no sort (use first unstarted as-is).
 * @returns {{ recommended: Set, enabled: Set|null }}
 *   recommended: indices to highlight with orange borders
 *   enabled: indices to auto-select, or null if no data (first launch)
 */
function computeRecommendations(selector, allIndices, getItemIds, config, options) {
  const sortUnstarted = options && options.sortUnstarted;
  const recs = selector.getStringRecommendations(allIndices, getItemIds);

  const started = recs.filter(r => r.unseenCount < r.totalCount);
  const unstarted = recs.filter(r => r.unseenCount === r.totalCount);

  if (started.length === 0) {
    return { recommended: new Set(), enabled: null };
  }

  const totalSeen = started.reduce((sum, r) => sum + (r.masteredCount + r.dueCount), 0);
  const totalMastered = started.reduce((sum, r) => sum + r.masteredCount, 0);
  const consolidatedRatio = totalSeen > 0 ? totalMastered / totalSeen : 0;

  const startedByWork = [...started].sort(
    (a, b) => (b.dueCount + b.unseenCount) - (a.dueCount + a.unseenCount)
  );

  const workCounts = startedByWork.map(r => r.dueCount + r.unseenCount);
  const medianWork = workCounts[Math.floor(workCounts.length / 2)];
  const recommended = new Set();
  const enabled = new Set();
  for (const r of startedByWork) {
    if (r.dueCount + r.unseenCount > medianWork) {
      recommended.add(r.string);
      enabled.add(r.string);
    }
  }
  if (enabled.size === 0) {
    recommended.add(startedByWork[0].string);
    enabled.add(startedByWork[0].string);
  }

  if (consolidatedRatio >= config.expansionThreshold && unstarted.length > 0) {
    const sorted = sortUnstarted ? [...unstarted].sort(sortUnstarted) : unstarted;
    recommended.add(sorted[0].string);
    enabled.add(sorted[0].string);
  }

  return { recommended, enabled };
}

// Pure state and helpers for the fretboard quiz mode.
// No DOM, no side effects — testable logic extracted from quiz-fretboard.js.
// ES module — exports stripped for browser inlining.
//
// In browser, depends on globals: NOTES, NATURAL_NOTES, STRING_OFFSETS,
// noteMatchesInput (from music-data.js, concatenated before this file).
// Tests import these from music-data.js directly.

/**
 * Toggle a string in the enabled set. Returns a new Set.
 * Ensures at least one string is always enabled.
 * @param {Set<number>} enabledStrings
 * @param {number} string - 0-5
 * @returns {Set<number>}
 */
function toggleFretboardString(enabledStrings, string) {
  const next = new Set(enabledStrings);
  if (next.has(string)) {
    if (next.size > 1) next.delete(string);
  } else {
    next.add(string);
  }
  return next;
}

/**
 * Create fretboard helpers bound to music data.
 * The factory pattern avoids import/global issues — in browser the globals
 * are passed in; in tests the imported values are passed.
 *
 * @param {{ notes: Array, naturalNotes: string[], stringOffsets: number[],
 *           noteMatchesInput: function }} musicData
 */
function createFretboardHelpers(musicData) {
  const noteNames = musicData.notes.map(n => n.name);

  /**
   * Compute the note name at a given fretboard position.
   * @param {number} string - 0-5
   * @param {number} fret - 0-12
   * @returns {string} note name (e.g. 'C#')
   */
  function getNoteAtPosition(string, fret) {
    const offset = musicData.stringOffsets[string];
    return noteNames[(offset + fret) % 12];
  }

  /**
   * Parse a fretboard item ID into question state.
   * @param {string} itemId - e.g. '3-5'
   * @returns {{ currentString: number, currentFret: number, currentNote: string }}
   */
  function parseFretboardItem(itemId) {
    const [s, f] = itemId.split('-').map(Number);
    return {
      currentString: s,
      currentFret: f,
      currentNote: getNoteAtPosition(s, f),
    };
  }

  /**
   * Check if an input matches the current fretboard question.
   * @param {string} currentNote - the correct note name
   * @param {string} input - user's answer
   * @returns {{ correct: boolean, correctAnswer: string }}
   */
  function checkFretboardAnswer(currentNote, input) {
    const note = musicData.notes.find(n => n.name === currentNote);
    const correct = !!(note && musicData.noteMatchesInput(note, input));
    return { correct, correctAnswer: currentNote };
  }

  /**
   * Compute the list of enabled item IDs.
   * @param {Set<number>} enabledStrings
   * @param {boolean} naturalsOnly
   * @returns {string[]}
   */
  function getFretboardEnabledItems(enabledStrings, naturalsOnly) {
    const items = [];
    for (const s of enabledStrings) {
      for (let f = 0; f < 13; f++) {
        const note = getNoteAtPosition(s, f);
        if (!naturalsOnly || musicData.naturalNotes.includes(note)) {
          items.push(s + '-' + f);
        }
      }
    }
    return items;
  }

  /**
   * Compute item IDs for a specific string (used for recommendations).
   * @param {number} string - 0-5
   * @param {boolean} naturalsOnly
   * @returns {string[]}
   */
  function getItemIdsForString(string, naturalsOnly) {
    const items = [];
    for (let f = 0; f < 13; f++) {
      const note = getNoteAtPosition(string, f);
      if (!naturalsOnly || musicData.naturalNotes.includes(note)) {
        items.push(string + '-' + f);
      }
    }
    return items;
  }

  return {
    getNoteAtPosition,
    parseFretboardItem,
    checkFretboardAnswer,
    getFretboardEnabledItems,
    getItemIdsForString,
  };
}

// Fretboard quiz mode: identify the note at a highlighted fretboard position.
// Plugs into the shared quiz engine via the mode interface.
//
// Depends on globals: NOTES, NATURAL_NOTES, STRING_OFFSETS,
// noteMatchesInput, createQuizEngine, createNoteKeyHandler, DEFAULT_CONFIG,
// getAutomaticityColor, getSpeedHeatmapColor, buildStatsLegend,
// computeRecommendations, createFretboardHelpers, toggleFretboardString

function createFretboardMode() {
  const container = document.getElementById('mode-fretboard');
  const STRINGS_KEY = 'fretboard_enabledStrings';
  let enabledStrings = new Set([5]); // Default: low E only
  let naturalsOnly = true;
  let recommendedStrings = new Set();
  // --- Pure helpers (from quiz-fretboard-state.js) ---

  const fb = createFretboardHelpers({
    notes: NOTES,
    naturalNotes: NATURAL_NOTES,
    stringOffsets: STRING_OFFSETS,
    noteMatchesInput,
  });

  // --- Colors (from CSS custom properties, cached once) ---
  const _cs = getComputedStyle(document.documentElement);
  const COLOR_HIGHLIGHT = _cs.getPropertyValue('--color-highlight').trim();
  const COLOR_SUCCESS = _cs.getPropertyValue('--color-success').trim();
  const COLOR_ERROR = _cs.getPropertyValue('--color-error').trim();

  // --- SVG helpers ---

  function highlightCircle(string, fret, color) {
    const circle = container.querySelector(
      `circle[data-string="${string}"][data-fret="${fret}"]`
    );
    if (circle) circle.setAttribute('fill', color);
  }

  function showNoteText(string, fret) {
    const text = container.querySelector(
      `text[data-string="${string}"][data-fret="${fret}"]`
    );
    if (text) text.textContent = fb.getNoteAtPosition(string, fret);
  }

  function clearAll() {
    container.querySelectorAll('.note-circle').forEach(c => c.setAttribute('fill', 'white'));
    container.querySelectorAll('.note-text').forEach(t => t.textContent = '');
  }

  // --- String toggles ---

  function loadEnabledStrings() {
    const saved = localStorage.getItem(STRINGS_KEY);
    if (saved) {
      try { enabledStrings = new Set(JSON.parse(saved)); } catch {}
    }
    updateStringToggles();
  }

  function saveEnabledStrings() {
    localStorage.setItem(STRINGS_KEY, JSON.stringify([...enabledStrings]));
  }

  function updateStringToggles() {
    container.querySelectorAll('.string-toggle').forEach(btn => {
      const s = parseInt(btn.dataset.string);
      btn.classList.toggle('active', enabledStrings.has(s));
      btn.classList.toggle('recommended', recommendedStrings.has(s));
    });
  }

  function toggleString(s) {
    enabledStrings = toggleFretboardString(enabledStrings, s);
    saveEnabledStrings();
    refreshUI();
  }

  // --- Heatmap ---
  // Color functions: getAutomaticityColor, getSpeedHeatmapColor from stats-display.js

  const statsControls = createStatsControls(container, (mode, el) => {
    el.innerHTML = buildStatsLegend(mode, engine.baseline);
    if (mode === 'retention') {
      for (let s = 0; s <= 5; s++) {
        for (let f = 0; f < 13; f++) {
          const auto = engine.selector.getAutomaticity(`${s}-${f}`);
          highlightCircle(s, f, getAutomaticityColor(auto));
          showNoteText(s, f);
        }
      }
    } else {
      for (let s = 0; s <= 5; s++) {
        for (let f = 0; f < 13; f++) {
          const stats = engine.selector.getStats(`${s}-${f}`);
          const ewma = stats ? stats.ewma : null;
          highlightCircle(s, f, getSpeedHeatmapColor(ewma, engine.baseline));
          showNoteText(s, f);
        }
      }
    }
  });

  function hideHeatmap() {
    statsControls.hide();
    clearAll();
  }

  // --- Stats ---

  function updateStats(selector) {
    const statsEl = container.querySelector('.stats');
    if (statsEl) statsEl.textContent = '';
  }

  // --- Recommendations ---

  function updateRecommendations(selector) {
    const allStrings = [0, 1, 2, 3, 4, 5];
    const result = computeRecommendations(
      selector, allStrings,
      (s) => fb.getItemIdsForString(s, naturalsOnly),
      DEFAULT_CONFIG, {}
    );
    recommendedStrings = result.recommended;
    updateStringToggles();
  }

  function applyRecommendations(selector) {
    const allStrings = [0, 1, 2, 3, 4, 5];
    const result = computeRecommendations(
      selector, allStrings,
      (s) => fb.getItemIdsForString(s, naturalsOnly),
      DEFAULT_CONFIG, {}
    );
    recommendedStrings = result.recommended;
    if (result.enabled) {
      enabledStrings = result.enabled;
      saveEnabledStrings();
    }
    updateStringToggles();
  }

  function refreshUI() {
    updateRecommendations(engine.selector);
    engine.updateIdleMessage();
  }

  // --- Accidental buttons ---

  function updateAccidentalButtons() {
    container.querySelectorAll('.note-btn.accidental').forEach(btn => {
      btn.classList.toggle('hidden', naturalsOnly);
    });
  }

  // --- Quiz mode interface ---

  // Track current question for answer checking
  let currentString = null;
  let currentFret = null;
  let currentNote = null;

  const mode = {
    id: 'fretboard',
    name: 'Fretboard',
    storageNamespace: 'fretboard',

    getEnabledItems() {
      return fb.getFretboardEnabledItems(enabledStrings, naturalsOnly);
    },

    presentQuestion(itemId) {
      clearAll();
      const q = fb.parseFretboardItem(itemId);
      currentString = q.currentString;
      currentFret = q.currentFret;
      currentNote = q.currentNote;
      highlightCircle(q.currentString, q.currentFret, COLOR_HIGHLIGHT);
    },

    checkAnswer(itemId, input) {
      return fb.checkFretboardAnswer(currentNote, input);
    },

    onAnswer(itemId, result, responseTime) {
      if (result.correct) {
        highlightCircle(currentString, currentFret, COLOR_SUCCESS);
      } else {
        highlightCircle(currentString, currentFret, COLOR_ERROR);
      }
      showNoteText(currentString, currentFret);
    },

    onStart() {
      container.classList.add('quiz-active');
      noteKeyHandler.reset();
      if (statsControls.mode) hideHeatmap();
      updateStats(engine.selector);
    },

    onStop() {
      container.classList.remove('quiz-active');
      noteKeyHandler.reset();
      clearAll();
      updateStats(engine.selector);
      statsControls.show('retention');
      refreshUI();
    },

    handleKey(e, { submitAnswer }) {
      return noteKeyHandler.handleKey(e);
    },

    getCalibrationButtons() {
      // Use only visible note buttons (respects naturals-only setting)
      return Array.from(container.querySelectorAll('.note-btn:not(.hidden)'));
    },
  };

  // Create engine
  const engine = createQuizEngine(mode, container);

  // Keyboard handler via shared helper (replaces inline state machine)
  const noteKeyHandler = createNoteKeyHandler(
    (input) => engine.submitAnswer(input),
    () => !naturalsOnly
  );

  // Pre-cache all positions
  const allItemIds = [];
  for (let s = 0; s < 6; s++) {
    for (let f = 0; f < 13; f++) {
      allItemIds.push(`${s}-${f}`);
    }
  }
  engine.storage.preload(allItemIds);

  // --- Wire up DOM ---

  function init() {
    loadEnabledStrings();

    // String toggle handlers
    container.querySelectorAll('.string-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        toggleString(parseInt(btn.dataset.string));
      });
    });

    // Note button handlers
    container.querySelectorAll('.note-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.note);
      });
    });

    // Naturals-only toggle
    const naturalsCheckbox = container.querySelector('#naturals-only');
    if (naturalsCheckbox) {
      naturalsCheckbox.addEventListener('change', (e) => {
        naturalsOnly = e.target.checked;
        updateAccidentalButtons();
        refreshUI();
      });
    }

    // Start/stop buttons
    const startBtn = container.querySelector('.start-btn');
    const stopBtn = container.querySelector('.stop-btn');
    if (startBtn) startBtn.addEventListener('click', () => engine.start());
    if (stopBtn) stopBtn.addEventListener('click', () => engine.stop());

    applyRecommendations(engine.selector);
    updateAccidentalButtons();
    updateStats(engine.selector);
    statsControls.show('retention');
  }

  return {
    mode,
    engine,
    init,
    activate() {
      engine.attach();
      refreshUI();
      engine.showCalibrationIfNeeded();
    },
    deactivate() {
      if (engine.isRunning) engine.stop();
      engine.detach();
      noteKeyHandler.reset();
    },
  };
}

// Speed Tap quiz mode: tap all positions of a given note as fast as possible.
// Uses its own quiz loop (not createQuizEngine) since rounds need multi-tap input.
//
// Depends on globals: NOTES, NATURAL_NOTES, STRING_OFFSETS,
// createAdaptiveSelector, createLocalStorageAdapter, updateModeStats,
// getAutomaticityColor, getSpeedHeatmapColor, buildStatsLegend,
// runCalibration, getCalibrationThresholds, deriveScaledConfig,
// computeMedian, DEFAULT_CONFIG

function createSpeedTapMode() {
  const container = document.getElementById('mode-speedTap');
  const NAMESPACE = 'speedTap';
  const BASELINE_KEY = 'motorBaseline_button';

  let naturalsOnly = true;
  let active = false;
  let roundActive = false;
  let currentNote = null;
  let targetPositions = []; // [{string, fret}]
  let foundPositions = new Set(); // "s-f" strings
  let roundStartTime = null;
  let timerInterval = null;
  let wrongFlashTimeouts = new Set();
  const noteNames = NOTES.map(n => n.name);

  // --- Adaptive system ---
  // Speed tap rounds involve finding 6-8 positions, so response times are
  // much higher than single-tap modes. Adjust config accordingly.
  const SPEED_TAP_BASE_CONFIG = Object.assign({}, DEFAULT_CONFIG, {
    minTime: 4000,             // can't tap 6-8 positions in < 4s
    automaticityTarget: 12000, // 12s → speedScore 0.5 (decent pace)
    maxResponseTime: 30000,    // allow tracking up to 30s rounds
  });

  const storage = createLocalStorageAdapter(NAMESPACE);
  const selector = createAdaptiveSelector(storage, SPEED_TAP_BASE_CONFIG);

  // --- Motor baseline ---

  let motorBaseline = null;
  let calibrationCleanup = null;
  let calibrationContentEl = null;
  let calibPhase = 'none'; // 'none' | 'intro' | 'calibrating' | 'results'

  // Load stored baseline at init
  const storedBaseline = localStorage.getItem(BASELINE_KEY);
  if (storedBaseline) {
    const parsed = parseInt(storedBaseline, 10);
    if (parsed > 0) {
      motorBaseline = parsed;
      selector.updateConfig(deriveScaledConfig(motorBaseline, SPEED_TAP_BASE_CONFIG));
    }
  }

  function applyBaseline(baseline) {
    motorBaseline = baseline;
    localStorage.setItem(BASELINE_KEY, String(baseline));
    selector.updateConfig(deriveScaledConfig(baseline, SPEED_TAP_BASE_CONFIG));
  }

  function preloadStats() {
    for (const note of NOTES) {
      storage.getStats(note.name);
    }
  }

  // --- Note/position helpers ---

  function getNoteAtPosition(string, fret) {
    const offset = STRING_OFFSETS[string];
    return noteNames[(offset + fret) % 12];
  }

  function getPositionsForNote(noteName) {
    const positions = [];
    for (let s = 0; s < 6; s++) {
      for (let f = 0; f <= 12; f++) {
        if (getNoteAtPosition(s, f) === noteName) {
          positions.push({ string: s, fret: f });
        }
      }
    }
    return positions;
  }

  function getEnabledItems() {
    return naturalsOnly ? NATURAL_NOTES.slice() : NOTES.map(n => n.name);
  }

  // --- Colors (from CSS custom properties, cached once) ---
  const _cs = getComputedStyle(document.documentElement);
  const COLOR_SUCCESS = _cs.getPropertyValue('--color-success').trim();
  const COLOR_ERROR = _cs.getPropertyValue('--color-error').trim();

  // --- SVG helpers ---

  function highlightCircle(string, fret, color) {
    const circle = container.querySelector(
      `circle[data-string="${string}"][data-fret="${fret}"]`
    );
    if (circle) circle.setAttribute('fill', color);
  }

  function showNoteText(string, fret) {
    const text = container.querySelector(
      `text[data-string="${string}"][data-fret="${fret}"]`
    );
    if (text) text.textContent = getNoteAtPosition(string, fret);
  }

  function clearNoteText(string, fret) {
    const text = container.querySelector(
      `text[data-string="${string}"][data-fret="${fret}"]`
    );
    if (text) text.textContent = '';
  }

  function clearAll() {
    container.querySelectorAll('.note-circle').forEach(c => c.setAttribute('fill', 'white'));
    container.querySelectorAll('.note-text').forEach(t => t.textContent = '');
  }

  // --- Note stats view ---

  const statsControls = createStatsControls(container, (mode, el) => {
    // Always show all 12 notes regardless of naturalsOnly setting
    let html = '<table class="stats-table speed-tap-stats"><thead><tr>';
    for (const note of NOTES) {
      html += '<th>' + note.displayName + '</th>';
    }
    html += '</tr></thead><tbody><tr>';
    for (const note of NOTES) {
      if (mode === 'retention') {
        const auto = selector.getAutomaticity(note.name);
        html += '<td class="stats-cell" style="background:' + getAutomaticityColor(auto) + '"></td>';
      } else {
        // Normalize to per-position time so the color scale makes sense
        // for multi-tap rounds (6-8 positions per note).
        const stats = selector.getStats(note.name);
        const posCount = getPositionsForNote(note.name).length;
        const perPosMs = stats ? stats.ewma / posCount : null;
        html += '<td class="stats-cell" style="background:' + getSpeedHeatmapColor(perPosMs) + '"></td>';
      }
    }
    html += '</tr></tbody></table>';

    html += buildStatsLegend(mode);

    el.innerHTML = html;
  });


  // --- DOM references ---

  const els = {
    prompt: container.querySelector('.speed-tap-prompt'),
    progress: container.querySelector('.speed-tap-progress'),
    timer: container.querySelector('.speed-tap-timer'),
    feedback: container.querySelector('.feedback'),
    hint: container.querySelector('.hint'),
    timeDisplay: container.querySelector('.time-display'),
    startBtn: container.querySelector('.start-btn'),
    stopBtn: container.querySelector('.stop-btn'),
    recalibrateBtn: container.querySelector('.recalibrate-btn'),
    statsToggle: container.querySelector('.stats-toggle'),
    stats: container.querySelector('.stats'),
    quizArea: container.querySelector('.quiz-area'),
    fretboardWrapper: container.querySelector('.fretboard-wrapper'),
    statsControls: container.querySelector('.stats-controls'),
    quizHeader: container.querySelector('.quiz-header'),
    quizHeaderClose: container.querySelector('.quiz-header-close'),
    sessionStats: container.querySelector('.session-stats'),
    questionCountEl: container.querySelector('.question-count'),
    elapsedTimeEl: container.querySelector('.elapsed-time'),
    progressBar: container.querySelector('.progress-bar'),
    progressFill: container.querySelector('.progress-fill'),
    progressText: container.querySelector('.progress-text'),
  };

  // --- Session tracking ---

  let sessionStartTime = null;
  let roundCount = 0;
  let sessionElapsedInterval = null;

  function formatElapsedTime(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    if (minutes === 0) return seconds + 's';
    return minutes + 'm ' + (seconds < 10 ? '0' : '') + seconds + 's';
  }

  function updateSessionElapsed() {
    if (!sessionStartTime || !els.elapsedTimeEl) return;
    els.elapsedTimeEl.textContent = formatElapsedTime(Date.now() - sessionStartTime);
  }

  function startSessionTimer() {
    if (sessionElapsedInterval) {
      clearInterval(sessionElapsedInterval);
    }
    sessionStartTime = Date.now();
    roundCount = 0;
    updateRoundCount();
    updateSessionElapsed();
    sessionElapsedInterval = setInterval(updateSessionElapsed, 1000);
  }

  function stopSessionTimer() {
    if (sessionElapsedInterval) {
      clearInterval(sessionElapsedInterval);
      sessionElapsedInterval = null;
    }
    sessionStartTime = null;
  }

  function updateRoundCount() {
    if (els.questionCountEl) {
      els.questionCountEl.textContent = roundCount;
    }
  }

  function computeProgress() {
    const items = getEnabledItems();
    let mastered = 0;
    const cfg = selector.getConfig();
    for (const id of items) {
      const recall = selector.getRecall(id);
      if (recall !== null && recall >= cfg.recallThreshold) {
        mastered++;
      }
    }
    return { masteredCount: mastered, totalEnabledCount: items.length };
  }

  function renderProgress() {
    const progress = computeProgress();
    if (els.progressFill) {
      const pct = progress.totalEnabledCount > 0
        ? Math.round((progress.masteredCount / progress.totalEnabledCount) * 100)
        : 0;
      els.progressFill.style.width = pct + '%';
    }
    if (els.progressText) {
      els.progressText.textContent = progress.masteredCount + ' / ' + progress.totalEnabledCount;
    }
  }

  // --- Timer ---

  function startTimer() {
    roundStartTime = Date.now();
    updateTimerDisplay();
    timerInterval = setInterval(updateTimerDisplay, 100);
  }

  function stopTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
  }

  function updateTimerDisplay() {
    if (!roundStartTime || !els.timer) return;
    const elapsed = Date.now() - roundStartTime;
    els.timer.textContent = (elapsed / 1000).toFixed(1) + 's';
  }

  // --- Display updates ---

  function updateProgress() {
    if (els.progress) {
      els.progress.textContent = foundPositions.size + ' / ' + targetPositions.length;
    }
  }

  function updateStats() {
    updateModeStats(selector, getEnabledItems(), els.stats);
  }

  // --- Calibration ---

  function formatMs(ms) {
    return (ms / 1000).toFixed(1) + 's';
  }

  function clearCalibrationContent() {
    if (calibrationContentEl) {
      calibrationContentEl.remove();
      calibrationContentEl = null;
    }
    // Remove close button
    const closeBtn = container.querySelector('.calibration-close-btn');
    if (closeBtn) closeBtn.remove();
  }

  function renderCalibrationClose() {
    if (!container.querySelector('.calibration-close-btn')) {
      const closeBtn = document.createElement('button');
      closeBtn.className = 'calibration-close-btn';
      closeBtn.textContent = '\u00D7';
      closeBtn.setAttribute('aria-label', 'Close speed check');
      closeBtn.addEventListener('click', stopCalibration);
      if (els.quizArea) {
        els.quizArea.style.position = 'relative';
        els.quizArea.appendChild(closeBtn);
      }
    }
  }

  function getCalibrationButtons() {
    return Array.from(container.querySelectorAll('.answer-btn-note'));
  }

  function startCalibration() {
    calibPhase = 'intro';
    container.classList.add('calibrating');

    // Mark calibration button container
    const buttons = getCalibrationButtons();
    if (buttons.length > 0) {
      const parent = buttons[0].closest('.answer-buttons');
      if (parent) parent.classList.add('calibration-active');
    }

    if (els.quizArea) els.quizArea.classList.add('active');
    if (els.startBtn) els.startBtn.style.display = 'none';
    if (els.stopBtn) els.stopBtn.style.display = 'none';
    if (els.recalibrateBtn) els.recalibrateBtn.style.display = 'none';
    if (els.feedback) {
      els.feedback.textContent = 'Quick Speed Check';
      els.feedback.className = 'feedback';
    }
    if (els.hint) els.hint.textContent = "We\u2019ll measure your tap speed to set personalized targets. Tap each highlighted button as fast as you can \u2014 10 taps total.";
    if (els.timeDisplay) els.timeDisplay.textContent = '';

    // Enable calibration buttons
    container.querySelectorAll('.answer-btn').forEach(btn => {
      btn.disabled = false;
      btn.style.pointerEvents = '';
    });

    clearCalibrationContent();
    const btn = document.createElement('button');
    btn.textContent = 'Start';
    btn.className = 'calibration-action-btn';
    btn.addEventListener('click', beginCalibrationTrials);
    calibrationContentEl = btn;
    if (els.hint && els.hint.parentNode) {
      els.hint.parentNode.insertBefore(btn, els.hint.nextSibling);
    }
    renderCalibrationClose();
  }

  function beginCalibrationTrials() {
    const buttons = getCalibrationButtons();
    if (buttons.length < 2) {
      stopCalibration();
      return;
    }

    calibPhase = 'calibrating';
    if (els.feedback) {
      els.feedback.textContent = 'Speed check!';
      els.feedback.className = 'feedback';
    }
    if (els.hint) els.hint.textContent = 'Tap the highlighted button as fast as you can';

    clearCalibrationContent();
    renderCalibrationClose();

    calibrationCleanup = runCalibration({
      buttons,
      els: { feedback: els.feedback, hint: els.hint, timeDisplay: els.timeDisplay },
      container,
      onComplete: (median) => {
        calibrationCleanup = null;
        if (!Number.isFinite(median) || median <= 0) {
          stopCalibration();
          return;
        }
        const baseline = Math.round(median);
        applyBaseline(baseline);
        showCalibrationResults(baseline);
      },
    });
  }

  function showCalibrationResults(baseline) {
    calibPhase = 'results';
    if (els.feedback) {
      els.feedback.textContent = 'Speed Check Complete';
      els.feedback.className = 'feedback';
    }
    if (els.hint) els.hint.textContent = '';
    if (els.timeDisplay) els.timeDisplay.textContent = '';

    // Disable buttons during results
    container.querySelectorAll('.answer-btn').forEach(btn => {
      btn.disabled = true;
      btn.style.pointerEvents = 'none';
    });

    clearCalibrationContent();

    const div = document.createElement('div');
    div.className = 'calibration-results';

    const baselineP = document.createElement('p');
    baselineP.className = 'calibration-baseline';
    baselineP.textContent = 'Your baseline response time: ' + formatMs(baseline);
    div.appendChild(baselineP);

    const thresholds = getCalibrationThresholds(baseline);
    const table = document.createElement('table');
    table.className = 'calibration-thresholds';
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    ['Speed', 'Response time', 'Meaning'].forEach((text) => {
      const th = document.createElement('th');
      th.textContent = text;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    const tbody = document.createElement('tbody');
    thresholds.forEach((t) => {
      const tr = document.createElement('tr');
      const tdLabel = document.createElement('td');
      tdLabel.textContent = t.label;
      tr.appendChild(tdLabel);
      const tdTime = document.createElement('td');
      tdTime.textContent = t.maxMs !== null ? '< ' + formatMs(t.maxMs) : '> ' + formatMs(thresholds[thresholds.length - 2].maxMs);
      tr.appendChild(tdTime);
      const tdMeaning = document.createElement('td');
      tdMeaning.textContent = t.meaning;
      tr.appendChild(tdMeaning);
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    div.appendChild(table);

    const doneBtn = document.createElement('button');
    doneBtn.textContent = 'Done';
    doneBtn.className = 'calibration-action-btn';
    doneBtn.addEventListener('click', stopCalibration);
    div.appendChild(doneBtn);

    calibrationContentEl = div;
    if (els.hint && els.hint.parentNode) {
      els.hint.parentNode.insertBefore(div, els.hint.nextSibling);
    }
    renderCalibrationClose();
  }

  function stopCalibration() {
    if (calibrationCleanup) {
      calibrationCleanup();
      calibrationCleanup = null;
    }
    calibPhase = 'none';
    clearCalibrationContent();
    container.classList.remove('calibrating');
    const activeEl = container.querySelector('.calibration-active');
    if (activeEl) activeEl.classList.remove('calibration-active');

    // Reset to idle state
    if (els.quizArea) els.quizArea.classList.remove('active');
    if (els.feedback) {
      els.feedback.textContent = '';
      els.feedback.className = 'feedback';
    }
    if (els.hint) els.hint.textContent = '';
    if (els.timeDisplay) els.timeDisplay.textContent = '';
    if (els.fretboardWrapper) els.fretboardWrapper.style.display = 'none';
    if (els.statsControls) els.statsControls.style.display = '';
    if (els.startBtn) els.startBtn.style.display = 'inline';
    if (els.stopBtn) els.stopBtn.style.display = 'none';
    if (els.recalibrateBtn) {
      els.recalibrateBtn.style.display = motorBaseline ? 'inline' : 'none';
    }
    if (els.quizHeader) els.quizHeader.style.display = 'none';
    if (els.sessionStats) els.sessionStats.style.display = 'none';
    if (els.progressBar) els.progressBar.style.display = 'none';

    // Disable answer buttons
    container.querySelectorAll('.answer-btn').forEach(btn => {
      btn.disabled = true;
      btn.style.pointerEvents = 'none';
    });

    updateStats();
    statsControls.show('retention');
  }

  function showCalibrationIfNeeded() {
    if (!motorBaseline && !active && calibPhase === 'none') {
      startCalibration();
    }
  }

  // --- Round logic ---

  function nextRound() {
    wrongFlashTimeouts.forEach(t => clearTimeout(t));
    wrongFlashTimeouts.clear();
    clearAll();

    const items = getEnabledItems();
    if (items.length === 0) return;

    currentNote = selector.selectNext(items);
    targetPositions = getPositionsForNote(currentNote);
    foundPositions = new Set();
    roundActive = true;

    if (els.prompt) {
      const note = NOTES.find(n => n.name === currentNote);
      els.prompt.textContent = 'Tap all ' + (note ? note.displayName : currentNote);
    }
    if (els.feedback) {
      els.feedback.textContent = '';
      els.feedback.className = 'feedback';
    }
    if (els.hint) els.hint.textContent = '';

    updateProgress();
    startTimer();
  }

  function completeRound() {
    roundActive = false;
    stopTimer();

    const elapsed = Date.now() - roundStartTime;
    selector.recordResponse(currentNote, elapsed, true);

    roundCount++;
    updateRoundCount();
    renderProgress();

    if (els.feedback) {
      els.feedback.textContent = (elapsed / 1000).toFixed(1) + 's';
      els.feedback.className = 'feedback correct';
    }
    if (els.hint) els.hint.textContent = 'Tap anywhere or press Space for next';

    updateStats();
  }

  // --- Circle tap handling ---

  function handleCircleTap(string, fret) {
    if (!active || !roundActive) return;

    const key = string + '-' + fret;
    if (foundPositions.has(key)) return;

    const tappedNote = getNoteAtPosition(string, fret);

    if (tappedNote === currentNote) {
      foundPositions.add(key);
      highlightCircle(string, fret, COLOR_SUCCESS);
      showNoteText(string, fret);
      updateProgress();

      if (foundPositions.size === targetPositions.length) {
        completeRound();
      }
    } else {
      // Wrong tap — flash red, show actual note, then reset
      highlightCircle(string, fret, COLOR_ERROR);
      showNoteText(string, fret);

      const timeout = setTimeout(() => {
        wrongFlashTimeouts.delete(timeout);
        if (!foundPositions.has(key)) {
          highlightCircle(string, fret, 'white');
          clearNoteText(string, fret);
        }
      }, 800);
      wrongFlashTimeouts.add(timeout);
    }
  }

  // --- Event handlers ---

  function handleFretboardClick(e) {
    if (e.target.closest('.quiz-controls, .setting-group')) return;

    // During calibration, ignore fretboard clicks
    if (calibPhase !== 'none') return;

    if (active && roundActive) {
      const target = e.target.closest('circle[data-string][data-fret]') ||
                     e.target.closest('text[data-string][data-fret]');
      if (target) {
        handleCircleTap(parseInt(target.dataset.string), parseInt(target.dataset.fret));
      }
      return;
    }

    // After round complete, tap anywhere to advance
    if (active && !roundActive && currentNote !== null) {
      nextRound();
    }
  }

  function handleKeydown(e) {
    // Handle Escape during calibration
    if (calibPhase !== 'none') {
      if (e.key === 'Escape') {
        stopCalibration();
      }
      return;
    }

    if (!active) return;

    if (e.key === 'Escape') {
      stop();
      return;
    }

    if ((e.key === ' ' || e.key === 'Enter') && !roundActive && currentNote !== null) {
      e.preventDefault();
      nextRound();
    }
  }

  // --- Start / stop ---

  function start() {
    active = true;
    if (statsControls.mode) statsControls.hide();
    if (els.fretboardWrapper) els.fretboardWrapper.style.display = '';
    if (els.statsControls) els.statsControls.style.display = 'none';
    if (els.startBtn) els.startBtn.style.display = 'none';
    if (els.stopBtn) els.stopBtn.style.display = 'none';
    if (els.recalibrateBtn) els.recalibrateBtn.style.display = 'none';
    if (els.quizArea) els.quizArea.classList.add('active');
    if (els.quizHeader) els.quizHeader.style.display = 'flex';
    if (els.sessionStats) els.sessionStats.style.display = 'flex';
    if (els.progressBar) els.progressBar.style.display = '';
    startSessionTimer();
    renderProgress();
    nextRound();
  }

  function stop() {
    active = false;
    roundActive = false;
    stopTimer();
    stopSessionTimer();
    wrongFlashTimeouts.forEach(t => clearTimeout(t));
    wrongFlashTimeouts.clear();
    clearAll();

    currentNote = null;
    roundStartTime = null;

    if (els.prompt) els.prompt.textContent = '';
    if (els.progress) els.progress.textContent = '';
    if (els.timer) els.timer.textContent = '';
    if (els.feedback) {
      els.feedback.textContent = '';
      els.feedback.className = 'feedback';
    }
    if (els.hint) els.hint.textContent = '';

    if (els.fretboardWrapper) els.fretboardWrapper.style.display = 'none';
    if (els.statsControls) els.statsControls.style.display = '';
    if (els.startBtn) els.startBtn.style.display = 'inline';
    if (els.stopBtn) els.stopBtn.style.display = 'none';
    if (els.recalibrateBtn) {
      els.recalibrateBtn.style.display = motorBaseline ? 'inline' : 'none';
    }
    if (els.quizArea) els.quizArea.classList.remove('active');
    if (els.quizHeader) els.quizHeader.style.display = 'none';
    if (els.sessionStats) els.sessionStats.style.display = 'none';
    if (els.progressBar) els.progressBar.style.display = 'none';

    updateStats();
    statsControls.show('retention');
  }

  // --- Lifecycle ---

  function attach() {
    document.addEventListener('keydown', handleKeydown);
    container.addEventListener('click', handleFretboardClick);
  }

  function detach() {
    document.removeEventListener('keydown', handleKeydown);
    container.removeEventListener('click', handleFretboardClick);
  }

  function init() {
    preloadStats();

    const naturalsCheckbox = container.querySelector('#speed-tap-naturals-only');
    if (naturalsCheckbox) {
      naturalsCheckbox.addEventListener('change', (e) => {
        naturalsOnly = e.target.checked;
      });
    }

    if (els.startBtn) els.startBtn.addEventListener('click', () => start());
    if (els.stopBtn) els.stopBtn.addEventListener('click', () => stop());
    if (els.quizHeaderClose) els.quizHeaderClose.addEventListener('click', () => stop());
    if (els.recalibrateBtn) {
      els.recalibrateBtn.addEventListener('click', () => startCalibration());
    }

    if (els.fretboardWrapper) els.fretboardWrapper.style.display = 'none';
    if (els.recalibrateBtn) {
      els.recalibrateBtn.style.display = motorBaseline ? 'inline' : 'none';
    }
    updateStats();
    statsControls.show('retention');
  }

  return {
    init,
    activate() {
      attach();
      showCalibrationIfNeeded();
    },
    deactivate() {
      if (calibPhase !== 'none') stopCalibration();
      if (active) stop();
      detach();
    },
  };
}

// Note Semitones quiz mode: bidirectional note <-> semitone number.
// Forward: "C# = ?" -> 1, Reverse: "3 = ?" -> D#/Eb
// 24 items total (12 notes x 2 directions).
//
// Depends on globals: NOTES, createQuizEngine, createNoteKeyHandler,
// updateModeStats, renderStatsTable, buildStatsLegend

function createNoteSemitonesMode() {
  const container = document.getElementById('mode-noteSemitones');

  // Build item list: 12 notes x 2 directions
  const ALL_ITEMS = [];
  for (const note of NOTES) {
    ALL_ITEMS.push(note.name + ':fwd'); // note -> number
    ALL_ITEMS.push(note.name + ':rev'); // number -> note
  }

  function parseItem(itemId) {
    const [noteName, dir] = itemId.split(':');
    const note = NOTES.find(n => n.name === noteName);
    return { note, dir };
  }

  let currentItem = null;

  // Build row definitions for the stats table
  function getTableRows() {
    return NOTES.map(note => ({
      label: note.displayName,
      sublabel: String(note.num),
      _colHeader: 'Note',
      fwdItemId: note.name + ':fwd',
      revItemId: note.name + ':rev',
    }));
  }

  const statsControls = createStatsControls(container, function(mode, el) {
    const tableDiv = document.createElement('div');
    el.appendChild(tableDiv);
    renderStatsTable(engine.selector, getTableRows(), 'N\u2192#', '#\u2192N', mode, tableDiv, engine.baseline);
    const legendDiv = document.createElement('div');
    legendDiv.innerHTML = buildStatsLegend(mode, engine.baseline);
    el.appendChild(legendDiv);
  });

  const mode = {
    id: 'noteSemitones',
    name: 'Note \u2194 Semitones',
    storageNamespace: 'noteSemitones',

    getEnabledItems() {
      return ALL_ITEMS;
    },

    presentQuestion(itemId) {
      currentItem = parseItem(itemId);
      const prompt = container.querySelector('.quiz-prompt');
      const noteButtons = container.querySelector('.answer-buttons-notes');
      const numButtons = container.querySelector('.answer-buttons-numbers');

      if (currentItem.dir === 'fwd') {
        // Show note, answer is number 0-11
        prompt.textContent = currentItem.note.displayName + ' = ?';
        noteButtons.style.display = 'none';
        numButtons.style.display = '';
      } else {
        // Show number, answer is note
        prompt.textContent = currentItem.note.num + ' = ?';
        noteButtons.style.display = '';
        numButtons.style.display = 'none';
      }
    },

    checkAnswer(itemId, input) {
      if (currentItem.dir === 'fwd') {
        const correct = parseInt(input, 10) === currentItem.note.num;
        return { correct, correctAnswer: String(currentItem.note.num) };
      } else {
        const correct = noteMatchesInput(currentItem.note, input);
        return { correct, correctAnswer: currentItem.note.displayName };
      }
    },

    onStart() {
      noteKeyHandler.reset();
      if (pendingDigitTimeout) clearTimeout(pendingDigitTimeout);
      pendingDigit = null;
      pendingDigitTimeout = null;
      statsControls.hide();
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    },

    onStop() {
      noteKeyHandler.reset();
      if (pendingDigitTimeout) clearTimeout(pendingDigitTimeout);
      pendingDigit = null;
      pendingDigitTimeout = null;
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
      statsControls.show('retention');
    },

    handleKey(e, { submitAnswer }) {
      if (currentItem.dir === 'rev') {
        return noteKeyHandler.handleKey(e);
      }
      // Forward: number keys 0-9 for semitone answer
      if (e.key >= '0' && e.key <= '9') {
        e.preventDefault();
        // Handle two-digit: 10, 11
        if (pendingDigit !== null) {
          const num = pendingDigit * 10 + parseInt(e.key);
          clearTimeout(pendingDigitTimeout);
          pendingDigit = null;
          pendingDigitTimeout = null;
          if (num <= 11) {
            submitAnswer(String(num));
          }
          return true;
        }
        const d = parseInt(e.key);
        if (d >= 2) {
          // Can only be single digit (2-9)
          submitAnswer(String(d));
        } else {
          // 0 or 1 — could be start of 10 or 11
          pendingDigit = d;
          pendingDigitTimeout = setTimeout(() => {
            submitAnswer(String(pendingDigit));
            pendingDigit = null;
            pendingDigitTimeout = null;
          }, 400);
        }
        return true;
      }
      return false;
    },

    getCalibrationButtons() {
      return Array.from(container.querySelectorAll('.answer-btn-note'));
    },
  };

  let pendingDigit = null;
  let pendingDigitTimeout = null;

  const engine = createQuizEngine(mode, container);
  engine.storage.preload(ALL_ITEMS);

  const noteKeyHandler = createNoteKeyHandler(
    (input) => engine.submitAnswer(input),
    () => true
  );

  function init() {
    // Note answer buttons
    container.querySelectorAll('.answer-btn-note').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.note);
      });
    });

    // Number answer buttons
    container.querySelectorAll('.answer-btn-num').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.num);
      });
    });

    // Start/stop
    container.querySelector('.start-btn').addEventListener('click', () => engine.start());
    container.querySelector('.stop-btn').addEventListener('click', () => engine.stop());

    updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    statsControls.show('retention');
  }

  return {
    mode,
    engine,
    init,
    activate() { engine.attach(); engine.updateIdleMessage(); engine.showCalibrationIfNeeded(); },
    deactivate() {
      if (engine.isRunning) engine.stop();
      engine.detach();
      noteKeyHandler.reset();
      if (pendingDigitTimeout) clearTimeout(pendingDigitTimeout);
      pendingDigit = null;
    },
  };
}

// Interval Semitones quiz mode: bidirectional interval <-> semitone number.
// Forward: "minor 3rd = ?" -> 3, Reverse: "7 = ?" -> Perfect 5th
// 24 items total (12 intervals x 2 directions).
//
// Depends on globals: INTERVALS, intervalMatchesInput, createQuizEngine,
// updateModeStats, renderStatsTable, buildStatsLegend

function createIntervalSemitonesMode() {
  const container = document.getElementById('mode-intervalSemitones');

  // Build item list: 12 intervals x 2 directions
  const ALL_ITEMS = [];
  for (const interval of INTERVALS) {
    ALL_ITEMS.push(interval.abbrev + ':fwd'); // interval -> number
    ALL_ITEMS.push(interval.abbrev + ':rev'); // number -> interval
  }

  function parseItem(itemId) {
    const [abbrev, dir] = itemId.split(':');
    const interval = INTERVALS.find(i => i.abbrev === abbrev);
    return { interval, dir };
  }

  let currentItem = null;

  function getTableRows() {
    return INTERVALS.map(interval => ({
      label: interval.abbrev,
      sublabel: String(interval.num),
      _colHeader: 'Interval',
      fwdItemId: interval.abbrev + ':fwd',
      revItemId: interval.abbrev + ':rev',
    }));
  }

  const statsControls = createStatsControls(container, function(mode, el) {
    const tableDiv = document.createElement('div');
    el.appendChild(tableDiv);
    renderStatsTable(engine.selector, getTableRows(), 'I\u2192#', '#\u2192I', mode, tableDiv, engine.baseline);
    const legendDiv = document.createElement('div');
    legendDiv.innerHTML = buildStatsLegend(mode, engine.baseline);
    el.appendChild(legendDiv);
  });

  const mode = {
    id: 'intervalSemitones',
    name: 'Interval \u2194 Semitones',
    storageNamespace: 'intervalSemitones',

    getEnabledItems() {
      return ALL_ITEMS;
    },

    presentQuestion(itemId) {
      currentItem = parseItem(itemId);
      const prompt = container.querySelector('.quiz-prompt');
      const intervalButtons = container.querySelector('.answer-buttons-intervals');
      const numButtons = container.querySelector('.answer-buttons-numbers');

      if (currentItem.dir === 'fwd') {
        // Show interval name, answer is number 1-12
        prompt.textContent = currentItem.interval.name + ' = ?';
        intervalButtons.style.display = 'none';
        numButtons.style.display = '';
      } else {
        // Show number, answer is interval
        prompt.textContent = currentItem.interval.num + ' = ?';
        intervalButtons.style.display = '';
        numButtons.style.display = 'none';
      }
    },

    checkAnswer(itemId, input) {
      if (currentItem.dir === 'fwd') {
        const correct = parseInt(input, 10) === currentItem.interval.num;
        return { correct, correctAnswer: String(currentItem.interval.num) };
      } else {
        const correct = intervalMatchesInput(currentItem.interval, input);
        return { correct, correctAnswer: currentItem.interval.abbrev };
      }
    },

    onStart() {
      if (pendingDigitTimeout) clearTimeout(pendingDigitTimeout);
      pendingDigit = null;
      pendingDigitTimeout = null;
      statsControls.hide();
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    },

    onStop() {
      if (pendingDigitTimeout) clearTimeout(pendingDigitTimeout);
      pendingDigit = null;
      pendingDigitTimeout = null;
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
      statsControls.show('retention');
    },

    handleKey(e, { submitAnswer }) {
      // Keyboard: number keys for forward, no keyboard for interval buttons
      if (currentItem.dir === 'fwd') {
        if (e.key >= '0' && e.key <= '9') {
          e.preventDefault();
          if (pendingDigit !== null) {
            const num = pendingDigit * 10 + parseInt(e.key);
            clearTimeout(pendingDigitTimeout);
            pendingDigit = null;
            pendingDigitTimeout = null;
            if (num >= 1 && num <= 12) {
              submitAnswer(String(num));
            }
            return true;
          }
          const d = parseInt(e.key);
          if (d >= 2 && d <= 9) {
            submitAnswer(String(d));
          } else {
            // 0 or 1 — could be 10, 11, 12
            pendingDigit = d;
            pendingDigitTimeout = setTimeout(() => {
              if (pendingDigit >= 1) submitAnswer(String(pendingDigit));
              pendingDigit = null;
              pendingDigitTimeout = null;
            }, 400);
          }
          return true;
        }
      }
      return false;
    },

    getCalibrationButtons() {
      return Array.from(container.querySelectorAll('.answer-btn-interval'));
    },
  };

  let pendingDigit = null;
  let pendingDigitTimeout = null;

  const engine = createQuizEngine(mode, container);
  engine.storage.preload(ALL_ITEMS);

  function init() {
    // Interval answer buttons
    container.querySelectorAll('.answer-btn-interval').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.interval);
      });
    });

    // Number answer buttons
    container.querySelectorAll('.answer-btn-num').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.num);
      });
    });

    // Start/stop
    container.querySelector('.start-btn').addEventListener('click', () => engine.start());
    container.querySelector('.stop-btn').addEventListener('click', () => engine.stop());

    updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    statsControls.show('retention');
  }

  return {
    mode,
    engine,
    init,
    activate() { engine.attach(); engine.updateIdleMessage(); engine.showCalibrationIfNeeded(); },
    deactivate() {
      if (engine.isRunning) engine.stop();
      engine.detach();
      if (pendingDigitTimeout) clearTimeout(pendingDigitTimeout);
      pendingDigit = null;
    },
  };
}

// Semitone Math quiz mode: note +/- semitone count = note.
// "C + 3 = ?" -> D#/Eb,  "G - 5 = ?" -> D
// 264 items: 12 notes x 11 intervals (1-11) x 2 directions (+/-).
// Grouped by semitone count into 6 distance groups for progressive unlocking.
//
// Depends on globals: NOTES, noteAdd, noteSub, noteMatchesInput,
// pickAccidentalName, createQuizEngine, createNoteKeyHandler,
// updateModeStats, renderStatsGrid, buildStatsLegend, DEFAULT_CONFIG,
// computeRecommendations

function createSemitoneMathMode() {
  const container = document.getElementById('mode-semitoneMath');
  const GROUPS_KEY = 'semitoneMath_enabledGroups';

  // Distance groups: pairs of semitone distances
  const DISTANCE_GROUPS = [
    { distances: [1, 2],   label: '1,2' },
    { distances: [3, 4],   label: '3,4' },
    { distances: [5, 6],   label: '5,6' },
    { distances: [7, 8],   label: '7,8' },
    { distances: [9, 10],  label: '9,10' },
    { distances: [11],     label: '11' },
  ];

  let enabledGroups = new Set([0]); // Default: first group only
  let recommendedGroups = new Set();

  // Build full item list (for preloading & stats display)
  const ALL_ITEMS = [];
  for (const note of NOTES) {
    for (let s = 1; s <= 11; s++) {
      ALL_ITEMS.push(note.name + '+' + s);
      ALL_ITEMS.push(note.name + '-' + s);
    }
  }

  function parseItem(itemId) {
    const match = itemId.match(/^([A-G]#?)([+-])(\d+)$/);
    const noteName = match[1];
    const op = match[2];
    const semitones = parseInt(match[3]);
    const note = NOTES.find(n => n.name === noteName);
    const answer = op === '+' ? noteAdd(note.num, semitones) : noteSub(note.num, semitones);
    return { note, op, semitones, answer };
  }

  // --- Distance group helpers ---

  function getItemIdsForGroup(groupIndex) {
    const distances = DISTANCE_GROUPS[groupIndex].distances;
    const items = [];
    for (const note of NOTES) {
      for (const d of distances) {
        items.push(note.name + '+' + d);
        items.push(note.name + '-' + d);
      }
    }
    return items;
  }

  function loadEnabledGroups() {
    const saved = localStorage.getItem(GROUPS_KEY);
    if (saved) {
      try { enabledGroups = new Set(JSON.parse(saved)); } catch {}
    }
    updateGroupToggles();
  }

  function saveEnabledGroups() {
    localStorage.setItem(GROUPS_KEY, JSON.stringify([...enabledGroups]));
  }

  function updateGroupToggles() {
    container.querySelectorAll('.distance-toggle').forEach(btn => {
      const g = parseInt(btn.dataset.group);
      btn.classList.toggle('active', enabledGroups.has(g));
      btn.classList.toggle('recommended', recommendedGroups.has(g));
    });
  }

  const recsOptions = { sortUnstarted: (a, b) => a.string - b.string };

  function updateRecommendations(selector) {
    const allGroups = DISTANCE_GROUPS.map((_, i) => i);
    const result = computeRecommendations(selector, allGroups, getItemIdsForGroup, DEFAULT_CONFIG, recsOptions);
    recommendedGroups = result.recommended;
    updateGroupToggles();
  }

  function applyRecommendations(selector) {
    const allGroups = DISTANCE_GROUPS.map((_, i) => i);
    const result = computeRecommendations(selector, allGroups, getItemIdsForGroup, DEFAULT_CONFIG, recsOptions);
    recommendedGroups = result.recommended;
    if (result.enabled) {
      enabledGroups = result.enabled;
      saveEnabledGroups();
    }
    updateGroupToggles();
  }

  function refreshUI() {
    updateRecommendations(engine.selector);
    engine.updateIdleMessage();
  }

  function toggleGroup(g) {
    if (enabledGroups.has(g)) {
      if (enabledGroups.size > 1) enabledGroups.delete(g);
    } else {
      enabledGroups.add(g);
    }
    saveEnabledGroups();
    refreshUI();
  }

  // --- Stats ---

  let currentItem = null;

  const statsControls = createStatsControls(container, (mode, el) => {
    const colLabels = [];
    for (let s = 1; s <= 11; s++) colLabels.push(String(s));
    const gridDiv = document.createElement('div');
    gridDiv.className = 'stats-grid-wrapper';
    el.appendChild(gridDiv);
    renderStatsGrid(engine.selector, colLabels, (noteName, colIdx) => {
      const n = colIdx + 1;
      return [noteName + '+' + n, noteName + '-' + n];
    }, mode, gridDiv, undefined, engine.baseline);
    const legendDiv = document.createElement('div');
    legendDiv.innerHTML = buildStatsLegend(mode, engine.baseline);
    el.appendChild(legendDiv);
  });


  // --- Quiz mode interface ---

  const mode = {
    id: 'semitoneMath',
    name: 'Semitone Math',
    storageNamespace: 'semitoneMath',

    getEnabledItems() {
      const items = [];
      for (const g of enabledGroups) {
        items.push(...getItemIdsForGroup(g));
      }
      return items;
    },

    presentQuestion(itemId) {
      currentItem = parseItem(itemId);
      currentItem.useFlats = currentItem.op === '-'; // sharps ascending, flats descending
      const prompt = container.querySelector('.quiz-prompt');
      const noteName = pickAccidentalName(currentItem.note.displayName, currentItem.useFlats);
      prompt.textContent = noteName + ' ' + currentItem.op + ' ' + currentItem.semitones + ' = ?';
      container.querySelectorAll('.answer-btn-note').forEach(btn => {
        const note = NOTES.find(n => n.name === btn.dataset.note);
        if (note) btn.textContent = pickAccidentalName(note.displayName, currentItem.useFlats);
      });
    },

    checkAnswer(itemId, input) {
      const correct = noteMatchesInput(currentItem.answer, input);
      return { correct, correctAnswer: pickAccidentalName(currentItem.answer.displayName, currentItem.useFlats) };
    },

    onStart() {
      noteKeyHandler.reset();
      statsControls.hide();
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    },

    onStop() {
      noteKeyHandler.reset();
      container.querySelectorAll('.answer-btn-note').forEach(btn => {
        const note = NOTES.find(n => n.name === btn.dataset.note);
        if (note) btn.textContent = note.displayName;
      });
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
      statsControls.show('retention');
      refreshUI();
    },

    handleKey(e, { submitAnswer }) {
      return noteKeyHandler.handleKey(e);
    },

    getCalibrationButtons() {
      return Array.from(container.querySelectorAll('.answer-btn-note'));
    },
  };

  const engine = createQuizEngine(mode, container);
  engine.storage.preload(ALL_ITEMS);

  const noteKeyHandler = createNoteKeyHandler(
    (input) => engine.submitAnswer(input),
    () => true
  );

  function init() {
    // Generate distance group toggle buttons
    const togglesDiv = container.querySelector('.distance-toggles');
    DISTANCE_GROUPS.forEach((group, i) => {
      const btn = document.createElement('button');
      btn.className = 'distance-toggle';
      btn.dataset.group = String(i);
      btn.textContent = group.label;
      btn.addEventListener('click', () => toggleGroup(i));
      togglesDiv.appendChild(btn);
    });

    loadEnabledGroups();

    // Note answer buttons
    container.querySelectorAll('.answer-btn-note').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.note);
      });
    });

    // Start/stop/stats
    container.querySelector('.start-btn').addEventListener('click', () => engine.start());
    container.querySelector('.stop-btn').addEventListener('click', () => engine.stop());

    applyRecommendations(engine.selector);
    updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    statsControls.show('retention');
  }

  return {
    mode,
    engine,
    init,
    activate() { engine.attach(); refreshUI(); engine.showCalibrationIfNeeded(); },
    deactivate() {
      if (engine.isRunning) engine.stop();
      engine.detach();
      noteKeyHandler.reset();
    },
  };
}

// Interval Math quiz mode: note +/- interval = note.
// "C + m3 = ?" -> D#/Eb,  "G - P4 = ?" -> D
// 264 items: 12 notes x 11 intervals (m2-M7) x 2 directions (+/-).
// Excludes octave/P8 (adding 12 semitones gives same note).
// Grouped by interval pair into 6 distance groups for progressive unlocking.
//
// Depends on globals: NOTES, INTERVALS, noteAdd, noteSub,
// noteMatchesInput, pickAccidentalName, createQuizEngine,
// createNoteKeyHandler, updateModeStats, renderStatsGrid,
// buildStatsLegend, DEFAULT_CONFIG, computeRecommendations

function createIntervalMathMode() {
  const container = document.getElementById('mode-intervalMath');
  const GROUPS_KEY = 'intervalMath_enabledGroups';

  // Intervals 1-11 only (no octave)
  const MATH_INTERVALS = INTERVALS.filter(i => i.num >= 1 && i.num <= 11);

  // Distance groups: pairs of intervals by semitone count
  const DISTANCE_GROUPS = [
    { distances: [1, 2],   label: 'm2,M2' },
    { distances: [3, 4],   label: 'm3,M3' },
    { distances: [5, 6],   label: 'P4,TT' },
    { distances: [7, 8],   label: 'P5,m6' },
    { distances: [9, 10],  label: 'M6,m7' },
    { distances: [11],     label: 'M7' },
  ];

  let enabledGroups = new Set([0]); // Default: first group only
  let recommendedGroups = new Set();

  // Build full item list (for preloading & stats display)
  const ALL_ITEMS = [];
  for (const note of NOTES) {
    for (const interval of MATH_INTERVALS) {
      ALL_ITEMS.push(note.name + '+' + interval.abbrev);
      ALL_ITEMS.push(note.name + '-' + interval.abbrev);
    }
  }

  function parseItem(itemId) {
    const match = itemId.match(/^([A-G]#?)([+-])(.+)$/);
    const noteName = match[1];
    const op = match[2];
    const abbrev = match[3];
    const note = NOTES.find(n => n.name === noteName);
    const interval = MATH_INTERVALS.find(i => i.abbrev === abbrev);
    const answer = op === '+' ? noteAdd(note.num, interval.num) : noteSub(note.num, interval.num);
    return { note, op, interval, answer };
  }

  // --- Distance group helpers ---

  function getItemIdsForGroup(groupIndex) {
    const distances = DISTANCE_GROUPS[groupIndex].distances;
    const intervals = MATH_INTERVALS.filter(i => distances.includes(i.num));
    const items = [];
    for (const note of NOTES) {
      for (const interval of intervals) {
        items.push(note.name + '+' + interval.abbrev);
        items.push(note.name + '-' + interval.abbrev);
      }
    }
    return items;
  }

  function loadEnabledGroups() {
    const saved = localStorage.getItem(GROUPS_KEY);
    if (saved) {
      try { enabledGroups = new Set(JSON.parse(saved)); } catch {}
    }
    updateGroupToggles();
  }

  function saveEnabledGroups() {
    localStorage.setItem(GROUPS_KEY, JSON.stringify([...enabledGroups]));
  }

  function updateGroupToggles() {
    container.querySelectorAll('.distance-toggle').forEach(btn => {
      const g = parseInt(btn.dataset.group);
      btn.classList.toggle('active', enabledGroups.has(g));
      btn.classList.toggle('recommended', recommendedGroups.has(g));
    });
  }

  const recsOptions = { sortUnstarted: (a, b) => a.string - b.string };

  function updateRecommendations(selector) {
    const allGroups = DISTANCE_GROUPS.map((_, i) => i);
    const result = computeRecommendations(selector, allGroups, getItemIdsForGroup, DEFAULT_CONFIG, recsOptions);
    recommendedGroups = result.recommended;
    updateGroupToggles();
  }

  function applyRecommendations(selector) {
    const allGroups = DISTANCE_GROUPS.map((_, i) => i);
    const result = computeRecommendations(selector, allGroups, getItemIdsForGroup, DEFAULT_CONFIG, recsOptions);
    recommendedGroups = result.recommended;
    if (result.enabled) {
      enabledGroups = result.enabled;
      saveEnabledGroups();
    }
    updateGroupToggles();
  }

  function refreshUI() {
    updateRecommendations(engine.selector);
    engine.updateIdleMessage();
  }

  function toggleGroup(g) {
    if (enabledGroups.has(g)) {
      if (enabledGroups.size > 1) enabledGroups.delete(g);
    } else {
      enabledGroups.add(g);
    }
    saveEnabledGroups();
    refreshUI();
  }

  // --- Stats ---

  let currentItem = null;

  const statsControls = createStatsControls(container, (mode, el) => {
    const colLabels = MATH_INTERVALS.map(i => i.abbrev);
    const gridDiv = document.createElement('div');
    gridDiv.className = 'stats-grid-wrapper';
    el.appendChild(gridDiv);
    renderStatsGrid(engine.selector, colLabels, (noteName, colIdx) => {
      const abbrev = MATH_INTERVALS[colIdx].abbrev;
      return [noteName + '+' + abbrev, noteName + '-' + abbrev];
    }, mode, gridDiv, undefined, engine.baseline);
    const legendDiv = document.createElement('div');
    legendDiv.innerHTML = buildStatsLegend(mode, engine.baseline);
    el.appendChild(legendDiv);
  });

  // --- Quiz mode interface ---

  const mode = {
    id: 'intervalMath',
    name: 'Interval Math',
    storageNamespace: 'intervalMath',

    getEnabledItems() {
      const items = [];
      for (const g of enabledGroups) {
        items.push(...getItemIdsForGroup(g));
      }
      return items;
    },

    presentQuestion(itemId) {
      currentItem = parseItem(itemId);
      currentItem.useFlats = currentItem.op === '-'; // sharps ascending, flats descending
      const prompt = container.querySelector('.quiz-prompt');
      const noteName = pickAccidentalName(currentItem.note.displayName, currentItem.useFlats);
      prompt.textContent = noteName + ' ' + currentItem.op + ' ' + currentItem.interval.abbrev + ' = ?';
      container.querySelectorAll('.answer-btn-note').forEach(btn => {
        const note = NOTES.find(n => n.name === btn.dataset.note);
        if (note) btn.textContent = pickAccidentalName(note.displayName, currentItem.useFlats);
      });
    },

    checkAnswer(itemId, input) {
      const correct = noteMatchesInput(currentItem.answer, input);
      return { correct, correctAnswer: pickAccidentalName(currentItem.answer.displayName, currentItem.useFlats) };
    },

    onStart() {
      noteKeyHandler.reset();
      statsControls.hide();
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    },

    onStop() {
      noteKeyHandler.reset();
      container.querySelectorAll('.answer-btn-note').forEach(btn => {
        const note = NOTES.find(n => n.name === btn.dataset.note);
        if (note) btn.textContent = note.displayName;
      });
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
      statsControls.show('retention');
      refreshUI();
    },

    handleKey(e, { submitAnswer }) {
      return noteKeyHandler.handleKey(e);
    },

    getCalibrationButtons() {
      return Array.from(container.querySelectorAll('.answer-btn-note'));
    },
  };

  const engine = createQuizEngine(mode, container);
  engine.storage.preload(ALL_ITEMS);

  const noteKeyHandler = createNoteKeyHandler(
    (input) => engine.submitAnswer(input),
    () => true
  );

  function init() {
    // Generate distance group toggle buttons
    const togglesDiv = container.querySelector('.distance-toggles');
    DISTANCE_GROUPS.forEach((group, i) => {
      const btn = document.createElement('button');
      btn.className = 'distance-toggle';
      btn.dataset.group = String(i);
      btn.textContent = group.label;
      btn.addEventListener('click', () => toggleGroup(i));
      togglesDiv.appendChild(btn);
    });

    loadEnabledGroups();

    // Note answer buttons
    container.querySelectorAll('.answer-btn-note').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.note);
      });
    });

    // Start/stop/stats
    container.querySelector('.start-btn').addEventListener('click', () => engine.start());
    container.querySelector('.stop-btn').addEventListener('click', () => engine.stop());

    applyRecommendations(engine.selector);
    updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    statsControls.show('retention');
  }

  return {
    mode,
    engine,
    init,
    activate() { engine.attach(); refreshUI(); engine.showCalibrationIfNeeded(); },
    deactivate() {
      if (engine.isRunning) engine.stop();
      engine.detach();
      noteKeyHandler.reset();
    },
  };
}

// Key Signatures quiz mode: key name <-> accidental count.
// Forward: "D major -> ?" -> "2#", Reverse: "3b -> ?" -> Eb
// 24 items: 12 major keys x 2 directions.
// Grouped by accidental count for progressive unlocking.
//
// Depends on globals: MAJOR_KEYS, keySignatureLabel, keyBySignatureLabel,
// spelledNoteMatchesSemitone, createQuizEngine, createNoteKeyHandler,
// updateModeStats, renderStatsTable, buildStatsLegend, DEFAULT_CONFIG,
// computeRecommendations

function createKeySignaturesMode() {
  const container = document.getElementById('mode-keySignatures');
  const GROUPS_KEY = 'keySignatures_enabledGroups';

  // Group definitions: keys grouped by accidental count
  const KEY_GROUPS = [
    { keys: ['C', 'G', 'F'],     label: '0-1' },
    { keys: ['D', 'Bb'],         label: '2' },
    { keys: ['A', 'Eb'],         label: '3' },
    { keys: ['E', 'Ab'],         label: '4' },
    { keys: ['B', 'Db', 'F#'],   label: '5+' },
  ];

  let enabledGroups = new Set([0, 1]); // Default: groups 0+1
  let recommendedGroups = new Set();

  // Build full item list
  const ALL_ITEMS = [];
  for (const key of MAJOR_KEYS) {
    ALL_ITEMS.push(key.root + ':fwd');
    ALL_ITEMS.push(key.root + ':rev');
  }

  function parseItem(itemId) {
    const [rootName, dir] = itemId.split(':');
    const key = MAJOR_KEYS.find(k => k.root === rootName);
    return { key, dir };
  }

  function getItemIdsForGroup(groupIndex) {
    const roots = KEY_GROUPS[groupIndex].keys;
    const items = [];
    for (const root of roots) {
      items.push(root + ':fwd');
      items.push(root + ':rev');
    }
    return items;
  }

  // --- Group management ---

  function loadEnabledGroups() {
    const saved = localStorage.getItem(GROUPS_KEY);
    if (saved) {
      try { enabledGroups = new Set(JSON.parse(saved)); } catch {}
    }
    updateGroupToggles();
  }

  function saveEnabledGroups() {
    localStorage.setItem(GROUPS_KEY, JSON.stringify([...enabledGroups]));
  }

  function updateGroupToggles() {
    container.querySelectorAll('.distance-toggle').forEach(btn => {
      const g = parseInt(btn.dataset.group);
      btn.classList.toggle('active', enabledGroups.has(g));
      btn.classList.toggle('recommended', recommendedGroups.has(g));
    });
  }

  const recsOptions = { sortUnstarted: (a, b) => a.string - b.string };

  function updateRecommendations(selector) {
    const allGroups = KEY_GROUPS.map((_, i) => i);
    const result = computeRecommendations(selector, allGroups, getItemIdsForGroup, DEFAULT_CONFIG, recsOptions);
    recommendedGroups = result.recommended;
    updateGroupToggles();
  }

  function applyRecommendations(selector) {
    const allGroups = KEY_GROUPS.map((_, i) => i);
    const result = computeRecommendations(selector, allGroups, getItemIdsForGroup, DEFAULT_CONFIG, recsOptions);
    recommendedGroups = result.recommended;
    if (result.enabled) {
      enabledGroups = result.enabled;
      saveEnabledGroups();
    }
    updateGroupToggles();
  }

  function refreshUI() {
    updateRecommendations(engine.selector);
    engine.updateIdleMessage();
  }

  function toggleGroup(g) {
    if (enabledGroups.has(g)) {
      if (enabledGroups.size > 1) enabledGroups.delete(g);
    } else {
      enabledGroups.add(g);
    }
    saveEnabledGroups();
    refreshUI();
  }

  // --- Stats ---

  let currentItem = null;

  function getTableRows() {
    return MAJOR_KEYS.map(key => ({
      label: key.root + ' major',
      sublabel: keySignatureLabel(key),
      _colHeader: 'Key',
      fwdItemId: key.root + ':fwd',
      revItemId: key.root + ':rev',
    }));
  }

  const statsControls = createStatsControls(container, (mode, el) => {
    const tableDiv = document.createElement('div');
    el.appendChild(tableDiv);
    renderStatsTable(engine.selector, getTableRows(), 'Key\u2192Sig', 'Sig\u2192Key', mode, tableDiv, engine.baseline);
    const legendDiv = document.createElement('div');
    legendDiv.innerHTML = buildStatsLegend(mode, engine.baseline);
    el.appendChild(legendDiv);
  });

  // --- Quiz mode interface ---

  let pendingSigDigit = null;
  let pendingSigTimeout = null;

  const mode = {
    id: 'keySignatures',
    name: 'Key Signatures',
    storageNamespace: 'keySignatures',

    getEnabledItems() {
      const items = [];
      for (const g of enabledGroups) {
        items.push(...getItemIdsForGroup(g));
      }
      return items;
    },

    presentQuestion(itemId) {
      currentItem = parseItem(itemId);
      const prompt = container.querySelector('.quiz-prompt');
      const sigButtons = container.querySelector('.answer-buttons-keysig');
      const noteButtons = container.querySelector('.answer-buttons-notes');

      if (currentItem.dir === 'fwd') {
        prompt.textContent = currentItem.key.root + ' major = ?';
        sigButtons.style.display = '';
        noteButtons.style.display = 'none';
      } else {
        const label = keySignatureLabel(currentItem.key);
        prompt.textContent = label + ' major = ?';
        sigButtons.style.display = 'none';
        noteButtons.style.display = '';
      }
    },

    checkAnswer(itemId, input) {
      if (currentItem.dir === 'fwd') {
        const expected = keySignatureLabel(currentItem.key);
        return { correct: input === expected, correctAnswer: expected };
      } else {
        const correct = spelledNoteMatchesSemitone(currentItem.key.root, input);
        return { correct, correctAnswer: currentItem.key.root };
      }
    },

    onStart() {
      noteKeyHandler.reset();
      statsControls.hide();
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    },

    onStop() {
      noteKeyHandler.reset();
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
      statsControls.show('retention');
      refreshUI();
    },

    handleKey(e, { submitAnswer }) {
      if (currentItem.dir === 'rev') {
        return noteKeyHandler.handleKey(e);
      }
      // Forward: number keys for sig selection
      if (e.key >= '0' && e.key <= '7') {
        e.preventDefault();
        if (pendingSigTimeout) clearTimeout(pendingSigTimeout);
        pendingSigDigit = e.key;
        pendingSigTimeout = setTimeout(() => {
          if (pendingSigDigit === '0') {
            submitAnswer('0');
          }
          pendingSigDigit = null;
          pendingSigTimeout = null;
        }, 600);
        return true;
      }
      if (pendingSigDigit !== null && (e.key === '#' || e.key === 'b')) {
        e.preventDefault();
        clearTimeout(pendingSigTimeout);
        const answer = pendingSigDigit + e.key;
        pendingSigDigit = null;
        pendingSigTimeout = null;
        submitAnswer(answer);
        return true;
      }
      return false;
    },

    getCalibrationButtons() {
      return Array.from(container.querySelectorAll('.answer-btn-note'));
    },
  };

  const engine = createQuizEngine(mode, container);
  engine.storage.preload(ALL_ITEMS);

  const noteKeyHandler = createNoteKeyHandler(
    input => engine.submitAnswer(input),
    () => true
  );

  function init() {
    const togglesDiv = container.querySelector('.distance-toggles');
    KEY_GROUPS.forEach((group, i) => {
      const btn = document.createElement('button');
      btn.className = 'distance-toggle';
      btn.dataset.group = String(i);
      btn.textContent = group.label;
      btn.addEventListener('click', () => toggleGroup(i));
      togglesDiv.appendChild(btn);
    });

    loadEnabledGroups();

    container.querySelectorAll('.answer-btn-keysig').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.sig);
      });
    });

    container.querySelectorAll('.answer-btn-note').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.note);
      });
    });

    container.querySelector('.start-btn').addEventListener('click', () => engine.start());
    container.querySelector('.stop-btn').addEventListener('click', () => engine.stop());

    applyRecommendations(engine.selector);
    updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    statsControls.show('retention');
  }

  return {
    mode,
    engine,
    init,
    activate() { engine.attach(); refreshUI(); engine.showCalibrationIfNeeded(); },
    deactivate() {
      if (engine.isRunning) engine.stop();
      engine.detach();
      noteKeyHandler.reset();
      if (pendingSigTimeout) clearTimeout(pendingSigTimeout);
      pendingSigDigit = null;
    },
  };
}

// Scale Degrees quiz mode: key + degree <-> note name.
// Forward: "5th of D major?" -> A, Reverse: "In D major, A is the ?" -> 5th
// 168 items: 12 keys x 7 degrees x 2 directions.
// Grouped by degree (not by key) for progressive unlocking.
//
// Depends on globals: MAJOR_KEYS, getScaleDegreeNote, findScaleDegree,
// spelledNoteMatchesSemitone, NOTES, createQuizEngine, createNoteKeyHandler,
// updateModeStats, renderStatsGrid, buildStatsLegend, DEFAULT_CONFIG,
// computeRecommendations

function createScaleDegreesMode() {
  const container = document.getElementById('mode-scaleDegrees');
  const GROUPS_KEY = 'scaleDegrees_enabledGroups';

  // Groups by degree
  const DEGREE_GROUPS = [
    { degrees: [1, 5], label: '1st,5th' },
    { degrees: [4],    label: '4th' },
    { degrees: [3, 7], label: '3rd,7th' },
    { degrees: [2, 6], label: '2nd,6th' },
  ];

  let enabledGroups = new Set([0]);
  let recommendedGroups = new Set();

  // Build full item list
  const ALL_ITEMS = [];
  for (const key of MAJOR_KEYS) {
    for (let d = 1; d <= 7; d++) {
      ALL_ITEMS.push(key.root + ':' + d + ':fwd');
      ALL_ITEMS.push(key.root + ':' + d + ':rev');
    }
  }

  const DEGREE_LABELS = ['1st', '2nd', '3rd', '4th', '5th', '6th', '7th'];

  function parseItem(itemId) {
    const parts = itemId.split(':');
    const keyRoot = parts[0];
    const degree = parseInt(parts[1]);
    const dir = parts[2];
    const key = MAJOR_KEYS.find(k => k.root === keyRoot);
    const noteName = getScaleDegreeNote(keyRoot, degree);
    return { key, degree, dir, noteName };
  }

  function getItemIdsForGroup(groupIndex) {
    const degrees = DEGREE_GROUPS[groupIndex].degrees;
    const items = [];
    for (const key of MAJOR_KEYS) {
      for (const d of degrees) {
        items.push(key.root + ':' + d + ':fwd');
        items.push(key.root + ':' + d + ':rev');
      }
    }
    return items;
  }

  // --- Group management ---

  function loadEnabledGroups() {
    const saved = localStorage.getItem(GROUPS_KEY);
    if (saved) {
      try { enabledGroups = new Set(JSON.parse(saved)); } catch {}
    }
    updateGroupToggles();
  }

  function saveEnabledGroups() {
    localStorage.setItem(GROUPS_KEY, JSON.stringify([...enabledGroups]));
  }

  function updateGroupToggles() {
    container.querySelectorAll('.distance-toggle').forEach(btn => {
      const g = parseInt(btn.dataset.group);
      btn.classList.toggle('active', enabledGroups.has(g));
      btn.classList.toggle('recommended', recommendedGroups.has(g));
    });
  }

  const recsOptions = { sortUnstarted: (a, b) => a.string - b.string };

  function updateRecommendations(selector) {
    const allGroups = DEGREE_GROUPS.map((_, i) => i);
    const result = computeRecommendations(selector, allGroups, getItemIdsForGroup, DEFAULT_CONFIG, recsOptions);
    recommendedGroups = result.recommended;
    updateGroupToggles();
  }

  function applyRecommendations(selector) {
    const allGroups = DEGREE_GROUPS.map((_, i) => i);
    const result = computeRecommendations(selector, allGroups, getItemIdsForGroup, DEFAULT_CONFIG, recsOptions);
    recommendedGroups = result.recommended;
    if (result.enabled) {
      enabledGroups = result.enabled;
      saveEnabledGroups();
    }
    updateGroupToggles();
  }

  function refreshUI() {
    updateRecommendations(engine.selector);
    engine.updateIdleMessage();
  }

  function toggleGroup(g) {
    if (enabledGroups.has(g)) {
      if (enabledGroups.size > 1) enabledGroups.delete(g);
    } else {
      enabledGroups.add(g);
    }
    saveEnabledGroups();
    refreshUI();
  }

  // --- Stats ---

  let currentItem = null;

  const statsControls = createStatsControls(container, (mode, el) => {
    const colLabels = DEGREE_LABELS;
    const gridDiv = document.createElement('div');
    gridDiv.className = 'stats-grid-wrapper';
    el.appendChild(gridDiv);
    const keyNotes = MAJOR_KEYS.map(k => ({ name: k.root, displayName: k.root }));
    renderStatsGrid(engine.selector, colLabels, (keyRoot, colIdx) => {
      const d = colIdx + 1;
      return [keyRoot + ':' + d + ':fwd', keyRoot + ':' + d + ':rev'];
    }, mode, gridDiv, keyNotes, engine.baseline);
    const legendDiv = document.createElement('div');
    legendDiv.innerHTML = buildStatsLegend(mode, engine.baseline);
    el.appendChild(legendDiv);
  });

  // --- Quiz mode interface ---

  const mode = {
    id: 'scaleDegrees',
    name: 'Scale Degrees',
    storageNamespace: 'scaleDegrees',

    getEnabledItems() {
      const items = [];
      for (const g of enabledGroups) {
        items.push(...getItemIdsForGroup(g));
      }
      return items;
    },

    presentQuestion(itemId) {
      currentItem = parseItem(itemId);
      const prompt = container.querySelector('.quiz-prompt');
      const noteButtons = container.querySelector('.answer-buttons-notes');
      const degreeButtons = container.querySelector('.answer-buttons-degrees');

      if (currentItem.dir === 'fwd') {
        prompt.textContent = DEGREE_LABELS[currentItem.degree - 1] + ' of ' + currentItem.key.root + ' major = ?';
        noteButtons.style.display = '';
        degreeButtons.style.display = 'none';
      } else {
        prompt.textContent = currentItem.key.root + ' major: ' + currentItem.noteName + ' = ?';
        noteButtons.style.display = 'none';
        degreeButtons.style.display = '';
      }
    },

    checkAnswer(itemId, input) {
      if (currentItem.dir === 'fwd') {
        const correct = spelledNoteMatchesSemitone(currentItem.noteName, input);
        return { correct, correctAnswer: currentItem.noteName };
      } else {
        const expectedDegree = String(currentItem.degree);
        return { correct: input === expectedDegree, correctAnswer: DEGREE_LABELS[currentItem.degree - 1] };
      }
    },

    onStart() {
      noteKeyHandler.reset();
      statsControls.hide();
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    },

    onStop() {
      noteKeyHandler.reset();
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
      statsControls.show('retention');
      refreshUI();
    },

    handleKey(e, { submitAnswer }) {
      if (currentItem.dir === 'fwd') {
        return noteKeyHandler.handleKey(e);
      }
      // Reverse: number keys 1-7
      if (e.key >= '1' && e.key <= '7') {
        e.preventDefault();
        submitAnswer(e.key);
        return true;
      }
      return false;
    },

    getCalibrationButtons() {
      return Array.from(container.querySelectorAll('.answer-btn-note'));
    },
  };

  const engine = createQuizEngine(mode, container);
  engine.storage.preload(ALL_ITEMS);

  const noteKeyHandler = createNoteKeyHandler(
    input => engine.submitAnswer(input),
    () => true
  );

  function init() {
    const togglesDiv = container.querySelector('.distance-toggles');
    DEGREE_GROUPS.forEach((group, i) => {
      const btn = document.createElement('button');
      btn.className = 'distance-toggle';
      btn.dataset.group = String(i);
      btn.textContent = group.label;
      btn.addEventListener('click', () => toggleGroup(i));
      togglesDiv.appendChild(btn);
    });

    loadEnabledGroups();

    container.querySelectorAll('.answer-btn-note').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.note);
      });
    });

    container.querySelectorAll('.answer-btn-degree').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.degree);
      });
    });

    container.querySelector('.start-btn').addEventListener('click', () => engine.start());
    container.querySelector('.stop-btn').addEventListener('click', () => engine.stop());

    applyRecommendations(engine.selector);
    updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    statsControls.show('retention');
  }

  return {
    mode,
    engine,
    init,
    activate() { engine.attach(); refreshUI(); engine.showCalibrationIfNeeded(); },
    deactivate() {
      if (engine.isRunning) engine.stop();
      engine.detach();
      noteKeyHandler.reset();
    },
  };
}

// Diatonic Chords quiz mode: key + roman numeral <-> chord root.
// Forward: "IV in Bb major?" -> Eb, Reverse: "Dm is what in C major?" -> ii
// 168 items: 12 keys x 7 degrees x 2 directions.
// Grouped by degree importance for progressive unlocking.
//
// Depends on globals: MAJOR_KEYS, DIATONIC_CHORDS, ROMAN_NUMERALS,
// getScaleDegreeNote, spelledNoteMatchesSemitone,
// createQuizEngine, createNoteKeyHandler, updateModeStats,
// renderStatsGrid, buildStatsLegend, DEFAULT_CONFIG,
// computeRecommendations

function createDiatonicChordsMode() {
  const container = document.getElementById('mode-diatonicChords');
  const GROUPS_KEY = 'diatonicChords_enabledGroups';

  // Groups by degree importance
  const CHORD_GROUPS = [
    { degrees: [1, 4, 5], label: 'I,IV,V' },
    { degrees: [2, 6],    label: 'ii,vi' },
    { degrees: [3, 7],    label: 'iii,vii\u00B0' },
  ];

  let enabledGroups = new Set([0]);
  let recommendedGroups = new Set();

  // Build full item list
  const ALL_ITEMS = [];
  for (const key of MAJOR_KEYS) {
    for (let d = 1; d <= 7; d++) {
      ALL_ITEMS.push(key.root + ':' + d + ':fwd');
      ALL_ITEMS.push(key.root + ':' + d + ':rev');
    }
  }

  function parseItem(itemId) {
    const parts = itemId.split(':');
    const keyRoot = parts[0];
    const degree = parseInt(parts[1]);
    const dir = parts[2];
    const key = MAJOR_KEYS.find(k => k.root === keyRoot);
    const chord = DIATONIC_CHORDS[degree - 1];
    const rootNote = getScaleDegreeNote(keyRoot, degree);
    return { key, degree, dir, chord, rootNote };
  }

  function getItemIdsForGroup(groupIndex) {
    const degrees = CHORD_GROUPS[groupIndex].degrees;
    const items = [];
    for (const key of MAJOR_KEYS) {
      for (const d of degrees) {
        items.push(key.root + ':' + d + ':fwd');
        items.push(key.root + ':' + d + ':rev');
      }
    }
    return items;
  }

  // --- Group management ---

  function loadEnabledGroups() {
    const saved = localStorage.getItem(GROUPS_KEY);
    if (saved) {
      try { enabledGroups = new Set(JSON.parse(saved)); } catch {}
    }
    updateGroupToggles();
  }

  function saveEnabledGroups() {
    localStorage.setItem(GROUPS_KEY, JSON.stringify([...enabledGroups]));
  }

  function updateGroupToggles() {
    container.querySelectorAll('.distance-toggle').forEach(btn => {
      const g = parseInt(btn.dataset.group);
      btn.classList.toggle('active', enabledGroups.has(g));
      btn.classList.toggle('recommended', recommendedGroups.has(g));
    });
  }

  const recsOptions = { sortUnstarted: (a, b) => a.string - b.string };

  function updateRecommendations(selector) {
    const allGroups = CHORD_GROUPS.map((_, i) => i);
    const result = computeRecommendations(selector, allGroups, getItemIdsForGroup, DEFAULT_CONFIG, recsOptions);
    recommendedGroups = result.recommended;
    updateGroupToggles();
  }

  function applyRecommendations(selector) {
    const allGroups = CHORD_GROUPS.map((_, i) => i);
    const result = computeRecommendations(selector, allGroups, getItemIdsForGroup, DEFAULT_CONFIG, recsOptions);
    recommendedGroups = result.recommended;
    if (result.enabled) {
      enabledGroups = result.enabled;
      saveEnabledGroups();
    }
    updateGroupToggles();
  }

  function refreshUI() {
    updateRecommendations(engine.selector);
    engine.updateIdleMessage();
  }

  function toggleGroup(g) {
    if (enabledGroups.has(g)) {
      if (enabledGroups.size > 1) enabledGroups.delete(g);
    } else {
      enabledGroups.add(g);
    }
    saveEnabledGroups();
    refreshUI();
  }

  // --- Stats ---

  let currentItem = null;

  const statsControls = createStatsControls(container, (mode, el) => {
    const colLabels = ROMAN_NUMERALS;
    const gridDiv = document.createElement('div');
    gridDiv.className = 'stats-grid-wrapper';
    el.appendChild(gridDiv);
    const keyNotes = MAJOR_KEYS.map(k => ({ name: k.root, displayName: k.root }));
    renderStatsGrid(engine.selector, colLabels, (keyRoot, colIdx) => {
      const d = colIdx + 1;
      return [keyRoot + ':' + d + ':fwd', keyRoot + ':' + d + ':rev'];
    }, mode, gridDiv, keyNotes, engine.baseline);
    const legendDiv = document.createElement('div');
    legendDiv.innerHTML = buildStatsLegend(mode, engine.baseline);
    el.appendChild(legendDiv);
  });

  // --- Quiz mode interface ---

  const mode = {
    id: 'diatonicChords',
    name: 'Diatonic Chords',
    storageNamespace: 'diatonicChords',

    getEnabledItems() {
      const items = [];
      for (const g of enabledGroups) {
        items.push(...getItemIdsForGroup(g));
      }
      return items;
    },

    presentQuestion(itemId) {
      currentItem = parseItem(itemId);
      const prompt = container.querySelector('.quiz-prompt');
      const noteButtons = container.querySelector('.answer-buttons-notes');
      const numeralButtons = container.querySelector('.answer-buttons-numerals');

      if (currentItem.dir === 'fwd') {
        prompt.textContent = currentItem.chord.numeral + ' in ' + currentItem.key.root + ' major = ?';
        noteButtons.style.display = '';
        numeralButtons.style.display = 'none';
      } else {
        const chordName = currentItem.rootNote + currentItem.chord.qualityLabel;
        prompt.textContent = chordName + ' in ' + currentItem.key.root + ' major = ?';
        noteButtons.style.display = 'none';
        numeralButtons.style.display = '';
      }
    },

    checkAnswer(itemId, input) {
      if (currentItem.dir === 'fwd') {
        const correct = spelledNoteMatchesSemitone(currentItem.rootNote, input);
        const fullAnswer = currentItem.rootNote + ' ' + currentItem.chord.quality;
        return { correct, correctAnswer: fullAnswer };
      } else {
        const expectedNumeral = currentItem.chord.numeral;
        return { correct: input === expectedNumeral, correctAnswer: expectedNumeral };
      }
    },

    onStart() {
      noteKeyHandler.reset();
      statsControls.hide();
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    },

    onStop() {
      noteKeyHandler.reset();
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
      statsControls.show('retention');
      refreshUI();
    },

    handleKey(e, { submitAnswer }) {
      if (currentItem.dir === 'fwd') {
        return noteKeyHandler.handleKey(e);
      }
      // Reverse: number keys 1-7 for roman numeral
      if (e.key >= '1' && e.key <= '7') {
        e.preventDefault();
        submitAnswer(ROMAN_NUMERALS[parseInt(e.key) - 1]);
        return true;
      }
      return false;
    },

    getCalibrationButtons() {
      return Array.from(container.querySelectorAll('.answer-btn-note'));
    },
  };

  const engine = createQuizEngine(mode, container);
  engine.storage.preload(ALL_ITEMS);

  const noteKeyHandler = createNoteKeyHandler(
    input => engine.submitAnswer(input),
    () => true
  );

  function init() {
    const togglesDiv = container.querySelector('.distance-toggles');
    CHORD_GROUPS.forEach((group, i) => {
      const btn = document.createElement('button');
      btn.className = 'distance-toggle';
      btn.dataset.group = String(i);
      btn.textContent = group.label;
      btn.addEventListener('click', () => toggleGroup(i));
      togglesDiv.appendChild(btn);
    });

    loadEnabledGroups();

    container.querySelectorAll('.answer-btn-note').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.note);
      });
    });

    container.querySelectorAll('.answer-btn-numeral').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.numeral);
      });
    });

    container.querySelector('.start-btn').addEventListener('click', () => engine.start());
    container.querySelector('.stop-btn').addEventListener('click', () => engine.stop());

    applyRecommendations(engine.selector);
    updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    statsControls.show('retention');
  }

  return {
    mode,
    engine,
    init,
    activate() { engine.attach(); refreshUI(); engine.showCalibrationIfNeeded(); },
    deactivate() {
      if (engine.isRunning) engine.stop();
      engine.detach();
      noteKeyHandler.reset();
    },
  };
}

// Chord Spelling quiz mode: spell out all notes of a chord in root-up order.
// "Cm7" -> user enters C, Eb, G, Bb in sequence.
// ~132 items: 12 roots x chord types, grouped by chord type.
//
// Depends on globals: CHORD_TYPES, CHORD_ROOTS, getChordTones,
// chordDisplayName, spelledNoteMatchesInput,
// createQuizEngine, createNoteKeyHandler, updateModeStats,
// renderStatsGrid, buildStatsLegend, DEFAULT_CONFIG,
// computeRecommendations

function createChordSpellingMode() {
  const container = document.getElementById('mode-chordSpelling');
  const GROUPS_KEY = 'chordSpelling_enabledGroups';

  // Group chord types by their group index
  const SPELLING_GROUPS = [];
  let maxGroup = 0;
  for (const ct of CHORD_TYPES) {
    if (ct.group > maxGroup) maxGroup = ct.group;
  }
  for (let g = 0; g <= maxGroup; g++) {
    const types = CHORD_TYPES.filter(t => t.group === g);
    const label = types.map(t => t.symbol || 'maj').join(', ');
    SPELLING_GROUPS.push({ types, label });
  }

  let enabledGroups = new Set([0]);
  let recommendedGroups = new Set();

  // Build full item list
  const ALL_ITEMS = [];
  for (const root of CHORD_ROOTS) {
    for (const type of CHORD_TYPES) {
      ALL_ITEMS.push(root + ':' + type.name);
    }
  }

  function parseItem(itemId) {
    const colonIdx = itemId.indexOf(':');
    const rootName = itemId.substring(0, colonIdx);
    const typeName = itemId.substring(colonIdx + 1);
    const chordType = CHORD_TYPES.find(t => t.name === typeName);
    const tones = getChordTones(rootName, chordType);
    return { rootName, chordType, tones };
  }

  function getItemIdsForGroup(groupIndex) {
    const types = SPELLING_GROUPS[groupIndex].types;
    const items = [];
    for (const root of CHORD_ROOTS) {
      for (const type of types) {
        items.push(root + ':' + type.name);
      }
    }
    return items;
  }

  // --- Group management ---

  function loadEnabledGroups() {
    const saved = localStorage.getItem(GROUPS_KEY);
    if (saved) {
      try { enabledGroups = new Set(JSON.parse(saved)); } catch {}
    }
    updateGroupToggles();
  }

  function saveEnabledGroups() {
    localStorage.setItem(GROUPS_KEY, JSON.stringify([...enabledGroups]));
  }

  function updateGroupToggles() {
    container.querySelectorAll('.distance-toggle').forEach(btn => {
      const g = parseInt(btn.dataset.group);
      btn.classList.toggle('active', enabledGroups.has(g));
      btn.classList.toggle('recommended', recommendedGroups.has(g));
    });
  }

  const recsOptions = { sortUnstarted: (a, b) => a.string - b.string };

  function updateRecommendations(selector) {
    const allGroups = SPELLING_GROUPS.map((_, i) => i);
    const result = computeRecommendations(selector, allGroups, getItemIdsForGroup, DEFAULT_CONFIG, recsOptions);
    recommendedGroups = result.recommended;
    updateGroupToggles();
  }

  function applyRecommendations(selector) {
    const allGroups = SPELLING_GROUPS.map((_, i) => i);
    const result = computeRecommendations(selector, allGroups, getItemIdsForGroup, DEFAULT_CONFIG, recsOptions);
    recommendedGroups = result.recommended;
    if (result.enabled) {
      enabledGroups = result.enabled;
      saveEnabledGroups();
    }
    updateGroupToggles();
  }

  function refreshUI() {
    updateRecommendations(engine.selector);
    engine.updateIdleMessage();
  }

  function toggleGroup(g) {
    if (enabledGroups.has(g)) {
      if (enabledGroups.size > 1) enabledGroups.delete(g);
    } else {
      enabledGroups.add(g);
    }
    saveEnabledGroups();
    refreshUI();
  }

  // --- Multi-note entry state ---

  let currentItem = null;
  let enteredTones = [];

  function renderSlots() {
    const slotsDiv = container.querySelector('.chord-slots');
    if (!currentItem) { slotsDiv.innerHTML = ''; return; }
    let html = '';
    for (let i = 0; i < currentItem.tones.length; i++) {
      let cls = 'chord-slot';
      let content = '_';
      if (i < enteredTones.length) {
        content = enteredTones[i].display;
        cls += enteredTones[i].correct ? ' correct' : ' wrong';
      } else if (i === enteredTones.length) {
        cls += ' active';
      }
      html += '<span class="' + cls + '">' + content + '</span>';
    }
    slotsDiv.innerHTML = html;
  }

  function submitTone(input) {
    if (!engine.isActive || engine.isAnswered) return;
    if (!currentItem || enteredTones.length >= currentItem.tones.length) return;

    const idx = enteredTones.length;
    const expected = currentItem.tones[idx];
    const isCorrect = spelledNoteMatchesInput(expected, input);

    enteredTones.push({
      input,
      display: isCorrect ? expected : input,
      correct: isCorrect,
    });
    renderSlots();

    if (enteredTones.length === currentItem.tones.length) {
      const allCorrect = enteredTones.every(t => t.correct);
      engine.submitAnswer(allCorrect ? '__correct__' : '__wrong__');
    }
  }

  // --- Stats ---

  const statsControls = createStatsControls(container, (mode, el) => {
    const colLabels = CHORD_TYPES.map(t => t.symbol || 'maj');
    const gridDiv = document.createElement('div');
    gridDiv.className = 'stats-grid-wrapper';
    el.appendChild(gridDiv);
    const rootNotes = CHORD_ROOTS.map(r => ({ name: r, displayName: r }));
    renderStatsGrid(engine.selector, colLabels, (rootName, colIdx) => {
      return rootName + ':' + CHORD_TYPES[colIdx].name;
    }, mode, gridDiv, rootNotes, engine.baseline);
    const legendDiv = document.createElement('div');
    legendDiv.innerHTML = buildStatsLegend(mode, engine.baseline);
    el.appendChild(legendDiv);
  });

  // --- Quiz mode interface ---

  const mode = {
    id: 'chordSpelling',
    name: 'Chord Spelling',
    storageNamespace: 'chordSpelling',

    getEnabledItems() {
      const items = [];
      for (const g of enabledGroups) {
        items.push(...getItemIdsForGroup(g));
      }
      return items;
    },

    presentQuestion(itemId) {
      currentItem = parseItem(itemId);
      enteredTones = [];
      const prompt = container.querySelector('.quiz-prompt');
      prompt.textContent = chordDisplayName(currentItem.rootName, currentItem.chordType) + ' = ?';
      renderSlots();
    },

    checkAnswer(itemId, input) {
      const allCorrect = input === '__correct__';
      const correctAnswer = currentItem.tones.join(' ');
      return { correct: allCorrect, correctAnswer };
    },

    onStart() {
      noteKeyHandler.reset();
      enteredTones = [];
      statsControls.hide();
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    },

    onStop() {
      noteKeyHandler.reset();
      enteredTones = [];
      const slotsDiv = container.querySelector('.chord-slots');
      slotsDiv.innerHTML = '';
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
      statsControls.show('retention');
      refreshUI();
    },

    handleKey(e, ctx) {
      return noteKeyHandler.handleKey(e);
    },

    getCalibrationButtons() {
      return Array.from(container.querySelectorAll('.answer-btn-note'));
    },
  };

  const engine = createQuizEngine(mode, container);
  engine.storage.preload(ALL_ITEMS);

  const noteKeyHandler = createNoteKeyHandler(
    input => submitTone(input),
    () => true
  );

  function init() {
    const togglesDiv = container.querySelector('.distance-toggles');
    SPELLING_GROUPS.forEach((group, i) => {
      const btn = document.createElement('button');
      btn.className = 'distance-toggle';
      btn.dataset.group = String(i);
      btn.textContent = group.label;
      btn.addEventListener('click', () => toggleGroup(i));
      togglesDiv.appendChild(btn);
    });

    loadEnabledGroups();

    container.querySelectorAll('.answer-btn-note').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        let input = btn.dataset.note;
        // Resolve enharmonic: buttons can't distinguish A#/Bb, so if the
        // button's pitch matches the expected tone, use the expected spelling.
        if (currentItem && enteredTones.length < currentItem.tones.length) {
          const expected = currentItem.tones[enteredTones.length];
          if (spelledNoteMatchesSemitone(expected, input)) {
            input = expected;
          }
        }
        submitTone(input);
      });
    });

    container.querySelector('.start-btn').addEventListener('click', () => engine.start());
    container.querySelector('.stop-btn').addEventListener('click', () => engine.stop());

    applyRecommendations(engine.selector);
    updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    statsControls.show('retention');
  }

  return {
    mode,
    engine,
    init,
    activate() { engine.attach(); refreshUI(); engine.showCalibrationIfNeeded(); },
    deactivate() {
      if (engine.isRunning) engine.stop();
      engine.detach();
      noteKeyHandler.reset();
    },
  };
}

// Navigation: hamburger menu and mode switching.
// Persists last-used mode in localStorage.
//
// Depends on DOM: .hamburger, .nav-drawer, .mode-screen, [data-mode]

function createNavigation() {
  const LAST_MODE_KEY = 'fretboard_lastMode';
  const modes = {}; // id -> { init, activate, deactivate, name }
  let currentModeId = null;

  const hamburger = document.querySelector('.hamburger');
  const drawer = document.querySelector('.nav-drawer');
  const overlay = document.querySelector('.nav-overlay');
  const modeTitle = document.getElementById('mode-title');

  function closeDrawer() {
    if (drawer) drawer.classList.remove('open');
    if (overlay) overlay.classList.remove('open');
    if (hamburger) hamburger.setAttribute('aria-expanded', 'false');
  }

  function openDrawer() {
    if (drawer) drawer.classList.add('open');
    if (overlay) overlay.classList.add('open');
    if (hamburger) hamburger.setAttribute('aria-expanded', 'true');
  }

  function registerMode(id, modeController) {
    modes[id] = modeController;
  }

  function switchTo(modeId) {
    if (!modes[modeId]) return;
    if (currentModeId === modeId) {
      closeDrawer();
      return;
    }

    // Deactivate current mode
    if (currentModeId && modes[currentModeId]) {
      modes[currentModeId].deactivate();
      const currentScreen = document.getElementById('mode-' + currentModeId);
      if (currentScreen) currentScreen.style.display = 'none';
    }

    // Activate new mode
    currentModeId = modeId;
    const newScreen = document.getElementById('mode-' + modeId);
    if (newScreen) newScreen.style.display = '';
    modes[modeId].activate();

    // Update title
    if (modeTitle) modeTitle.textContent = modes[modeId].name || modeId;

    // Update active state in drawer
    drawer.querySelectorAll('[data-mode]').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.mode === modeId);
    });

    // Persist
    localStorage.setItem(LAST_MODE_KEY, modeId);
    closeDrawer();
  }

  function init() {
    // Hamburger toggle
    if (hamburger) {
      hamburger.addEventListener('click', () => {
        if (drawer.classList.contains('open')) {
          closeDrawer();
        } else {
          openDrawer();
        }
      });
    }

    // Overlay click closes drawer
    if (overlay) {
      overlay.addEventListener('click', closeDrawer);
    }

    // Mode buttons in drawer
    if (drawer) {
      drawer.querySelectorAll('[data-mode]').forEach(btn => {
        btn.addEventListener('click', () => {
          switchTo(btn.dataset.mode);
        });
      });
    }

    // Initialize all registered modes
    for (const id of Object.keys(modes)) {
      modes[id].init();
    }

    // Hide all mode screens initially
    document.querySelectorAll('.mode-screen').forEach(el => {
      el.style.display = 'none';
    });

    // Switch to last-used mode or default
    const lastMode = localStorage.getItem(LAST_MODE_KEY);
    const startMode = (lastMode && modes[lastMode]) ? lastMode : Object.keys(modes)[0];
    if (startMode) switchTo(startMode);
  }

  return { registerMode, switchTo, init };
}

// App initialization: registers quiz modes and starts navigation.
// Loaded last in the script — depends on all other modules being
// available as globals (adaptive.js, music-data.js, quiz-engine.js,
// quiz-fretboard.js, navigation.js).

(function () {
  const nav = createNavigation();

  // Register fretboard mode
  const fretboard = createFretboardMode();
  nav.registerMode('fretboard', {
    name: 'Fretboard',
    init: fretboard.init,
    activate: fretboard.activate,
    deactivate: fretboard.deactivate,
  });

  // Speed Tap mode
  const speedTap = createSpeedTapMode();
  nav.registerMode('speedTap', {
    name: 'Speed Tap',
    init: speedTap.init,
    activate: speedTap.activate,
    deactivate: speedTap.deactivate,
  });

  // Note <-> Semitones mode
  const noteSemitones = createNoteSemitonesMode();
  nav.registerMode('noteSemitones', {
    name: 'Note \u2194 Semitones',
    init: noteSemitones.init,
    activate: noteSemitones.activate,
    deactivate: noteSemitones.deactivate,
  });

  // Interval <-> Semitones mode
  const intervalSemitones = createIntervalSemitonesMode();
  nav.registerMode('intervalSemitones', {
    name: 'Interval \u2194 Semitones',
    init: intervalSemitones.init,
    activate: intervalSemitones.activate,
    deactivate: intervalSemitones.deactivate,
  });

  // Semitone Math mode
  const semitoneMath = createSemitoneMathMode();
  nav.registerMode('semitoneMath', {
    name: 'Semitone Math',
    init: semitoneMath.init,
    activate: semitoneMath.activate,
    deactivate: semitoneMath.deactivate,
  });

  // Interval Math mode
  const intervalMath = createIntervalMathMode();
  nav.registerMode('intervalMath', {
    name: 'Interval Math',
    init: intervalMath.init,
    activate: intervalMath.activate,
    deactivate: intervalMath.deactivate,
  });

  // Key Signatures mode
  const keySignatures = createKeySignaturesMode();
  nav.registerMode('keySignatures', {
    name: 'Key Signatures',
    init: keySignatures.init,
    activate: keySignatures.activate,
    deactivate: keySignatures.deactivate,
  });

  // Scale Degrees mode
  const scaleDegrees = createScaleDegreesMode();
  nav.registerMode('scaleDegrees', {
    name: 'Scale Degrees',
    init: scaleDegrees.init,
    activate: scaleDegrees.activate,
    deactivate: scaleDegrees.deactivate,
  });

  // Diatonic Chords mode
  const diatonicChords = createDiatonicChordsMode();
  nav.registerMode('diatonicChords', {
    name: 'Diatonic Chords',
    init: diatonicChords.init,
    activate: diatonicChords.activate,
    deactivate: diatonicChords.deactivate,
  });

  // Chord Spelling mode
  const chordSpelling = createChordSpellingMode();
  nav.registerMode('chordSpelling', {
    name: 'Chord Spelling',
    init: chordSpelling.init,
    activate: chordSpelling.activate,
    deactivate: chordSpelling.deactivate,
  });

  nav.init();

  // Register service worker for cache busting on iOS home screen
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
})();

  </script>
</body>
</html>