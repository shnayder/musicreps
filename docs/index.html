<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fretboard Trainer</title>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
body {
  font-family: system-ui, -apple-system, sans-serif;
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 1rem;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  min-height: 100dvh;
}

/* --- Top bar & navigation --- */
.top-bar {
  display: flex;
  align-items: center;
  padding: 0.5rem 0;
  position: relative;
}
.hamburger {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.25rem 0.5rem;
  margin: 0;
  line-height: 1;
  color: #333;
}
.top-bar h1 {
  margin: 0;
  font-size: 1.3rem;
  flex: 1;
  text-align: center;
}
.version {
  font-size: 0.75rem;
  color: #aaa;
  padding-right: 0.25rem;
}
.nav-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.3);
  z-index: 99;
}
.nav-overlay.open {
  display: block;
}
.nav-drawer {
  position: fixed;
  top: 0;
  left: -280px;
  width: 260px;
  height: 100%;
  background: #fff;
  box-shadow: 2px 0 8px rgba(0,0,0,0.15);
  z-index: 100;
  transition: left 0.2s ease;
  padding: 1rem 0;
  overflow-y: auto;
}
.nav-drawer.open {
  left: 0;
}
.nav-drawer button {
  display: block;
  width: 100%;
  text-align: left;
  padding: 0.75rem 1.5rem;
  border: none;
  background: none;
  font-size: 1rem;
  cursor: pointer;
  color: #333;
  margin: 0;
}
.nav-drawer button:hover {
  background: #f0f0f0;
}
.nav-drawer button.active {
  background: #e8f5e9;
  color: #2e7d32;
  font-weight: 600;
}

/* --- Mode screens --- */
.mode-screen {
  padding-top: 0.5rem;
  flex: 1;
}

/* --- Fretboard --- */
.fretboard-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
}
.string-toggles {
  display: flex;
  flex-direction: row;
  gap: 2px;
  justify-content: center;
}
.string-toggle {
  width: 28px;
  height: 28px;
  border: 1px solid #999;
  border-radius: 4px;
  background: #f5f5f5;
  color: #999;
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  padding: 0;
  margin: 0;
}
.string-toggle.active {
  background: #4CAF50;
  color: white;
  border-color: #4CAF50;
}
.string-toggle.recommended {
  box-shadow: 0 0 0 2px #FF9800;
}
.string-toggle.active.recommended {
  border-color: #FF9800;
}
.fretboard-container {
  position: relative;
  flex: 1;
  min-width: 0;
  max-width: 1200px;
}
.fretboard {
  width: 100%;
  height: auto;
  display: block;
  background: #fff;
  touch-action: manipulation;
}
.fret-numbers {
  position: relative;
  height: 1.5rem;
  width: 100%;
}
.fret-number {
  position: absolute;
  transform: translateX(-50%);
  font-size: 0.9rem;
  color: #666;
}

/* --- Quiz controls (shared) --- */
.quiz-controls {
  text-align: center;
  margin: 1rem 0;
}
.settings-row {
  display: flex;
  align-items: center;
  gap: 1rem;
  justify-content: center;
  margin-bottom: 0.5rem;
}
button {
  padding: 0.5rem 1.5rem;
  font-size: 1rem;
  cursor: pointer;
  margin: 0 0.5rem;
}
.mastery-message {
  color: #2e7d32;
  font-size: 0.95rem;
  margin-bottom: 0.5rem;
}
.quiz-area {
  display: none;
  text-align: center;
  margin: 1rem 0;
}
.quiz-area.active {
  display: block;
}
.countdown-container {
  width: 200px;
  height: 8px;
  background: #eee;
  margin: 1rem auto;
  border-radius: 4px;
  overflow: hidden;
}
.countdown-bar {
  height: 100%;
  background: #4CAF50;
  transition: width 0.1s linear;
}
.countdown-bar.expired {
  background: #f44336;
}

/* --- Note buttons --- */
.note-buttons {
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start;
  gap: 0.25rem;
  margin: 0.5rem auto 0.5rem 0;
  max-width: 220px;
}
.note-btn {
  min-width: 50px;
  height: 48px;
  font-size: 1.15rem;
  font-weight: 500;
  border: 2px solid #666;
  border-radius: 8px;
  background: #fff;
  cursor: pointer;
  padding: 0 0.5rem;
  touch-action: manipulation;
}
.note-btn.accidental {
  background: #e8e8e8;
}
.note-btn:active {
  background: #d0d0d0;
}
.note-btn:disabled {
  opacity: 0.5;
  cursor: default;
}
.note-btn.hidden {
  display: none;
}

/* --- Quiz prompt (text modes) --- */
.quiz-prompt {
  font-size: 2rem;
  font-weight: 600;
  margin: 1rem 0;
  min-height: 2.5rem;
}

/* --- Answer buttons grid (shared by new modes) --- */
.answer-buttons {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0.4rem;
  max-width: 360px;
  margin: 0.5rem auto;
}
.answer-btn {
  height: 48px;
  font-size: 1.1rem;
  font-weight: 500;
  border: 2px solid #666;
  border-radius: 8px;
  background: #fff;
  cursor: pointer;
  padding: 0 0.25rem;
  touch-action: manipulation;
}
.answer-btn:active {
  background: #d0d0d0;
}
.answer-btn:disabled {
  opacity: 0.5;
  cursor: default;
}
.answer-buttons-intervals {
  grid-template-columns: repeat(3, 1fr);
}

/* --- Feedback --- */
.feedback {
  font-size: 1.5rem;
  margin: 1rem 0;
  min-height: 2rem;
}
.correct {
  color: green;
}
.incorrect {
  color: red;
}
.time-display {
  color: #666;
  font-size: 0.9rem;
  margin-top: 0.5rem;
}
.hint {
  color: #666;
  font-size: 1rem;
  margin-top: 1rem;
}
.stats {
  margin-top: 1rem;
  font-size: 0.9rem;
  color: #666;
}

/* --- Heatmap legends --- */
.heatmap-legend {
  display: none;
  justify-content: center;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin: 0.75rem 0;
}
.heatmap-legend.active {
  display: flex;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 0.2rem;
  font-size: 0.75rem;
  color: #666;
}
.legend-swatch {
  width: 12px;
  height: 12px;
  border-radius: 3px;
  border: 1px solid #999;
}
.setting-group {
  display: flex;
  align-items: center;
  gap: 0.3rem;
  font-size: 0.9rem;
  color: #666;
  cursor: pointer;
}

/* --- Stats tables (lookup modes) --- */
.stats-container {
  text-align: center;
  margin: 0.5rem 0;
}
.stats-table {
  border-collapse: collapse;
  margin: 0.5rem auto;
  font-size: 0.9rem;
}
.stats-table th, .stats-table td {
  border: 1px solid #ccc;
  padding: 0.3rem 0.6rem;
  text-align: center;
}
.stats-table th {
  background: #f5f5f5;
  font-weight: 600;
}
.stats-cell {
  width: 36px;
  height: 24px;
  border-radius: 2px;
  padding: 0;
  box-sizing: border-box;
}

/* --- Stats grids (math modes) --- */
.stats-grid-wrapper {
  overflow-x: auto;
  margin: 0.5rem 0;
}
.stats-grid {
  border-collapse: collapse;
  margin: 0 auto;
  font-size: 0.8rem;
}
.stats-grid th, .stats-grid td {
  border: 1px solid #ccc;
  padding: 0.15rem 0.25rem;
  text-align: center;
}
.stats-grid th {
  background: #f5f5f5;
  font-weight: 600;
  font-size: 0.75rem;
}
.stats-grid .stats-cell {
  width: 26px;
  height: 22px;
}
.stats-grid-row-label {
  font-weight: 600;
  background: #f5f5f5;
  padding: 0.15rem 0.4rem;
}

/* --- Direction toggle (math mode stats) --- */
.stats-dir-toggle {
  display: flex;
  justify-content: center;
  gap: 0.25rem;
  margin: 0.5rem 0;
}
.dir-btn {
  padding: 0.3rem 1rem;
  font-size: 1.1rem;
  font-weight: 600;
  border: 2px solid #999;
  border-radius: 6px;
  background: #f5f5f5;
  cursor: pointer;
  margin: 0;
}
.dir-btn.active {
  background: #4CAF50;
  color: white;
  border-color: #4CAF50;
}

/* --- Speed Tap mode --- */
.speed-tap-prompt {
  font-size: 2rem;
  font-weight: 600;
  margin: 1rem 0 0.5rem;
}
.speed-tap-status {
  display: flex;
  justify-content: center;
  gap: 1.5rem;
  font-size: 1.3rem;
  margin: 0.5rem 0;
}
.speed-tap-progress {
  font-weight: 500;
}
.speed-tap-timer {
  color: #666;
  font-variant-numeric: tabular-nums;
}
.speed-tap-stats {
  font-size: 0.75rem;
}
.speed-tap-stats th, .speed-tap-stats td {
  padding: 0.2rem 0.3rem;
}
.speed-tap-stats .stats-cell {
  width: 24px;
  height: 20px;
}

/* --- Stats controls (divider between stats and quiz sections) --- */
.stats-controls {
  text-align: center;
  margin: 0.5rem 0;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid #ddd;
}

/* Mobile layout */
@media (max-width: 599px) {
  body {
    margin: 0;
    padding: 0 2px;
  }

  .top-bar {
    padding: 0.25rem 0;
  }

  .fretboard-container {
    width: 100%;
    max-width: none;
  }

  .answer-buttons {
    grid-template-columns: repeat(3, 1fr);
    max-width: 280px;
  }

  .quiz-prompt {
    font-size: 1.6rem;
  }

  /* Prevent iOS zoom on input focus */
  input, button { font-size: 16px; }
}

  </style>
</head>
<body>
  <!-- Navigation -->
  <div class="nav-overlay"></div>
  <div class="nav-drawer" id="nav-drawer">
    <button data-mode="fretboard">Fretboard</button>
    <button data-mode="speedTap">Speed Tap</button>
    <button data-mode="noteSemitones">Note ↔ Semitones</button>
    <button data-mode="intervalSemitones">Interval ↔ Semitones</button>
    <button data-mode="semitoneMath">Semitone Math</button>
    <button data-mode="intervalMath">Interval Math</button>
  </div>

  <div class="top-bar">
    <button class="hamburger" type="button" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="nav-drawer">☰</button>
    <h1 id="mode-title">Fretboard</h1>
    <div class="version">v2.4</div>
  </div>

  <!-- Fretboard mode -->
  <div class="mode-screen" id="mode-fretboard">
    <div class="fretboard-wrapper">
      <div class="fretboard-container">
        <svg class="fretboard" id="fretboard" viewBox="0 0 600 240">
          <!-- Nut (thick line at fret 0) -->
          <line x1="65" y1="0" x2="65" y2="240" stroke="#333" stroke-width="4"/>
          <!-- Frets (vertical lines) -->
          <line x1="65" y1="0" x2="65" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="126" y1="0" x2="126" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="183" y1="0" x2="183" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="237" y1="0" x2="237" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="288" y1="0" x2="288" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="336" y1="0" x2="336" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="381" y1="0" x2="381" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="423" y1="0" x2="423" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="463" y1="0" x2="463" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="500" y1="0" x2="500" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="535" y1="0" x2="535" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="568" y1="0" x2="568" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="600" y1="0" x2="600" y2="240" stroke="#333" stroke-width="1"/>
          <!-- Strings (horizontal lines) -->
          <line x1="0" y1="20" x2="600" y2="20" stroke="#333" stroke-width="1"/>
      <line x1="0" y1="60" x2="600" y2="60" stroke="#333" stroke-width="1.5"/>
      <line x1="0" y1="100" x2="600" y2="100" stroke="#333" stroke-width="2"/>
      <line x1="0" y1="140" x2="600" y2="140" stroke="#333" stroke-width="2.5"/>
      <line x1="0" y1="180" x2="600" y2="180" stroke="#333" stroke-width="3"/>
      <line x1="0" y1="220" x2="600" y2="220" stroke="#333" stroke-width="3.5"/>
          <!-- Note circles -->
          <circle
      class="note-circle"
      data-string="0"
      data-fret="0"
      cx="32.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="0"
      x="32.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="1"
      cx="95.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="1"
      x="95.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="2"
      cx="154.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="2"
      x="154.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="3"
      cx="210"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="3"
      x="210"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="4"
      cx="262.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="4"
      x="262.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="5"
      cx="312"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="5"
      x="312"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="6"
      cx="358.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="6"
      x="358.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="7"
      cx="402"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="7"
      x="402"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="8"
      cx="443"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="8"
      x="443"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="9"
      cx="481.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="9"
      x="481.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="10"
      cx="517.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="10"
      x="517.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="11"
      cx="551.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="11"
      x="551.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="12"
      cx="584"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="12"
      x="584"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="0"
      cx="32.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="0"
      x="32.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="1"
      cx="95.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="1"
      x="95.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="2"
      cx="154.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="2"
      x="154.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="3"
      cx="210"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="3"
      x="210"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="4"
      cx="262.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="4"
      x="262.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="5"
      cx="312"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="5"
      x="312"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="6"
      cx="358.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="6"
      x="358.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="7"
      cx="402"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="7"
      x="402"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="8"
      cx="443"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="8"
      x="443"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="9"
      cx="481.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="9"
      x="481.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="10"
      cx="517.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="10"
      x="517.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="11"
      cx="551.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="11"
      x="551.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="12"
      cx="584"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="12"
      x="584"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="0"
      cx="32.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="0"
      x="32.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="1"
      cx="95.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="1"
      x="95.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="2"
      cx="154.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="2"
      x="154.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="3"
      cx="210"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="3"
      x="210"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="4"
      cx="262.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="4"
      x="262.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="5"
      cx="312"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="5"
      x="312"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="6"
      cx="358.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="6"
      x="358.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="7"
      cx="402"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="7"
      x="402"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="8"
      cx="443"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="8"
      x="443"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="9"
      cx="481.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="9"
      x="481.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="10"
      cx="517.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="10"
      x="517.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="11"
      cx="551.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="11"
      x="551.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="12"
      cx="584"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="12"
      x="584"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="0"
      cx="32.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="0"
      x="32.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="1"
      cx="95.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="1"
      x="95.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="2"
      cx="154.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="2"
      x="154.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="3"
      cx="210"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="3"
      x="210"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="4"
      cx="262.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="4"
      x="262.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="5"
      cx="312"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="5"
      x="312"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="6"
      cx="358.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="6"
      x="358.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="7"
      cx="402"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="7"
      x="402"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="8"
      cx="443"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="8"
      x="443"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="9"
      cx="481.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="9"
      x="481.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="10"
      cx="517.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="10"
      x="517.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="11"
      cx="551.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="11"
      x="551.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="12"
      cx="584"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="12"
      x="584"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="0"
      cx="32.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="0"
      x="32.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="1"
      cx="95.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="1"
      x="95.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="2"
      cx="154.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="2"
      x="154.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="3"
      cx="210"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="3"
      x="210"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="4"
      cx="262.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="4"
      x="262.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="5"
      cx="312"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="5"
      x="312"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="6"
      cx="358.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="6"
      x="358.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="7"
      cx="402"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="7"
      x="402"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="8"
      cx="443"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="8"
      x="443"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="9"
      cx="481.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="9"
      x="481.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="10"
      cx="517.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="10"
      x="517.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="11"
      cx="551.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="11"
      x="551.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="12"
      cx="584"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="12"
      x="584"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="0"
      cx="32.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="0"
      x="32.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="1"
      cx="95.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="1"
      x="95.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="2"
      cx="154.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="2"
      x="154.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="3"
      cx="210"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="3"
      x="210"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="4"
      cx="262.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="4"
      x="262.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="5"
      cx="312"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="5"
      x="312"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="6"
      cx="358.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="6"
      x="358.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="7"
      cx="402"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="7"
      x="402"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="8"
      cx="443"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="8"
      x="443"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="9"
      cx="481.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="9"
      x="481.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="10"
      cx="517.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="10"
      x="517.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="11"
      cx="551.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="11"
      x="551.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="12"
      cx="584"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="12"
      x="584"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
        </svg>
        <div class="fret-numbers">
          <div class="fret-number" style="left: 35%">3</div>
    <div class="fret-number" style="left: 52%">5</div>
    <div class="fret-number" style="left: 67%">7</div>
    <div class="fret-number" style="left: 80.25%">9</div>
    <div class="fret-number" style="left: 97.33333333333334%">12</div>
        </div>
      </div>
    </div>
    <div class="stats-container"></div>
    <div class="stats-controls">
      <button class="heatmap-btn">Show Recall</button>
      <span class="stats"></span>
    </div>
    <div class="quiz-controls">
      <div class="settings-row">
        <div class="string-toggles" id="string-toggles">
          <button class="string-toggle" data-string="0">e</button>
          <button class="string-toggle" data-string="1">B</button>
          <button class="string-toggle" data-string="2">G</button>
          <button class="string-toggle" data-string="3">D</button>
          <button class="string-toggle" data-string="4">A</button>
          <button class="string-toggle active" data-string="5">E</button>
        </div>
        <label class="setting-group">
          <input type="checkbox" id="naturals-only" checked>
          Natural only
        </label>
      </div>
      <div class="mastery-message" style="display: none;">Looks like you've got this!</div>
      <div>
        <button class="start-btn">Start Quiz</button>
        <button class="stop-btn" style="display: none;">Stop Quiz</button>
      </div>
    </div>
    <div class="quiz-area">
      <div class="countdown-container">
        <div class="countdown-bar"></div>
      </div>
      <div class="note-buttons">
        <button class="note-btn" data-note="C">C</button>
        <button class="note-btn accidental" data-note="C#">C#</button>
        <button class="note-btn" data-note="D">D</button>
        <button class="note-btn accidental" data-note="D#">D#</button>
        <button class="note-btn" data-note="E">E</button>
        <button class="note-btn" data-note="F">F</button>
        <button class="note-btn accidental" data-note="F#">F#</button>
        <button class="note-btn" data-note="G">G</button>
        <button class="note-btn accidental" data-note="G#">G#</button>
        <button class="note-btn" data-note="A">A</button>
        <button class="note-btn accidental" data-note="A#">A#</button>
        <button class="note-btn" data-note="B">B</button>
      </div>
      <div class="feedback"></div>
      <div class="time-display"></div>
      <div class="hint"></div>
    </div>
  </div>

  <!-- Speed Tap mode -->
  <div class="mode-screen" id="mode-speedTap">
    <div class="fretboard-wrapper">
      <div class="fretboard-container">
        <svg class="fretboard" viewBox="0 0 600 240">
          <line x1="65" y1="0" x2="65" y2="240" stroke="#333" stroke-width="4"/>
          <line x1="65" y1="0" x2="65" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="126" y1="0" x2="126" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="183" y1="0" x2="183" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="237" y1="0" x2="237" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="288" y1="0" x2="288" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="336" y1="0" x2="336" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="381" y1="0" x2="381" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="423" y1="0" x2="423" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="463" y1="0" x2="463" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="500" y1="0" x2="500" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="535" y1="0" x2="535" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="568" y1="0" x2="568" y2="240" stroke="#333" stroke-width="1"/>
      <line x1="600" y1="0" x2="600" y2="240" stroke="#333" stroke-width="1"/>
          <line x1="0" y1="20" x2="600" y2="20" stroke="#333" stroke-width="1"/>
      <line x1="0" y1="60" x2="600" y2="60" stroke="#333" stroke-width="1.5"/>
      <line x1="0" y1="100" x2="600" y2="100" stroke="#333" stroke-width="2"/>
      <line x1="0" y1="140" x2="600" y2="140" stroke="#333" stroke-width="2.5"/>
      <line x1="0" y1="180" x2="600" y2="180" stroke="#333" stroke-width="3"/>
      <line x1="0" y1="220" x2="600" y2="220" stroke="#333" stroke-width="3.5"/>
          <circle
      class="note-circle"
      data-string="0"
      data-fret="0"
      cx="32.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="0"
      x="32.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="1"
      cx="95.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="1"
      x="95.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="2"
      cx="154.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="2"
      x="154.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="3"
      cx="210"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="3"
      x="210"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="4"
      cx="262.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="4"
      x="262.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="5"
      cx="312"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="5"
      x="312"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="6"
      cx="358.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="6"
      x="358.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="7"
      cx="402"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="7"
      x="402"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="8"
      cx="443"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="8"
      x="443"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="9"
      cx="481.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="9"
      x="481.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="10"
      cx="517.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="10"
      x="517.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="11"
      cx="551.5"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="11"
      x="551.5"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="0"
      data-fret="12"
      cx="584"
      cy="20"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="0"
      data-fret="12"
      x="584"
      y="20"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="0"
      cx="32.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="0"
      x="32.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="1"
      cx="95.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="1"
      x="95.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="2"
      cx="154.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="2"
      x="154.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="3"
      cx="210"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="3"
      x="210"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="4"
      cx="262.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="4"
      x="262.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="5"
      cx="312"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="5"
      x="312"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="6"
      cx="358.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="6"
      x="358.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="7"
      cx="402"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="7"
      x="402"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="8"
      cx="443"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="8"
      x="443"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="9"
      cx="481.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="9"
      x="481.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="10"
      cx="517.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="10"
      x="517.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="11"
      cx="551.5"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="11"
      x="551.5"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="1"
      data-fret="12"
      cx="584"
      cy="60"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="1"
      data-fret="12"
      x="584"
      y="60"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="0"
      cx="32.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="0"
      x="32.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="1"
      cx="95.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="1"
      x="95.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="2"
      cx="154.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="2"
      x="154.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="3"
      cx="210"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="3"
      x="210"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="4"
      cx="262.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="4"
      x="262.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="5"
      cx="312"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="5"
      x="312"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="6"
      cx="358.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="6"
      x="358.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="7"
      cx="402"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="7"
      x="402"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="8"
      cx="443"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="8"
      x="443"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="9"
      cx="481.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="9"
      x="481.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="10"
      cx="517.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="10"
      x="517.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="11"
      cx="551.5"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="11"
      x="551.5"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="2"
      data-fret="12"
      cx="584"
      cy="100"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="2"
      data-fret="12"
      x="584"
      y="100"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="0"
      cx="32.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="0"
      x="32.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="1"
      cx="95.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="1"
      x="95.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="2"
      cx="154.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="2"
      x="154.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="3"
      cx="210"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="3"
      x="210"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="4"
      cx="262.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="4"
      x="262.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="5"
      cx="312"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="5"
      x="312"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="6"
      cx="358.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="6"
      x="358.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="7"
      cx="402"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="7"
      x="402"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="8"
      cx="443"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="8"
      x="443"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="9"
      cx="481.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="9"
      x="481.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="10"
      cx="517.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="10"
      x="517.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="11"
      cx="551.5"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="11"
      x="551.5"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="3"
      data-fret="12"
      cx="584"
      cy="140"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="3"
      data-fret="12"
      x="584"
      y="140"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="0"
      cx="32.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="0"
      x="32.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="1"
      cx="95.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="1"
      x="95.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="2"
      cx="154.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="2"
      x="154.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="3"
      cx="210"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="3"
      x="210"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="4"
      cx="262.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="4"
      x="262.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="5"
      cx="312"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="5"
      x="312"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="6"
      cx="358.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="6"
      x="358.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="7"
      cx="402"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="7"
      x="402"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="8"
      cx="443"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="8"
      x="443"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="9"
      cx="481.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="9"
      x="481.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="10"
      cx="517.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="10"
      x="517.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="11"
      cx="551.5"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="11"
      x="551.5"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="4"
      data-fret="12"
      cx="584"
      cy="180"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="4"
      data-fret="12"
      x="584"
      y="180"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="0"
      cx="32.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="0"
      x="32.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="1"
      cx="95.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="1"
      x="95.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="2"
      cx="154.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="2"
      x="154.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="3"
      cx="210"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="3"
      x="210"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="4"
      cx="262.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="4"
      x="262.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="5"
      cx="312"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="5"
      x="312"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="6"
      cx="358.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="6"
      x="358.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="7"
      cx="402"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="7"
      x="402"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="8"
      cx="443"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="8"
      x="443"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="9"
      cx="481.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="9"
      x="481.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="10"
      cx="517.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="10"
      x="517.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="11"
      cx="551.5"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="11"
      x="551.5"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
      <circle
      class="note-circle"
      data-string="5"
      data-fret="12"
      cx="584"
      cy="220"
      r="14"
      fill="white"
      stroke="#333"
      stroke-width="1"
    /><text
      class="note-text"
      data-string="5"
      data-fret="12"
      x="584"
      y="220"
      text-anchor="middle"
      dominant-baseline="central"
      font-size="11"
      fill="#333"
    ></text>
        </svg>
        <div class="fret-numbers">
          <div class="fret-number" style="left: 35%">3</div>
    <div class="fret-number" style="left: 52%">5</div>
    <div class="fret-number" style="left: 67%">7</div>
    <div class="fret-number" style="left: 80.25%">9</div>
    <div class="fret-number" style="left: 97.33333333333334%">12</div>
        </div>
      </div>
    </div>
    <div class="stats-container"></div>
    <div class="stats-controls">
      <button class="heatmap-btn">Show Recall</button>
      <span class="stats"></span>
    </div>
    <div class="quiz-controls">
      <div class="settings-row">
        <label class="setting-group">
          <input type="checkbox" id="speed-tap-naturals-only" checked>
          Natural only
        </label>
      </div>
      <div class="mastery-message" style="display: none;">Looks like you've got this!</div>
      <div>
        <button class="start-btn">Start Quiz</button>
        <button class="stop-btn" style="display: none;">Stop Quiz</button>
      </div>
    </div>

    <div class="quiz-area">
      <div class="speed-tap-prompt"></div>
      <div class="speed-tap-status">
        <span class="speed-tap-progress"></span>
        <span class="speed-tap-timer"></span>
      </div>
      <div class="feedback"></div>
      <div class="hint"></div>
    </div>
  </div>

  <!-- Note Semitones mode -->
  <div class="mode-screen" id="mode-noteSemitones">
    <div class="stats-container"></div>
    <div class="stats-controls">
      <button class="heatmap-btn">Show Recall</button>
      <span class="stats"></span>
    </div>
    <div class="quiz-controls">
      <div class="mastery-message" style="display: none;">Looks like you've got this!</div>
      <div>
        <button class="start-btn">Start Quiz</button>
        <button class="stop-btn" style="display: none;">Stop Quiz</button>
      </div>
    </div>
    <div class="quiz-area">
      <div class="countdown-container"><div class="countdown-bar"></div></div>
      <div class="quiz-prompt"></div>
      <div class="answer-buttons answer-buttons-notes">
        <button class="answer-btn answer-btn-note" data-note="C">C</button>
        <button class="answer-btn answer-btn-note" data-note="C#">C#/Db</button>
        <button class="answer-btn answer-btn-note" data-note="D">D</button>
        <button class="answer-btn answer-btn-note" data-note="D#">D#/Eb</button>
        <button class="answer-btn answer-btn-note" data-note="E">E</button>
        <button class="answer-btn answer-btn-note" data-note="F">F</button>
        <button class="answer-btn answer-btn-note" data-note="F#">F#/Gb</button>
        <button class="answer-btn answer-btn-note" data-note="G">G</button>
        <button class="answer-btn answer-btn-note" data-note="G#">G#/Ab</button>
        <button class="answer-btn answer-btn-note" data-note="A">A</button>
        <button class="answer-btn answer-btn-note" data-note="A#">A#/Bb</button>
        <button class="answer-btn answer-btn-note" data-note="B">B</button>
      </div>
      <div class="answer-buttons answer-buttons-numbers">
        <button class="answer-btn answer-btn-num" data-num="0">0</button>
        <button class="answer-btn answer-btn-num" data-num="1">1</button>
        <button class="answer-btn answer-btn-num" data-num="2">2</button>
        <button class="answer-btn answer-btn-num" data-num="3">3</button>
        <button class="answer-btn answer-btn-num" data-num="4">4</button>
        <button class="answer-btn answer-btn-num" data-num="5">5</button>
        <button class="answer-btn answer-btn-num" data-num="6">6</button>
        <button class="answer-btn answer-btn-num" data-num="7">7</button>
        <button class="answer-btn answer-btn-num" data-num="8">8</button>
        <button class="answer-btn answer-btn-num" data-num="9">9</button>
        <button class="answer-btn answer-btn-num" data-num="10">10</button>
        <button class="answer-btn answer-btn-num" data-num="11">11</button>
      </div>
      <div class="feedback"></div>
      <div class="time-display"></div>
      <div class="hint"></div>
    </div>
  </div>

  <!-- Interval Semitones mode -->
  <div class="mode-screen" id="mode-intervalSemitones">
    <div class="stats-container"></div>
    <div class="stats-controls">
      <button class="heatmap-btn">Show Recall</button>
      <span class="stats"></span>
    </div>
    <div class="quiz-controls">
      <div class="mastery-message" style="display: none;">Looks like you've got this!</div>
      <div>
        <button class="start-btn">Start Quiz</button>
        <button class="stop-btn" style="display: none;">Stop Quiz</button>
      </div>
    </div>
    <div class="quiz-area">
      <div class="countdown-container"><div class="countdown-bar"></div></div>
      <div class="quiz-prompt"></div>
      <div class="answer-buttons answer-buttons-intervals">
        <button class="answer-btn answer-btn-interval" data-interval="m2">m2</button>
        <button class="answer-btn answer-btn-interval" data-interval="M2">M2</button>
        <button class="answer-btn answer-btn-interval" data-interval="m3">m3</button>
        <button class="answer-btn answer-btn-interval" data-interval="M3">M3</button>
        <button class="answer-btn answer-btn-interval" data-interval="P4">P4</button>
        <button class="answer-btn answer-btn-interval" data-interval="TT">TT</button>
        <button class="answer-btn answer-btn-interval" data-interval="P5">P5</button>
        <button class="answer-btn answer-btn-interval" data-interval="m6">m6</button>
        <button class="answer-btn answer-btn-interval" data-interval="M6">M6</button>
        <button class="answer-btn answer-btn-interval" data-interval="m7">m7</button>
        <button class="answer-btn answer-btn-interval" data-interval="M7">M7</button>
        <button class="answer-btn answer-btn-interval" data-interval="P8">P8</button>
      </div>
      <div class="answer-buttons answer-buttons-numbers">
        <button class="answer-btn answer-btn-num" data-num="1">1</button>
        <button class="answer-btn answer-btn-num" data-num="2">2</button>
        <button class="answer-btn answer-btn-num" data-num="3">3</button>
        <button class="answer-btn answer-btn-num" data-num="4">4</button>
        <button class="answer-btn answer-btn-num" data-num="5">5</button>
        <button class="answer-btn answer-btn-num" data-num="6">6</button>
        <button class="answer-btn answer-btn-num" data-num="7">7</button>
        <button class="answer-btn answer-btn-num" data-num="8">8</button>
        <button class="answer-btn answer-btn-num" data-num="9">9</button>
        <button class="answer-btn answer-btn-num" data-num="10">10</button>
        <button class="answer-btn answer-btn-num" data-num="11">11</button>
        <button class="answer-btn answer-btn-num" data-num="12">12</button>
      </div>
      <div class="feedback"></div>
      <div class="time-display"></div>
      <div class="hint"></div>
    </div>
  </div>

  <!-- Semitone Math mode -->
  <div class="mode-screen" id="mode-semitoneMath">
    <div class="stats-container"></div>
    <div class="stats-controls">
      <button class="heatmap-btn">Show Recall</button>
      <span class="stats"></span>
    </div>
    <div class="quiz-controls">
      <div class="mastery-message" style="display: none;">Looks like you've got this!</div>
      <div>
        <button class="start-btn">Start Quiz</button>
        <button class="stop-btn" style="display: none;">Stop Quiz</button>
      </div>
    </div>
    <div class="quiz-area">
      <div class="countdown-container"><div class="countdown-bar"></div></div>
      <div class="quiz-prompt"></div>
      <div class="answer-buttons answer-buttons-notes">
        <button class="answer-btn answer-btn-note" data-note="C">C</button>
        <button class="answer-btn answer-btn-note" data-note="C#">C#/Db</button>
        <button class="answer-btn answer-btn-note" data-note="D">D</button>
        <button class="answer-btn answer-btn-note" data-note="D#">D#/Eb</button>
        <button class="answer-btn answer-btn-note" data-note="E">E</button>
        <button class="answer-btn answer-btn-note" data-note="F">F</button>
        <button class="answer-btn answer-btn-note" data-note="F#">F#/Gb</button>
        <button class="answer-btn answer-btn-note" data-note="G">G</button>
        <button class="answer-btn answer-btn-note" data-note="G#">G#/Ab</button>
        <button class="answer-btn answer-btn-note" data-note="A">A</button>
        <button class="answer-btn answer-btn-note" data-note="A#">A#/Bb</button>
        <button class="answer-btn answer-btn-note" data-note="B">B</button>
      </div>
      <div class="feedback"></div>
      <div class="time-display"></div>
      <div class="hint"></div>
    </div>
  </div>

  <!-- Interval Math mode -->
  <div class="mode-screen" id="mode-intervalMath">
    <div class="stats-container"></div>
    <div class="stats-controls">
      <button class="heatmap-btn">Show Recall</button>
      <span class="stats"></span>
    </div>
    <div class="quiz-controls">
      <div class="mastery-message" style="display: none;">Looks like you've got this!</div>
      <div>
        <button class="start-btn">Start Quiz</button>
        <button class="stop-btn" style="display: none;">Stop Quiz</button>
      </div>
    </div>
    <div class="quiz-area">
      <div class="countdown-container"><div class="countdown-bar"></div></div>
      <div class="quiz-prompt"></div>
      <div class="answer-buttons answer-buttons-notes">
        <button class="answer-btn answer-btn-note" data-note="C">C</button>
        <button class="answer-btn answer-btn-note" data-note="C#">C#/Db</button>
        <button class="answer-btn answer-btn-note" data-note="D">D</button>
        <button class="answer-btn answer-btn-note" data-note="D#">D#/Eb</button>
        <button class="answer-btn answer-btn-note" data-note="E">E</button>
        <button class="answer-btn answer-btn-note" data-note="F">F</button>
        <button class="answer-btn answer-btn-note" data-note="F#">F#/Gb</button>
        <button class="answer-btn answer-btn-note" data-note="G">G</button>
        <button class="answer-btn answer-btn-note" data-note="G#">G#/Ab</button>
        <button class="answer-btn answer-btn-note" data-note="A">A</button>
        <button class="answer-btn answer-btn-note" data-note="A#">A#/Bb</button>
        <button class="answer-btn answer-btn-note" data-note="B">B</button>
      </div>
      <div class="feedback"></div>
      <div class="time-display"></div>
      <div class="hint"></div>
    </div>
  </div>

  <script>
// Adaptive question selector: prioritizes items the user is slower on,
// with exploration boost for unseen items.
//
// This is the single source of truth. Tests import it as an ES module.
// main.ts reads it at build time and strips "export" for browser inlining.

const DEFAULT_CONFIG = {
  minTime: 1000,
  unseenBoost: 3,
  ewmaAlpha: 0.3,
  maxStoredTimes: 10,
  maxResponseTime: 9000,
  // Forgetting model
  initialStability: 4,       // hours — half-life after first correct answer
  maxStability: 336,         // hours (14 days) — stability ceiling
  stabilityGrowthBase: 2.0,  // multiplier on each correct answer
  stabilityDecayOnWrong: 0.3,// multiplier on wrong answer
  recallThreshold: 0.5,      // P(recall) below this = "due"
  expansionThreshold: 0.7,   // fraction of seen items that must be retained before suggesting new strings
  speedBonusMax: 1.5,        // fast answers grow stability up to this extra factor
  selfCorrectionThreshold: 1500, // ms — response time below this triggers self-correction
  automaticityTarget: 3000,      // ms — response time at which speedScore ≈ 0.5
};

// ---------------------------------------------------------------------------
// Pure functions
// ---------------------------------------------------------------------------

function computeEwma(oldEwma, newTime, alpha) {
  return alpha * newTime + (1 - alpha) * oldEwma;
}

/**
 * Predicted recall using half-life model: P = 2^(-t/S).
 * At t = stability, P = 0.5. Returns null for unseen items.
 */
function computeRecall(stabilityHours, elapsedHours) {
  if (stabilityHours == null || elapsedHours == null) return null;
  if (stabilityHours <= 0) return 0;
  if (elapsedHours <= 0) return 1;
  return Math.pow(2, -elapsedHours / stabilityHours);
}

/**
 * Speed score: maps EWMA onto [0, 1].
 * - minTime (1000ms) → 1.0 (fully automatic)
 * - automaticityTarget (3000ms) → 0.5
 * - Very slow → approaches 0
 * Uses exponential decay so the curve is smooth.
 */
function computeSpeedScore(ewmaMs, cfg) {
  if (ewmaMs == null) return null;
  const k = Math.LN2 / (cfg.automaticityTarget - cfg.minTime);
  return Math.exp(-k * Math.max(0, ewmaMs - cfg.minTime));
}

/**
 * Automaticity = recall * speedScore.
 * "Do I know this without thinking?" — combines "have I forgotten it?"
 * with "was I ever fast at it?" Returns null for unseen items.
 */
function computeAutomaticity(recall, speedScore) {
  if (recall == null || speedScore == null) return null;
  return recall * speedScore;
}

/**
 * Compute new stability after a correct answer.
 * - First correct: initialStability.
 * - Subsequent: grow by stabilityGrowthBase * speedFactor.
 * - Self-correction: if fast answer after long gap, back-calculate
 *   that true stability must be at least elapsedHours * 1.5.
 */
function updateStability(oldStability, responseTimeMs, elapsedHours, cfg) {
  if (oldStability == null) {
    return cfg.initialStability;
  }
  // Speed factor: fast answers grow stability more (0.5 to speedBonusMax)
  const range = cfg.maxResponseTime - cfg.minTime;
  const clamped = Math.max(cfg.minTime, Math.min(responseTimeMs, cfg.maxResponseTime));
  const t = range > 0 ? (cfg.maxResponseTime - clamped) / range : 0.5;
  const speedFactor = 0.5 + t * (cfg.speedBonusMax - 0.5);

  let newStability = oldStability * cfg.stabilityGrowthBase * speedFactor;

  // Self-correction: fast answer after long gap means true half-life is long
  if (elapsedHours > 0 && responseTimeMs < cfg.selfCorrectionThreshold) {
    newStability = Math.max(newStability, elapsedHours * 1.5);
  }

  return Math.min(newStability, cfg.maxStability);
}

/**
 * Compute new stability after a wrong answer.
 * Reduces stability but floors at initialStability.
 */
function computeStabilityAfterWrong(oldStability, cfg) {
  if (oldStability == null) return cfg.initialStability;
  return Math.max(cfg.initialStability, oldStability * cfg.stabilityDecayOnWrong);
}

/**
 * Compute selection weight for an item.
 * - Unseen items get unseenBoost (high weight for exploration).
 * - Seen items get ewma / minTime (slower = heavier),
 *   scaled by recall factor (low recall = more weight).
 */
function computeWeight(stats, cfg) {
  if (!stats) {
    return cfg.unseenBoost;
  }
  const speedWeight = Math.max(stats.ewma, cfg.minTime) / cfg.minTime;
  // If we have stability data, factor in recall
  if (stats.stability != null && stats.lastCorrectAt != null) {
    const elapsedHours = (Date.now() - stats.lastCorrectAt) / 3600000;
    const recall = computeRecall(stats.stability, elapsedHours);
    // recallWeight: 1.0 (perfect recall) to 2.0 (fully forgotten)
    const recallWeight = recall != null ? 1 + (1 - recall) : 1;
    return speedWeight * recallWeight;
  }
  return speedWeight;
}

/**
 * Weighted random selection. rand should be in [0, 1).
 * Injected for deterministic testing.
 */
function selectWeighted(items, weights, rand) {
  const totalWeight = weights.reduce((sum, w) => sum + w, 0);
  if (totalWeight === 0) {
    return items[Math.floor(rand * items.length)];
  }
  let remaining = rand * totalWeight;
  for (let i = 0; i < items.length; i++) {
    remaining -= weights[i];
    if (remaining <= 0) return items[i];
  }
  return items[items.length - 1];
}

// ---------------------------------------------------------------------------
// Selector factory (storage-injected — works with localStorage or Map)
// ---------------------------------------------------------------------------

function createAdaptiveSelector(
  storage,
  cfg = DEFAULT_CONFIG,
  randomFn = Math.random,
) {
  function recordResponse(itemId, timeMs, correct = true) {
    const clamped = Math.min(timeMs, cfg.maxResponseTime);
    const existing = storage.getStats(itemId);
    const now = Date.now();

    if (correct) {
      const elapsedHours = existing && existing.lastCorrectAt
        ? (now - existing.lastCorrectAt) / 3600000
        : null;
      if (existing) {
        const newEwma = computeEwma(existing.ewma, clamped, cfg.ewmaAlpha);
        const newTimes = [...existing.recentTimes, clamped].slice(
          -cfg.maxStoredTimes,
        );
        const newStability = updateStability(
          existing.stability ?? null, clamped, elapsedHours, cfg,
        );
        storage.saveStats(itemId, {
          recentTimes: newTimes,
          ewma: newEwma,
          sampleCount: existing.sampleCount + 1,
          lastSeen: now,
          stability: newStability,
          lastCorrectAt: now,
        });
      } else {
        storage.saveStats(itemId, {
          recentTimes: [clamped],
          ewma: clamped,
          sampleCount: 1,
          lastSeen: now,
          stability: cfg.initialStability,
          lastCorrectAt: now,
        });
      }
    } else {
      // Wrong answer: reduce stability, update lastSeen, don't touch EWMA
      if (existing) {
        const newStability = computeStabilityAfterWrong(
          existing.stability ?? null, cfg,
        );
        storage.saveStats(itemId, {
          ...existing,
          lastSeen: now,
          stability: newStability,
        });
      } else {
        // First interaction is wrong: create minimal stats
        storage.saveStats(itemId, {
          recentTimes: [],
          ewma: cfg.maxResponseTime,
          sampleCount: 0,
          lastSeen: now,
          stability: cfg.initialStability,
          lastCorrectAt: null,
        });
      }
    }
  }

  function getWeight(itemId) {
    return computeWeight(storage.getStats(itemId), cfg);
  }

  function getStats(itemId) {
    return storage.getStats(itemId);
  }

  function selectNext(validItems) {
    if (validItems.length === 0) {
      throw new Error("validItems cannot be empty");
    }
    if (validItems.length === 1) {
      storage.setLastSelected(validItems[0]);
      return validItems[0];
    }

    const lastSelected = storage.getLastSelected();
    const weights = validItems.map((id) =>
      id === lastSelected ? 0 : getWeight(id),
    );

    const selected = selectWeighted(validItems, weights, randomFn());
    storage.setLastSelected(selected);
    return selected;
  }

  function getRecall(itemId) {
    const stats = storage.getStats(itemId);
    if (!stats || stats.stability == null || stats.lastCorrectAt == null) {
      return null;
    }
    const elapsedHours = (Date.now() - stats.lastCorrectAt) / 3600000;
    return computeRecall(stats.stability, elapsedHours);
  }

  function getAutomaticity(itemId) {
    const stats = storage.getStats(itemId);
    if (!stats) return null;
    const recall = getRecall(itemId);
    const speed = computeSpeedScore(stats.ewma, cfg);
    return computeAutomaticity(recall, speed);
  }

  /**
   * Recommend strings to review. Returns array of
   * { string, dueCount, unseenCount, masteredCount, totalCount }
   * sorted by needsWork (dueCount + unseenCount) descending.
   * getItemIds(stringIndex) should return the item IDs for that string.
   *
   * - unseenCount: items with no recall data (never answered correctly)
   * - dueCount: items with established recall that dropped below threshold
   * - masteredCount: items with recall >= threshold (currently retained)
   */
  function getStringRecommendations(stringIndices, getItemIds) {
    const results = stringIndices.map((s) => {
      const items = getItemIds(s);
      let dueCount = 0;
      let unseenCount = 0;
      let masteredCount = 0;
      for (const id of items) {
        const recall = getRecall(id);
        if (recall === null) {
          unseenCount++;
        } else if (recall < cfg.recallThreshold) {
          dueCount++;
        } else {
          masteredCount++;
        }
      }
      return { string: s, dueCount, unseenCount, masteredCount, totalCount: items.length };
    });
    results.sort((a, b) => (b.dueCount + b.unseenCount) - (a.dueCount + a.unseenCount));
    return results;
  }

  /**
   * Check if all items have recall >= recallThreshold.
   * Returns false if any item is unseen or below threshold.
   */
  function checkAllMastered(items) {
    for (const id of items) {
      const recall = getRecall(id);
      if (recall === null || recall < cfg.recallThreshold) return false;
    }
    return items.length > 0;
  }

  return { recordResponse, selectNext, getStats, getWeight, getRecall, getAutomaticity, getStringRecommendations, checkAllMastered };
}

// ---------------------------------------------------------------------------
// In-memory storage (for tests)
// ---------------------------------------------------------------------------

function createMemoryStorage() {
  const stats = new Map();
  let lastSelected = null;

  return {
    getStats(itemId) {
      return stats.get(itemId) ?? null;
    },
    saveStats(itemId, s) {
      stats.set(itemId, s);
    },
    getLastSelected() {
      return lastSelected;
    },
    setLastSelected(itemId) {
      lastSelected = itemId;
    },
  };
}

// ---------------------------------------------------------------------------
// localStorage-backed storage (for browser)
// ---------------------------------------------------------------------------

function createLocalStorageAdapter(namespace) {
  const cache = {};
  const mkKey = (itemId) => `adaptive_${namespace}_${itemId}`;
  const lastKey = `adaptive_${namespace}_lastSelected`;

  return {
    getStats(itemId) {
      const k = mkKey(itemId);
      if (!(k in cache)) {
        const data = localStorage.getItem(k);
        try {
          cache[k] = data ? JSON.parse(data) : null;
        } catch {
          cache[k] = null;
        }
      }
      return cache[k];
    },
    saveStats(itemId, stats) {
      const k = mkKey(itemId);
      cache[k] = stats;
      localStorage.setItem(k, JSON.stringify(stats));
    },
    getLastSelected() {
      return localStorage.getItem(lastKey);
    },
    setLastSelected(itemId) {
      localStorage.setItem(lastKey, itemId);
    },
    /** Pre-populate cache to avoid localStorage reads during gameplay. */
    preload(itemIds) {
      for (const itemId of itemIds) {
        this.getStats(itemId);
      }
    },
  };
}

// Shared music theory data: notes, intervals, and helpers.
// Used by all quiz modes. This is an ES module — main.ts strips
// "export" keywords for browser inlining (same pattern as adaptive.js).

const NOTES = [
  { name: 'C',  displayName: 'C',     num: 0,  accepts: ['c'] },
  { name: 'C#', displayName: 'C#/Db', num: 1,  accepts: ['c#', 'db'] },
  { name: 'D',  displayName: 'D',     num: 2,  accepts: ['d'] },
  { name: 'D#', displayName: 'D#/Eb', num: 3,  accepts: ['d#', 'eb'] },
  { name: 'E',  displayName: 'E',     num: 4,  accepts: ['e'] },
  { name: 'F',  displayName: 'F',     num: 5,  accepts: ['f'] },
  { name: 'F#', displayName: 'F#/Gb', num: 6,  accepts: ['f#', 'gb'] },
  { name: 'G',  displayName: 'G',     num: 7,  accepts: ['g'] },
  { name: 'G#', displayName: 'G#/Ab', num: 8,  accepts: ['g#', 'ab'] },
  { name: 'A',  displayName: 'A',     num: 9,  accepts: ['a'] },
  { name: 'A#', displayName: 'A#/Bb', num: 10, accepts: ['a#', 'bb'] },
  { name: 'B',  displayName: 'B',     num: 11, accepts: ['b'] },
];

const NATURAL_NOTES = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];

const INTERVALS = [
  { name: 'minor 2nd',   num: 1,  abbrev: 'm2' },
  { name: 'Major 2nd',   num: 2,  abbrev: 'M2' },
  { name: 'minor 3rd',   num: 3,  abbrev: 'm3' },
  { name: 'Major 3rd',   num: 4,  abbrev: 'M3' },
  { name: 'Perfect 4th',  num: 5,  abbrev: 'P4' },
  { name: 'Tritone',      num: 6,  abbrev: 'TT', altAbbrevs: ['A4', 'd5'] },
  { name: 'Perfect 5th',  num: 7,  abbrev: 'P5' },
  { name: 'minor 6th',   num: 8,  abbrev: 'm6' },
  { name: 'Major 6th',   num: 9,  abbrev: 'M6' },
  { name: 'minor 7th',   num: 10, abbrev: 'm7' },
  { name: 'Major 7th',   num: 11, abbrev: 'M7' },
  { name: 'Octave',       num: 12, abbrev: 'P8' },
];

/** Look up a note by its semitone number (0–11). */
function noteByNum(num) {
  return NOTES[((num % 12) + 12) % 12];
}

/** Look up an interval by its semitone count (1–12). */
function intervalByNum(num) {
  return INTERVALS.find(i => i.num === num) || null;
}

/** Add semitones to a note number, wrapping at 12. Returns the result note. */
function noteAdd(noteNum, semitones) {
  return noteByNum(noteNum + semitones);
}

/** Subtract semitones from a note number, wrapping at 12. Returns the result note. */
function noteSub(noteNum, semitones) {
  return noteByNum(noteNum - semitones);
}

/** Check if a user input matches any accepted answer for a note. */
function noteMatchesInput(note, input) {
  return note.accepts.includes(input.toLowerCase());
}

/** Check if a user input matches an interval abbreviation (case-sensitive). */
function intervalMatchesInput(interval, input) {
  if (input === interval.abbrev) return true;
  if (interval.altAbbrevs && interval.altAbbrevs.includes(input)) return true;
  return false;
}

// Guitar-specific data
const STRING_NAMES = ['e', 'B', 'G', 'D', 'A', 'E'];
const STRING_OFFSETS = [4, 11, 7, 2, 9, 4]; // semitones from C

// Shared quiz engine: manages adaptive selection, timing, countdown,
// feedback, and keyboard/tap handling for all quiz modes.
//
// Each quiz mode provides a config object; the engine handles the
// shared lifecycle. ES module — exports stripped for browser inlining.

const TARGET_TIME = 3000;

/**
 * Create a keyboard handler for note input (C D E F G A B + #/b for accidentals).
 * Used by any mode where the answer is a note name.
 *
 * The handler keeps an internal timeout to allow a short window after a note key
 * is pressed for an accidental key (`#` / `b`) to be entered. Callers should
 * invoke `reset()` when the quiz stops and before restarting to clear any pending
 * note and prevent stale input from being submitted after the quiz has ended.
 *
 * @param {function} submitAnswer - Called with the note string (e.g. 'C', 'C#', 'Db')
 * @param {function} [allowAccidentals] - Returns true if accidentals are enabled
 * @returns {{ handleKey(e): boolean, reset(): void }}
 */
function createNoteKeyHandler(submitAnswer, allowAccidentals = () => true) {
  let pendingNote = null;
  let pendingTimeout = null;

  function reset() {
    if (pendingTimeout) clearTimeout(pendingTimeout);
    pendingNote = null;
    pendingTimeout = null;
  }

  function handleKey(e) {
    const key = e.key.toUpperCase();

    // Handle # for sharps or b for flats after a pending note
    if (pendingNote && allowAccidentals()) {
      if (e.key === '#' || (e.shiftKey && e.key === '3')) {
        e.preventDefault();
        clearTimeout(pendingTimeout);
        submitAnswer(pendingNote + '#');
        pendingNote = null;
        pendingTimeout = null;
        return true;
      }
      if (e.key === 'b' || e.key === 'B') {
        e.preventDefault();
        clearTimeout(pendingTimeout);
        submitAnswer(pendingNote + 'b');
        pendingNote = null;
        pendingTimeout = null;
        return true;
      }
    }

    if ('CDEFGAB'.includes(key)) {
      e.preventDefault();
      if (pendingTimeout) clearTimeout(pendingTimeout);

      if (!allowAccidentals()) {
        submitAnswer(key);
      } else {
        pendingNote = key;
        pendingTimeout = setTimeout(() => {
          submitAnswer(pendingNote);
          pendingNote = null;
          pendingTimeout = null;
        }, 400);
      }
      return true;
    }

    return false;
  }

  return { handleKey, reset };
}

/**
 * Update aggregate stats display for a set of item IDs.
 * Currently a no-op (median display was removed).
 */
function updateModeStats(selector, itemIds, statsEl) {
  if (!statsEl) return;
  statsEl.textContent = '';
}

/**
 * Create a quiz engine for a given mode.
 *
 * @param {object} mode - Quiz mode configuration:
 *   mode.id           - Unique mode identifier
 *   mode.storageNamespace - Key prefix for adaptive storage
 *   mode.getEnabledItems() - Returns array of item IDs eligible for quiz
 *   mode.presentQuestion(itemId) - Updates DOM to show the question
 *   mode.checkAnswer(itemId, input) - Returns { correct, correctAnswer }
 *   mode.onStart()    - Called when quiz starts (optional)
 *   mode.onStop()     - Called when quiz stops (optional)
 *   mode.handleKey(e, state) - Mode-specific key handling, return true if handled (optional)
 *
 * @param {HTMLElement} container - Root element containing quiz DOM elements.
 *   Expected children (found by class):
 *     .countdown-bar, .feedback, .time-display, .hint,
 *     .start-btn, .stop-btn, .heatmap-btn, .stats,
 *     .stats-controls
 *
 * @returns {{ start, stop, submitAnswer, isActive, selector, storage }}
 */
function createQuizEngine(mode, container) {
  const storage = createLocalStorageAdapter(mode.storageNamespace);
  const selector = createAdaptiveSelector(storage);

  let active = false;
  let currentItemId = null;
  let answered = false;
  let questionStartTime = null;
  let countdownInterval = null;
  let expired = false;

  // DOM references (scoped to container)
  const els = {
    countdownBar: container.querySelector('.countdown-bar'),
    feedback: container.querySelector('.feedback'),
    timeDisplay: container.querySelector('.time-display'),
    hint: container.querySelector('.hint'),
    startBtn: container.querySelector('.start-btn'),
    stopBtn: container.querySelector('.stop-btn'),
    heatmapBtn: container.querySelector('.heatmap-btn'),
    stats: container.querySelector('.stats'),
    statsControls: container.querySelector('.stats-controls'),
    quizArea: container.querySelector('.quiz-area'),
    masteryMessage: container.querySelector('.mastery-message'),
  };

  function startCountdown() {
    const bar = els.countdownBar;
    if (!bar) return;
    bar.style.width = '100%';
    bar.classList.remove('expired');
    expired = false;

    if (countdownInterval) clearInterval(countdownInterval);

    const startTime = Date.now();
    countdownInterval = setInterval(() => {
      const elapsed = Date.now() - startTime;
      const remaining = Math.max(0, TARGET_TIME - elapsed);
      bar.style.width = (remaining / TARGET_TIME) * 100 + '%';

      if (remaining === 0 && !expired) {
        expired = true;
        bar.classList.add('expired');
        clearInterval(countdownInterval);
      }
    }, 50);
  }

  function clearFeedback() {
    if (els.feedback) {
      els.feedback.textContent = '';
      els.feedback.className = 'feedback';
    }
    if (els.timeDisplay) els.timeDisplay.textContent = '';
    if (els.hint) els.hint.textContent = '';
  }

  function setAnswerButtonsEnabled(enabled) {
    container.querySelectorAll('.answer-btn, .note-btn').forEach(btn => {
      btn.disabled = !enabled;
      // pointer-events: none lets taps fall through to the parent so
      // the tap-to-advance handler still fires on mobile (disabled
      // buttons swallow click events and prevent bubbling).
      btn.style.pointerEvents = enabled ? '' : 'none';
    });
  }

  function nextQuestion() {
    const items = mode.getEnabledItems();
    if (items.length === 0) return;

    currentItemId = selector.selectNext(items);
    answered = false;
    clearFeedback();
    setAnswerButtonsEnabled(true);
    mode.presentQuestion(currentItemId);
    questionStartTime = Date.now();
    startCountdown();
  }

  function submitAnswer(input) {
    if (!active || answered) return;

    const responseTime = Date.now() - questionStartTime;

    if (countdownInterval) {
      clearInterval(countdownInterval);
      countdownInterval = null;
    }

    answered = true;
    setAnswerButtonsEnabled(false);

    const result = mode.checkAnswer(currentItemId, input);

    if (result.correct) {
      if (els.feedback) {
        els.feedback.textContent = 'Correct!';
        els.feedback.className = 'feedback correct';
      }
      selector.recordResponse(currentItemId, responseTime, true);
    } else {
      if (els.feedback) {
        els.feedback.textContent = 'Incorrect \u2014 ' + result.correctAnswer;
        els.feedback.className = 'feedback incorrect';
      }
      selector.recordResponse(currentItemId, responseTime, false);
    }

    if (els.timeDisplay) els.timeDisplay.textContent = responseTime + ' ms';
    if (els.hint) els.hint.textContent = 'Tap anywhere or press Space for next';

    // Let the mode react to the answer (e.g., highlight correct position)
    if (mode.onAnswer) {
      mode.onAnswer(currentItemId, result, responseTime);
    }

    // Check if all enabled items are mastered
    if (els.masteryMessage) {
      const allMastered = selector.checkAllMastered(mode.getEnabledItems());
      els.masteryMessage.style.display = allMastered ? 'block' : 'none';
    }
  }

  function start() {
    active = true;
    // Call onStart first so modes can tear down their idle UI (e.g. heatmap)
    // before the engine sets up the quiz UI state.
    if (mode.onStart) mode.onStart();
    if (els.masteryMessage) els.masteryMessage.style.display = 'none';
    if (els.startBtn) els.startBtn.style.display = 'none';
    if (els.heatmapBtn) els.heatmapBtn.style.display = 'none';
    if (els.statsControls) els.statsControls.style.display = 'none';
    if (els.stopBtn) els.stopBtn.style.display = 'inline';
    if (els.quizArea) els.quizArea.classList.add('active');
    nextQuestion();
  }

  function stop() {
    active = false;
    if (countdownInterval) {
      clearInterval(countdownInterval);
      countdownInterval = null;
    }
    if (els.startBtn) els.startBtn.style.display = 'inline';
    if (els.heatmapBtn) els.heatmapBtn.style.display = 'inline';
    if (els.statsControls) els.statsControls.style.display = '';
    if (els.stopBtn) els.stopBtn.style.display = 'none';
    if (els.quizArea) els.quizArea.classList.remove('active');
    if (mode.onStop) mode.onStop();
  }

  // Keyboard handler — delegates mode-specific keys, handles shared keys
  function handleKeydown(e) {
    if (!active) return;

    if (e.key === 'Escape') {
      stop();
      return;
    }

    if ((e.key === ' ' || e.key === 'Enter') && answered) {
      e.preventDefault();
      nextQuestion();
      return;
    }

    // Delegate to mode for answer-specific keys
    if (!answered && mode.handleKey) {
      mode.handleKey(e, { submitAnswer });
    }
  }

  // Tap-to-advance handler
  function handleClick(e) {
    if (!active || !answered) return;
    if (e.target.closest('.answer-btn, .note-btn, .quiz-controls, .string-toggle')) return;
    nextQuestion();
  }

  // Attach event listeners: keyboard on document (global), clicks on container
  function attach() {
    document.addEventListener('keydown', handleKeydown);
    container.addEventListener('click', handleClick);
  }

  function detach() {
    document.removeEventListener('keydown', handleKeydown);
    container.removeEventListener('click', handleClick);
  }

  return {
    start,
    stop,
    submitAnswer,
    nextQuestion,
    attach,
    detach,
    get isActive() { return active; },
    get isAnswered() { return answered; },
    selector,
    storage,
    els,
  };
}

// Stats display helpers: shared color functions, table rendering for lookup
// modes, and heatmap grid rendering for math modes.
//
// ES module — main.ts strips "export" keywords for browser inlining.
// Depends on globals (browser): NOTES, INTERVALS

function getAutomaticityColor(auto) {
  if (auto === null) return '#ddd';
  if (auto > 0.8) return 'hsl(120, 60%, 65%)';
  if (auto > 0.6) return 'hsl(80, 60%, 65%)';
  if (auto > 0.4) return 'hsl(50, 60%, 65%)';
  if (auto > 0.2) return 'hsl(30, 60%, 65%)';
  return 'hsl(0, 60%, 65%)';
}

function getSpeedHeatmapColor(ms) {
  if (ms === null) return '#ddd';
  if (ms < 1500) return 'hsl(120, 60%, 65%)';
  if (ms < 3000) return 'hsl(80, 60%, 65%)';
  if (ms < 4500) return 'hsl(50, 60%, 65%)';
  if (ms < 6000) return 'hsl(30, 60%, 65%)';
  return 'hsl(0, 60%, 65%)';
}

function getStatsCellColor(selector, itemId, statsMode) {
  if (statsMode === 'retention') {
    return getAutomaticityColor(selector.getAutomaticity(itemId));
  }
  const stats = selector.getStats(itemId);
  return getSpeedHeatmapColor(stats ? stats.ewma : null);
}

/**
 * Render a reference table for bidirectional lookup modes.
 *
 * @param {object}   selector  - adaptive selector instance
 * @param {Array}    rows      - [{ label, sublabel, _colHeader, fwdItemId, revItemId }]
 * @param {string}   fwdHeader - column header for forward direction (e.g. "N\u2192#")
 * @param {string}   revHeader - column header for reverse direction (e.g. "#\u2192N")
 * @param {string}   statsMode - 'retention' | 'speed'
 * @param {Element}  containerEl
 */
function renderStatsTable(selector, rows, fwdHeader, revHeader, statsMode, containerEl) {
  if (!rows || rows.length === 0) { containerEl.innerHTML = ''; return; }
  let html = '<table class="stats-table"><thead><tr>';
  html += '<th>' + rows[0]._colHeader + '</th><th>#</th>';
  html += '<th>' + fwdHeader + '</th><th>' + revHeader + '</th>';
  html += '</tr></thead><tbody>';

  for (const row of rows) {
    const fwdColor = getStatsCellColor(selector, row.fwdItemId, statsMode);
    const revColor = getStatsCellColor(selector, row.revItemId, statsMode);
    html += '<tr>';
    html += '<td>' + row.label + '</td>';
    html += '<td>' + row.sublabel + '</td>';
    html += '<td class="stats-cell" style="background:' + fwdColor + '"></td>';
    html += '<td class="stats-cell" style="background:' + revColor + '"></td>';
    html += '</tr>';
  }

  html += '</tbody></table>';
  containerEl.innerHTML = html;
}

/**
 * Render a heatmap grid for math modes (12 notes x 11 offsets/intervals).
 *
 * @param {object}   selector    - adaptive selector instance
 * @param {Array}    colLabels   - column header labels (e.g. ["1","2",...] or ["m2","M2",...])
 * @param {Function} getItemId   - (noteName, colIndex) => itemId string
 * @param {string}   statsMode   - 'retention' | 'speed'
 * @param {Element}  containerEl
 * @param {Array}    [notes]     - optional notes array (defaults to global NOTES)
 */
function renderStatsGrid(selector, colLabels, getItemId, statsMode, containerEl, notes) {
  const noteList = notes || NOTES;
  let html = '<table class="stats-grid"><thead><tr><th></th>';
  for (const col of colLabels) {
    html += '<th>' + col + '</th>';
  }
  html += '</tr></thead><tbody>';

  for (const note of noteList) {
    html += '<tr><td class="stats-grid-row-label">' + (note.displayName || note.name) + '</td>';
    for (let i = 0; i < colLabels.length; i++) {
      const itemId = getItemId(note.name, i);
      const color = getStatsCellColor(selector, itemId, statsMode);
      html += '<td class="stats-cell" style="background:' + color + '"></td>';
    }
    html += '</tr>';
  }

  html += '</tbody></table>';
  containerEl.innerHTML = html;
}

/**
 * Build a shared legend HTML string.
 */
function buildStatsLegend(statsMode) {
  if (statsMode === 'retention') {
    return '<div class="heatmap-legend active">'
      + '<div class="legend-item"><div class="legend-swatch" style="background:#ddd"></div>No data</div>'
      + '<div class="legend-item"><div class="legend-swatch" style="background:hsl(120,60%,65%)"></div>Automatic (&gt;80%)</div>'
      + '<div class="legend-item"><div class="legend-swatch" style="background:hsl(80,60%,65%)"></div>Solid (&gt;60%)</div>'
      + '<div class="legend-item"><div class="legend-swatch" style="background:hsl(50,60%,65%)"></div>Getting there (&gt;40%)</div>'
      + '<div class="legend-item"><div class="legend-swatch" style="background:hsl(30,60%,65%)"></div>Fading (&gt;20%)</div>'
      + '<div class="legend-item"><div class="legend-swatch" style="background:hsl(0,60%,65%)"></div>Needs work (&lt;20%)</div>'
      + '</div>';
  }
  return '<div class="heatmap-legend active">'
    + '<div class="legend-item"><div class="legend-swatch" style="background:#ddd"></div>No data</div>'
    + '<div class="legend-item"><div class="legend-swatch" style="background:hsl(120,60%,65%)"></div>&lt; 1.5s</div>'
    + '<div class="legend-item"><div class="legend-swatch" style="background:hsl(80,60%,65%)"></div>1.5\u20133s</div>'
    + '<div class="legend-item"><div class="legend-swatch" style="background:hsl(50,60%,65%)"></div>3\u20134.5s</div>'
    + '<div class="legend-item"><div class="legend-swatch" style="background:hsl(30,60%,65%)"></div>4.5\u20136s</div>'
    + '<div class="legend-item"><div class="legend-swatch" style="background:hsl(0,60%,65%)"></div>&gt; 6s</div>'
    + '</div>';
}

// Fretboard quiz mode: identify the note at a highlighted fretboard position.
// Plugs into the shared quiz engine via the mode interface.
//
// Depends on globals: NOTES, NATURAL_NOTES, STRING_OFFSETS,
// noteMatchesInput, createQuizEngine, DEFAULT_CONFIG,
// getAutomaticityColor, getSpeedHeatmapColor, buildStatsLegend

function createFretboardMode() {
  const container = document.getElementById('mode-fretboard');
  const STRINGS_KEY = 'fretboard_enabledStrings';
  let enabledStrings = new Set([5]); // Default: low E only
  let naturalsOnly = true;
  let recommendedStrings = new Set();
  let heatmapMode = null;

  // --- Note helpers (match original app.js behavior) ---

  const noteNames = NOTES.map(n => n.name);

  function getNoteAtPosition(string, fret) {
    const offset = STRING_OFFSETS[string];
    const noteIndex = (offset + fret) % 12;
    return noteNames[noteIndex];
  }

  // --- SVG helpers ---

  function highlightCircle(string, fret, color) {
    const circle = container.querySelector(
      `circle[data-string="${string}"][data-fret="${fret}"]`
    );
    if (circle) circle.setAttribute('fill', color);
  }

  function showNoteText(string, fret) {
    const text = container.querySelector(
      `text[data-string="${string}"][data-fret="${fret}"]`
    );
    if (text) text.textContent = getNoteAtPosition(string, fret);
  }

  function clearAll() {
    container.querySelectorAll('.note-circle').forEach(c => c.setAttribute('fill', 'white'));
    container.querySelectorAll('.note-text').forEach(t => t.textContent = '');
  }

  // --- String toggles ---

  function loadEnabledStrings() {
    const saved = localStorage.getItem(STRINGS_KEY);
    if (saved) {
      try { enabledStrings = new Set(JSON.parse(saved)); } catch {}
    }
    updateStringToggles();
  }

  function saveEnabledStrings() {
    localStorage.setItem(STRINGS_KEY, JSON.stringify([...enabledStrings]));
  }

  function updateStringToggles() {
    container.querySelectorAll('.string-toggle').forEach(btn => {
      const s = parseInt(btn.dataset.string);
      btn.classList.toggle('active', enabledStrings.has(s));
      btn.classList.toggle('recommended', recommendedStrings.has(s));
    });
  }

  function toggleString(s) {
    if (enabledStrings.has(s)) {
      if (enabledStrings.size > 1) enabledStrings.delete(s);
    } else {
      enabledStrings.add(s);
    }
    saveEnabledStrings();
    updateStringToggles();
  }

  // --- Heatmap ---
  // Color functions: getAutomaticityColor, getSpeedHeatmapColor from stats-display.js

  function showHeatmapView(mode, selector) {
    heatmapMode = mode;
    const btn = container.querySelector('.heatmap-btn');
    const statsContainer = container.querySelector('.stats-container');

    // Populate legend via shared helper
    statsContainer.innerHTML = buildStatsLegend(mode);
    statsContainer.style.display = '';

    if (mode === 'retention') {
      btn.textContent = 'Show Speed';
      for (let s = 0; s <= 5; s++) {
        for (let f = 0; f < 13; f++) {
          const auto = selector.getAutomaticity(`${s}-${f}`);
          highlightCircle(s, f, getAutomaticityColor(auto));
          showNoteText(s, f);
        }
      }
    } else {
      btn.textContent = 'Show Recall';
      for (let s = 0; s <= 5; s++) {
        for (let f = 0; f < 13; f++) {
          const stats = selector.getStats(`${s}-${f}`);
          const ewma = stats ? stats.ewma : null;
          highlightCircle(s, f, getSpeedHeatmapColor(ewma));
          showNoteText(s, f);
        }
      }
    }
  }

  function hideHeatmap() {
    heatmapMode = null;
    container.querySelector('.heatmap-btn').textContent = 'Show Recall';
    clearAll();
    const statsContainer = container.querySelector('.stats-container');
    statsContainer.style.display = 'none';
    statsContainer.innerHTML = '';
  }

  function toggleHeatmap(selector) {
    if (heatmapMode === 'retention') {
      showHeatmapView('speed', selector);
    } else {
      showHeatmapView('retention', selector);
    }
  }

  // --- Stats ---

  function updateStats(selector) {
    const statsEl = container.querySelector('.stats');
    if (statsEl) statsEl.textContent = '';
  }

  // --- Recommendations ---

  function getItemIdsForString(s) {
    const items = [];
    for (let f = 0; f < 13; f++) {
      const note = getNoteAtPosition(s, f);
      if (!naturalsOnly || NATURAL_NOTES.includes(note)) {
        items.push(`${s}-${f}`);
      }
    }
    return items;
  }

  function applyRecommendations(selector) {
    const allStrings = [0, 1, 2, 3, 4, 5];
    const recs = selector.getStringRecommendations(allStrings, getItemIdsForString);

    const started = recs.filter(r => r.unseenCount < r.totalCount);
    const unstarted = recs.filter(r => r.unseenCount === r.totalCount);

    if (started.length === 0) {
      recommendedStrings = new Set();
      updateStringToggles();
      return;
    }

    const totalSeen = started.reduce((sum, r) => sum + (r.masteredCount + r.dueCount), 0);
    const totalMastered = started.reduce((sum, r) => sum + r.masteredCount, 0);
    const consolidatedRatio = totalSeen > 0 ? totalMastered / totalSeen : 0;

    const startedByWork = [...started].sort(
      (a, b) => (b.dueCount + b.unseenCount) - (a.dueCount + a.unseenCount)
    );

    const workCounts = startedByWork.map(r => r.dueCount + r.unseenCount);
    const medianWork = workCounts[Math.floor(workCounts.length / 2)];
    recommendedStrings = new Set();
    const newEnabled = new Set();
    for (const r of startedByWork) {
      if (r.dueCount + r.unseenCount > medianWork) {
        recommendedStrings.add(r.string);
        newEnabled.add(r.string);
      }
    }
    if (newEnabled.size === 0) {
      recommendedStrings.add(startedByWork[0].string);
      newEnabled.add(startedByWork[0].string);
    }

    if (consolidatedRatio >= DEFAULT_CONFIG.expansionThreshold && unstarted.length > 0) {
      recommendedStrings.add(unstarted[0].string);
      newEnabled.add(unstarted[0].string);
    }

    if (newEnabled.size > 0) {
      enabledStrings = newEnabled;
      saveEnabledStrings();
    }
    updateStringToggles();
  }

  // --- Accidental buttons ---

  function updateAccidentalButtons() {
    container.querySelectorAll('.note-btn.accidental').forEach(btn => {
      btn.classList.toggle('hidden', naturalsOnly);
    });
  }

  // --- Quiz mode interface ---

  // Track current question for answer checking
  let currentString = null;
  let currentFret = null;
  let currentNote = null;

  const mode = {
    id: 'fretboard',
    name: 'Fretboard',
    storageNamespace: 'fretboard',

    getEnabledItems() {
      const items = [];
      for (const s of enabledStrings) {
        for (let f = 0; f < 13; f++) {
          const note = getNoteAtPosition(s, f);
          if (!naturalsOnly || NATURAL_NOTES.includes(note)) {
            items.push(`${s}-${f}`);
          }
        }
      }
      return items;
    },

    presentQuestion(itemId) {
      clearAll();
      const [s, f] = itemId.split('-').map(Number);
      currentString = s;
      currentFret = f;
      currentNote = getNoteAtPosition(s, f);
      highlightCircle(s, f, '#FFD700');
    },

    checkAnswer(itemId, input) {
      const note = NOTES.find(n => n.name === currentNote);
      const correct = note && noteMatchesInput(note, input);
      return { correct, correctAnswer: currentNote };
    },

    onAnswer(itemId, result, responseTime) {
      if (result.correct) {
        highlightCircle(currentString, currentFret, '#4CAF50');
      } else {
        highlightCircle(currentString, currentFret, '#f44336');
      }
      showNoteText(currentString, currentFret);
    },

    onStart() {
      if (heatmapMode) hideHeatmap();
      updateStats(engine.selector);
    },

    onStop() {
      clearAll();
      updateStats(engine.selector);
      showHeatmapView('retention', engine.selector);
    },

    handleKey(e, { submitAnswer }) {
      const key = e.key.toUpperCase();

      // Handle # for sharps or b for flats
      if (pendingNote && !naturalsOnly) {
        if (e.key === '#' || (e.shiftKey && e.key === '3')) {
          e.preventDefault();
          clearTimeout(pendingTimeout);
          submitAnswer(pendingNote + '#');
          pendingNote = null;
          pendingTimeout = null;
          return true;
        }
        if (e.key === 'b' || e.key === 'B') {
          e.preventDefault();
          clearTimeout(pendingTimeout);
          submitAnswer(pendingNote + 'b');
          pendingNote = null;
          pendingTimeout = null;
          return true;
        }
      }

      if ('CDEFGAB'.includes(key)) {
        e.preventDefault();
        if (pendingTimeout) clearTimeout(pendingTimeout);

        if (naturalsOnly) {
          submitAnswer(key);
        } else {
          pendingNote = key;
          pendingTimeout = setTimeout(() => {
            submitAnswer(pendingNote);
            pendingNote = null;
            pendingTimeout = null;
          }, 400);
        }
        return true;
      }

      return false;
    },
  };

  // Keyboard state for accidental handling
  let pendingNote = null;
  let pendingTimeout = null;

  // Create engine
  const engine = createQuizEngine(mode, container);

  // Pre-cache all positions
  const allItemIds = [];
  for (let s = 0; s < 6; s++) {
    for (let f = 0; f < 13; f++) {
      allItemIds.push(`${s}-${f}`);
    }
  }
  engine.storage.preload(allItemIds);

  // --- Wire up DOM ---

  function init() {
    loadEnabledStrings();

    // String toggle handlers
    container.querySelectorAll('.string-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        toggleString(parseInt(btn.dataset.string));
      });
    });

    // Note button handlers
    container.querySelectorAll('.note-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.note);
      });
    });

    // Naturals-only toggle
    const naturalsCheckbox = container.querySelector('#naturals-only');
    if (naturalsCheckbox) {
      naturalsCheckbox.addEventListener('change', (e) => {
        naturalsOnly = e.target.checked;
        updateAccidentalButtons();
      });
    }

    // Start/stop/heatmap buttons
    const startBtn = container.querySelector('.start-btn');
    const stopBtn = container.querySelector('.stop-btn');
    const heatmapBtn = container.querySelector('.heatmap-btn');

    if (startBtn) startBtn.addEventListener('click', () => engine.start());
    if (stopBtn) stopBtn.addEventListener('click', () => engine.stop());
    if (heatmapBtn) heatmapBtn.addEventListener('click', () => toggleHeatmap(engine.selector));

    applyRecommendations(engine.selector);
    updateAccidentalButtons();
    updateStats(engine.selector);
    showHeatmapView('retention', engine.selector);
  }

  return {
    mode,
    engine,
    init,
    activate() {
      engine.attach();
    },
    deactivate() {
      if (engine.isActive) engine.stop();
      engine.detach();
    },
  };
}

// Speed Tap quiz mode: tap all positions of a given note as fast as possible.
// Uses its own quiz loop (not createQuizEngine) since rounds need multi-tap input.
//
// Depends on globals: NOTES, NATURAL_NOTES, STRING_OFFSETS,
// createAdaptiveSelector, createLocalStorageAdapter, updateModeStats,
// getAutomaticityColor, getSpeedHeatmapColor, buildStatsLegend

function createSpeedTapMode() {
  const container = document.getElementById('mode-speedTap');
  const NAMESPACE = 'speedTap';

  let naturalsOnly = true;
  let active = false;
  let roundActive = false;
  let currentNote = null;
  let targetPositions = []; // [{string, fret}]
  let foundPositions = new Set(); // "s-f" strings
  let roundStartTime = null;
  let timerInterval = null;
  let wrongFlashTimeouts = new Set();
  let statsMode = null; // null | 'retention' | 'speed'

  const noteNames = NOTES.map(n => n.name);

  // --- Adaptive system ---
  // Speed tap rounds involve finding 6-8 positions, so response times are
  // much higher than single-tap modes. Adjust config accordingly.
  const SPEED_TAP_CONFIG = Object.assign({}, DEFAULT_CONFIG, {
    minTime: 4000,             // can't tap 6-8 positions in < 4s
    automaticityTarget: 12000, // 12s → speedScore 0.5 (decent pace)
    maxResponseTime: 30000,    // allow tracking up to 30s rounds
  });

  const storage = createLocalStorageAdapter(NAMESPACE);
  const selector = createAdaptiveSelector(storage, SPEED_TAP_CONFIG);

  function preloadStats() {
    for (const note of NOTES) {
      storage.getStats(note.name);
    }
  }

  // --- Note/position helpers ---

  function getNoteAtPosition(string, fret) {
    const offset = STRING_OFFSETS[string];
    return noteNames[(offset + fret) % 12];
  }

  function getPositionsForNote(noteName) {
    const positions = [];
    for (let s = 0; s < 6; s++) {
      for (let f = 0; f <= 12; f++) {
        if (getNoteAtPosition(s, f) === noteName) {
          positions.push({ string: s, fret: f });
        }
      }
    }
    return positions;
  }

  function getEnabledItems() {
    return naturalsOnly ? NATURAL_NOTES.slice() : NOTES.map(n => n.name);
  }

  // --- SVG helpers ---

  function highlightCircle(string, fret, color) {
    const circle = container.querySelector(
      `circle[data-string="${string}"][data-fret="${fret}"]`
    );
    if (circle) circle.setAttribute('fill', color);
  }

  function showNoteText(string, fret) {
    const text = container.querySelector(
      `text[data-string="${string}"][data-fret="${fret}"]`
    );
    if (text) text.textContent = getNoteAtPosition(string, fret);
  }

  function clearNoteText(string, fret) {
    const text = container.querySelector(
      `text[data-string="${string}"][data-fret="${fret}"]`
    );
    if (text) text.textContent = '';
  }

  function clearAll() {
    container.querySelectorAll('.note-circle').forEach(c => c.setAttribute('fill', 'white'));
    container.querySelectorAll('.note-text').forEach(t => t.textContent = '');
  }

  // --- Note stats view ---

  function showNoteStats(mode) {
    mode = mode || 'retention';
    statsMode = mode;
    const statsContainer = container.querySelector('.stats-container');
    const heatmapBtn = container.querySelector('.heatmap-btn');
    if (!statsContainer) return;

    // Always show all 12 notes regardless of naturalsOnly setting
    const notes = NOTES;

    let html = '<table class="stats-table speed-tap-stats"><thead><tr>';
    for (const note of notes) {
      html += '<th>' + note.displayName + '</th>';
    }
    html += '</tr></thead><tbody><tr>';
    for (const note of notes) {
      if (mode === 'retention') {
        const auto = selector.getAutomaticity(note.name);
        html += '<td class="stats-cell" style="background:' + getAutomaticityColor(auto) + '"></td>';
      } else {
        // Normalize to per-position time so the color scale makes sense
        // for multi-tap rounds (6-8 positions per note).
        const stats = selector.getStats(note.name);
        const posCount = getPositionsForNote(note.name).length;
        const perPosMs = stats ? stats.ewma / posCount : null;
        html += '<td class="stats-cell" style="background:' + getSpeedHeatmapColor(perPosMs) + '"></td>';
      }
    }
    html += '</tr></tbody></table>';

    if (mode === 'speed') {
      html += '<div class="heatmap-legend active">'
        + '<div class="legend-item"><div class="legend-swatch" style="background:#ddd"></div>No data</div>'
        + '<div class="legend-item"><div class="legend-swatch" style="background:hsl(120,60%,65%)"></div>&lt; 1.5s/pos</div>'
        + '<div class="legend-item"><div class="legend-swatch" style="background:hsl(80,60%,65%)"></div>1.5\u20133s/pos</div>'
        + '<div class="legend-item"><div class="legend-swatch" style="background:hsl(50,60%,65%)"></div>3\u20134.5s/pos</div>'
        + '<div class="legend-item"><div class="legend-swatch" style="background:hsl(30,60%,65%)"></div>4.5\u20136s/pos</div>'
        + '<div class="legend-item"><div class="legend-swatch" style="background:hsl(0,60%,65%)"></div>&gt; 6s/pos</div>'
        + '</div>';
    } else {
      html += buildStatsLegend(mode);
    }

    statsContainer.innerHTML = html;
    statsContainer.style.display = '';
    if (heatmapBtn) heatmapBtn.textContent = mode === 'retention' ? 'Show Speed' : 'Show Recall';
  }

  function hideNoteStats() {
    statsMode = null;
    const statsContainer = container.querySelector('.stats-container');
    if (statsContainer) {
      statsContainer.style.display = 'none';
      statsContainer.innerHTML = '';
    }
  }

  function toggleNoteStats() {
    if (statsMode === 'retention') {
      showNoteStats('speed');
    } else {
      showNoteStats('retention');
    }
  }

  // --- DOM references ---

  const els = {
    prompt: container.querySelector('.speed-tap-prompt'),
    progress: container.querySelector('.speed-tap-progress'),
    timer: container.querySelector('.speed-tap-timer'),
    feedback: container.querySelector('.feedback'),
    hint: container.querySelector('.hint'),
    startBtn: container.querySelector('.start-btn'),
    stopBtn: container.querySelector('.stop-btn'),
    heatmapBtn: container.querySelector('.heatmap-btn'),
    stats: container.querySelector('.stats'),
    quizArea: container.querySelector('.quiz-area'),
    fretboardWrapper: container.querySelector('.fretboard-wrapper'),
    statsControls: container.querySelector('.stats-controls'),
  };

  // --- Timer ---

  function startTimer() {
    roundStartTime = Date.now();
    updateTimerDisplay();
    timerInterval = setInterval(updateTimerDisplay, 100);
  }

  function stopTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
  }

  function updateTimerDisplay() {
    if (!roundStartTime || !els.timer) return;
    const elapsed = Date.now() - roundStartTime;
    els.timer.textContent = (elapsed / 1000).toFixed(1) + 's';
  }

  // --- Display updates ---

  function updateProgress() {
    if (els.progress) {
      els.progress.textContent = foundPositions.size + ' / ' + targetPositions.length;
    }
  }

  function updateStats() {
    updateModeStats(selector, getEnabledItems(), els.stats);
  }

  // --- Round logic ---

  function nextRound() {
    wrongFlashTimeouts.forEach(t => clearTimeout(t));
    wrongFlashTimeouts.clear();
    clearAll();

    const items = getEnabledItems();
    if (items.length === 0) return;

    currentNote = selector.selectNext(items);
    targetPositions = getPositionsForNote(currentNote);
    foundPositions = new Set();
    roundActive = true;

    if (els.prompt) {
      const note = NOTES.find(n => n.name === currentNote);
      els.prompt.textContent = 'Tap all ' + (note ? note.displayName : currentNote);
    }
    if (els.feedback) {
      els.feedback.textContent = '';
      els.feedback.className = 'feedback';
    }
    if (els.hint) els.hint.textContent = '';

    updateProgress();
    startTimer();
  }

  function completeRound() {
    roundActive = false;
    stopTimer();

    const elapsed = Date.now() - roundStartTime;
    selector.recordResponse(currentNote, elapsed, true);

    if (els.feedback) {
      els.feedback.textContent = (elapsed / 1000).toFixed(1) + 's';
      els.feedback.className = 'feedback correct';
    }
    if (els.hint) els.hint.textContent = 'Tap anywhere or press Space for next';

    updateStats();
  }

  // --- Circle tap handling ---

  function handleCircleTap(string, fret) {
    if (!active || !roundActive) return;

    const key = string + '-' + fret;
    if (foundPositions.has(key)) return;

    const tappedNote = getNoteAtPosition(string, fret);

    if (tappedNote === currentNote) {
      foundPositions.add(key);
      highlightCircle(string, fret, '#4CAF50');
      showNoteText(string, fret);
      updateProgress();

      if (foundPositions.size === targetPositions.length) {
        completeRound();
      }
    } else {
      // Wrong tap — flash red, show actual note, then reset
      highlightCircle(string, fret, '#f44336');
      showNoteText(string, fret);

      const timeout = setTimeout(() => {
        wrongFlashTimeouts.delete(timeout);
        if (!foundPositions.has(key)) {
          highlightCircle(string, fret, 'white');
          clearNoteText(string, fret);
        }
      }, 800);
      wrongFlashTimeouts.add(timeout);
    }
  }

  // --- Event handlers ---

  function handleFretboardClick(e) {
    if (e.target.closest('.quiz-controls, .setting-group')) return;

    if (active && roundActive) {
      const target = e.target.closest('circle[data-string][data-fret]') ||
                     e.target.closest('text[data-string][data-fret]');
      if (target) {
        handleCircleTap(parseInt(target.dataset.string), parseInt(target.dataset.fret));
      }
      return;
    }

    // After round complete, tap anywhere to advance
    if (active && !roundActive && currentNote !== null) {
      nextRound();
    }
  }

  function handleKeydown(e) {
    if (!active) return;

    if (e.key === 'Escape') {
      stop();
      return;
    }

    if ((e.key === ' ' || e.key === 'Enter') && !roundActive && currentNote !== null) {
      e.preventDefault();
      nextRound();
    }
  }

  // --- Start / stop ---

  function start() {
    active = true;
    if (statsMode) hideNoteStats();
    if (els.fretboardWrapper) els.fretboardWrapper.style.display = '';
    if (els.statsControls) els.statsControls.style.display = 'none';
    if (els.startBtn) els.startBtn.style.display = 'none';
    if (els.stopBtn) els.stopBtn.style.display = 'inline';
    if (els.quizArea) els.quizArea.classList.add('active');
    nextRound();
  }

  function stop() {
    active = false;
    roundActive = false;
    stopTimer();
    wrongFlashTimeouts.forEach(t => clearTimeout(t));
    wrongFlashTimeouts.clear();
    clearAll();

    currentNote = null;
    roundStartTime = null;

    if (els.prompt) els.prompt.textContent = '';
    if (els.progress) els.progress.textContent = '';
    if (els.timer) els.timer.textContent = '';
    if (els.feedback) {
      els.feedback.textContent = '';
      els.feedback.className = 'feedback';
    }
    if (els.hint) els.hint.textContent = '';

    if (els.fretboardWrapper) els.fretboardWrapper.style.display = 'none';
    if (els.statsControls) els.statsControls.style.display = '';
    if (els.startBtn) els.startBtn.style.display = 'inline';
    if (els.stopBtn) els.stopBtn.style.display = 'none';
    if (els.quizArea) els.quizArea.classList.remove('active');

    updateStats();
    showNoteStats();
  }

  // --- Lifecycle ---

  function attach() {
    document.addEventListener('keydown', handleKeydown);
    container.addEventListener('click', handleFretboardClick);
  }

  function detach() {
    document.removeEventListener('keydown', handleKeydown);
    container.removeEventListener('click', handleFretboardClick);
  }

  function init() {
    preloadStats();

    const naturalsCheckbox = container.querySelector('#speed-tap-naturals-only');
    if (naturalsCheckbox) {
      naturalsCheckbox.addEventListener('change', (e) => {
        naturalsOnly = e.target.checked;
      });
    }

    if (els.startBtn) els.startBtn.addEventListener('click', () => start());
    if (els.stopBtn) els.stopBtn.addEventListener('click', () => stop());
    if (els.heatmapBtn) els.heatmapBtn.addEventListener('click', () => toggleNoteStats());

    if (els.fretboardWrapper) els.fretboardWrapper.style.display = 'none';
    updateStats();
    showNoteStats();
  }

  return {
    init,
    activate() { attach(); },
    deactivate() {
      if (active) stop();
      detach();
    },
  };
}

// Note Semitones quiz mode: bidirectional note <-> semitone number.
// Forward: "C# = ?" -> 1, Reverse: "3 = ?" -> D#/Eb
// 24 items total (12 notes x 2 directions).
//
// Depends on globals: NOTES, createQuizEngine, createNoteKeyHandler,
// updateModeStats, renderStatsTable, buildStatsLegend

function createNoteSemitonesMode() {
  const container = document.getElementById('mode-noteSemitones');

  // Build item list: 12 notes x 2 directions
  const ALL_ITEMS = [];
  for (const note of NOTES) {
    ALL_ITEMS.push(note.name + ':fwd'); // note -> number
    ALL_ITEMS.push(note.name + ':rev'); // number -> note
  }

  function parseItem(itemId) {
    const [noteName, dir] = itemId.split(':');
    const note = NOTES.find(n => n.name === noteName);
    return { note, dir };
  }

  let currentItem = null;
  let statsMode = null; // null | 'retention' | 'speed'

  // Build row definitions for the stats table
  function getTableRows() {
    return NOTES.map(note => ({
      label: note.displayName,
      sublabel: String(note.num),
      _colHeader: 'Note',
      fwdItemId: note.name + ':fwd',
      revItemId: note.name + ':rev',
    }));
  }

  function showStats(mode) {
    statsMode = mode;
    const statsContainer = container.querySelector('.stats-container');
    const btn = container.querySelector('.heatmap-btn');
    statsContainer.innerHTML = '';
    const tableDiv = document.createElement('div');
    statsContainer.appendChild(tableDiv);
    renderStatsTable(engine.selector, getTableRows(), 'N\u2192#', '#\u2192N', mode, tableDiv);
    const legendDiv = document.createElement('div');
    legendDiv.innerHTML = buildStatsLegend(mode);
    statsContainer.appendChild(legendDiv);
    statsContainer.style.display = '';
    btn.textContent = mode === 'retention' ? 'Show Speed' : 'Show Recall';
  }

  function hideStats() {
    statsMode = null;
    const statsContainer = container.querySelector('.stats-container');
    statsContainer.style.display = 'none';
    statsContainer.innerHTML = '';
  }

  function toggleStats() {
    if (statsMode === 'retention') showStats('speed');
    else showStats('retention');
  }

  const mode = {
    id: 'noteSemitones',
    name: 'Note \u2194 Semitones',
    storageNamespace: 'noteSemitones',

    getEnabledItems() {
      return ALL_ITEMS;
    },

    presentQuestion(itemId) {
      currentItem = parseItem(itemId);
      const prompt = container.querySelector('.quiz-prompt');
      const noteButtons = container.querySelector('.answer-buttons-notes');
      const numButtons = container.querySelector('.answer-buttons-numbers');

      if (currentItem.dir === 'fwd') {
        // Show note, answer is number 0-11
        prompt.textContent = currentItem.note.displayName + ' = ?';
        noteButtons.style.display = 'none';
        numButtons.style.display = '';
      } else {
        // Show number, answer is note
        prompt.textContent = currentItem.note.num + ' = ?';
        noteButtons.style.display = '';
        numButtons.style.display = 'none';
      }
    },

    checkAnswer(itemId, input) {
      if (currentItem.dir === 'fwd') {
        const correct = parseInt(input, 10) === currentItem.note.num;
        return { correct, correctAnswer: String(currentItem.note.num) };
      } else {
        const correct = noteMatchesInput(currentItem.note, input);
        return { correct, correctAnswer: currentItem.note.displayName };
      }
    },

    onStart() {
      noteKeyHandler.reset();
      if (pendingDigitTimeout) clearTimeout(pendingDigitTimeout);
      pendingDigit = null;
      pendingDigitTimeout = null;
      hideStats();
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    },

    onStop() {
      noteKeyHandler.reset();
      if (pendingDigitTimeout) clearTimeout(pendingDigitTimeout);
      pendingDigit = null;
      pendingDigitTimeout = null;
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
      showStats('retention');
    },

    handleKey(e, { submitAnswer }) {
      if (currentItem.dir === 'rev') {
        return noteKeyHandler.handleKey(e);
      }
      // Forward: number keys 0-9 for semitone answer
      if (e.key >= '0' && e.key <= '9') {
        e.preventDefault();
        // Handle two-digit: 10, 11
        if (pendingDigit !== null) {
          const num = pendingDigit * 10 + parseInt(e.key);
          clearTimeout(pendingDigitTimeout);
          pendingDigit = null;
          pendingDigitTimeout = null;
          if (num <= 11) {
            submitAnswer(String(num));
          }
          return true;
        }
        const d = parseInt(e.key);
        if (d >= 2) {
          // Can only be single digit (2-9)
          submitAnswer(String(d));
        } else {
          // 0 or 1 — could be start of 10 or 11
          pendingDigit = d;
          pendingDigitTimeout = setTimeout(() => {
            submitAnswer(String(pendingDigit));
            pendingDigit = null;
            pendingDigitTimeout = null;
          }, 400);
        }
        return true;
      }
      return false;
    },
  };

  let pendingDigit = null;
  let pendingDigitTimeout = null;

  const engine = createQuizEngine(mode, container);
  engine.storage.preload(ALL_ITEMS);

  const noteKeyHandler = createNoteKeyHandler(
    (input) => engine.submitAnswer(input),
    () => true
  );

  function init() {
    // Note answer buttons
    container.querySelectorAll('.answer-btn-note').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.note);
      });
    });

    // Number answer buttons
    container.querySelectorAll('.answer-btn-num').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.num);
      });
    });

    // Start/stop/stats
    container.querySelector('.start-btn').addEventListener('click', () => engine.start());
    container.querySelector('.stop-btn').addEventListener('click', () => engine.stop());
    container.querySelector('.heatmap-btn').addEventListener('click', toggleStats);

    updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    showStats('retention');
  }

  return {
    mode,
    engine,
    init,
    activate() { engine.attach(); },
    deactivate() {
      if (engine.isActive) engine.stop();
      engine.detach();
      noteKeyHandler.reset();
      if (pendingDigitTimeout) clearTimeout(pendingDigitTimeout);
      pendingDigit = null;
    },
  };
}

// Interval Semitones quiz mode: bidirectional interval <-> semitone number.
// Forward: "minor 3rd = ?" -> 3, Reverse: "7 = ?" -> Perfect 5th
// 24 items total (12 intervals x 2 directions).
//
// Depends on globals: INTERVALS, intervalMatchesInput, createQuizEngine,
// updateModeStats, renderStatsTable, buildStatsLegend

function createIntervalSemitonesMode() {
  const container = document.getElementById('mode-intervalSemitones');

  // Build item list: 12 intervals x 2 directions
  const ALL_ITEMS = [];
  for (const interval of INTERVALS) {
    ALL_ITEMS.push(interval.abbrev + ':fwd'); // interval -> number
    ALL_ITEMS.push(interval.abbrev + ':rev'); // number -> interval
  }

  function parseItem(itemId) {
    const [abbrev, dir] = itemId.split(':');
    const interval = INTERVALS.find(i => i.abbrev === abbrev);
    return { interval, dir };
  }

  let currentItem = null;
  let statsMode = null; // null | 'retention' | 'speed'

  function getTableRows() {
    return INTERVALS.map(interval => ({
      label: interval.abbrev,
      sublabel: String(interval.num),
      _colHeader: 'Interval',
      fwdItemId: interval.abbrev + ':fwd',
      revItemId: interval.abbrev + ':rev',
    }));
  }

  function showStats(mode) {
    statsMode = mode;
    const statsContainer = container.querySelector('.stats-container');
    const btn = container.querySelector('.heatmap-btn');
    statsContainer.innerHTML = '';
    const tableDiv = document.createElement('div');
    statsContainer.appendChild(tableDiv);
    renderStatsTable(engine.selector, getTableRows(), 'I\u2192#', '#\u2192I', mode, tableDiv);
    const legendDiv = document.createElement('div');
    legendDiv.innerHTML = buildStatsLegend(mode);
    statsContainer.appendChild(legendDiv);
    statsContainer.style.display = '';
    btn.textContent = mode === 'retention' ? 'Show Speed' : 'Show Recall';
  }

  function hideStats() {
    statsMode = null;
    const statsContainer = container.querySelector('.stats-container');
    statsContainer.style.display = 'none';
    statsContainer.innerHTML = '';
  }

  function toggleStats() {
    if (statsMode === 'retention') showStats('speed');
    else showStats('retention');
  }

  const mode = {
    id: 'intervalSemitones',
    name: 'Interval \u2194 Semitones',
    storageNamespace: 'intervalSemitones',

    getEnabledItems() {
      return ALL_ITEMS;
    },

    presentQuestion(itemId) {
      currentItem = parseItem(itemId);
      const prompt = container.querySelector('.quiz-prompt');
      const intervalButtons = container.querySelector('.answer-buttons-intervals');
      const numButtons = container.querySelector('.answer-buttons-numbers');

      if (currentItem.dir === 'fwd') {
        // Show interval name, answer is number 1-12
        prompt.textContent = currentItem.interval.name + ' = ?';
        intervalButtons.style.display = 'none';
        numButtons.style.display = '';
      } else {
        // Show number, answer is interval
        prompt.textContent = currentItem.interval.num + ' = ?';
        intervalButtons.style.display = '';
        numButtons.style.display = 'none';
      }
    },

    checkAnswer(itemId, input) {
      if (currentItem.dir === 'fwd') {
        const correct = parseInt(input, 10) === currentItem.interval.num;
        return { correct, correctAnswer: String(currentItem.interval.num) };
      } else {
        const correct = intervalMatchesInput(currentItem.interval, input);
        return { correct, correctAnswer: currentItem.interval.abbrev };
      }
    },

    onStart() {
      if (pendingDigitTimeout) clearTimeout(pendingDigitTimeout);
      pendingDigit = null;
      pendingDigitTimeout = null;
      hideStats();
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    },

    onStop() {
      if (pendingDigitTimeout) clearTimeout(pendingDigitTimeout);
      pendingDigit = null;
      pendingDigitTimeout = null;
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
      showStats('retention');
    },

    handleKey(e, { submitAnswer }) {
      // Keyboard: number keys for forward, no keyboard for interval buttons
      if (currentItem.dir === 'fwd') {
        if (e.key >= '0' && e.key <= '9') {
          e.preventDefault();
          if (pendingDigit !== null) {
            const num = pendingDigit * 10 + parseInt(e.key);
            clearTimeout(pendingDigitTimeout);
            pendingDigit = null;
            pendingDigitTimeout = null;
            if (num >= 1 && num <= 12) {
              submitAnswer(String(num));
            }
            return true;
          }
          const d = parseInt(e.key);
          if (d >= 2 && d <= 9) {
            submitAnswer(String(d));
          } else {
            // 0 or 1 — could be 10, 11, 12
            pendingDigit = d;
            pendingDigitTimeout = setTimeout(() => {
              if (pendingDigit >= 1) submitAnswer(String(pendingDigit));
              pendingDigit = null;
              pendingDigitTimeout = null;
            }, 400);
          }
          return true;
        }
      }
      return false;
    },
  };

  let pendingDigit = null;
  let pendingDigitTimeout = null;

  const engine = createQuizEngine(mode, container);
  engine.storage.preload(ALL_ITEMS);

  function init() {
    // Interval answer buttons
    container.querySelectorAll('.answer-btn-interval').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.interval);
      });
    });

    // Number answer buttons
    container.querySelectorAll('.answer-btn-num').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.num);
      });
    });

    // Start/stop/stats
    container.querySelector('.start-btn').addEventListener('click', () => engine.start());
    container.querySelector('.stop-btn').addEventListener('click', () => engine.stop());
    container.querySelector('.heatmap-btn').addEventListener('click', toggleStats);

    updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    showStats('retention');
  }

  return {
    mode,
    engine,
    init,
    activate() { engine.attach(); },
    deactivate() {
      if (engine.isActive) engine.stop();
      engine.detach();
      if (pendingDigitTimeout) clearTimeout(pendingDigitTimeout);
      pendingDigit = null;
    },
  };
}

// Semitone Math quiz mode: note +/- semitone count = note.
// "C + 3 = ?" -> D#/Eb,  "G - 5 = ?" -> D
// 264 items: 12 notes x 11 intervals (1-11) x 2 directions (+/-).
// Grouped by semitone count for future group toggles.
//
// Depends on globals: NOTES, noteAdd, noteSub, noteMatchesInput,
// createQuizEngine, createNoteKeyHandler, updateModeStats,
// renderStatsGrid, buildStatsLegend

function createSemitoneMathMode() {
  const container = document.getElementById('mode-semitoneMath');

  // Build item list: 12 notes x 11 semitone counts x 2 directions
  // Item ID format: "C+3" or "C-3"
  const ALL_ITEMS = [];
  for (const note of NOTES) {
    for (let s = 1; s <= 11; s++) {
      ALL_ITEMS.push(note.name + '+' + s);
      ALL_ITEMS.push(note.name + '-' + s);
    }
  }

  function parseItem(itemId) {
    const match = itemId.match(/^([A-G]#?)([+-])(\d+)$/);
    const noteName = match[1];
    const op = match[2];
    const semitones = parseInt(match[3]);
    const note = NOTES.find(n => n.name === noteName);
    const answer = op === '+' ? noteAdd(note.num, semitones) : noteSub(note.num, semitones);
    return { note, op, semitones, answer };
  }

  let currentItem = null;
  let statsMode = null; // null | 'retention' | 'speed'
  let statsDir = '+';   // '+' | '-'

  function showStats(mode) {
    statsMode = mode;
    const statsContainer = container.querySelector('.stats-container');
    const btn = container.querySelector('.heatmap-btn');
    const colLabels = [];
    for (let s = 1; s <= 11; s++) colLabels.push(String(s));

    statsContainer.innerHTML = '';

    // Direction toggle
    const dirToggle = document.createElement('div');
    dirToggle.className = 'stats-dir-toggle';
    const plusBtn = document.createElement('button');
    plusBtn.textContent = '+';
    plusBtn.className = 'dir-btn' + (statsDir === '+' ? ' active' : '');
    plusBtn.setAttribute('aria-label', 'Show ascending stats');
    plusBtn.addEventListener('click', () => { statsDir = '+'; showStats(statsMode); });
    const minusBtn = document.createElement('button');
    minusBtn.textContent = '\u2212';
    minusBtn.className = 'dir-btn' + (statsDir === '-' ? ' active' : '');
    minusBtn.setAttribute('aria-label', 'Show descending stats');
    minusBtn.addEventListener('click', () => { statsDir = '-'; showStats(statsMode); });
    dirToggle.appendChild(plusBtn);
    dirToggle.appendChild(minusBtn);
    statsContainer.appendChild(dirToggle);

    // Grid
    const gridDiv = document.createElement('div');
    gridDiv.className = 'stats-grid-wrapper';
    statsContainer.appendChild(gridDiv);
    renderStatsGrid(engine.selector, colLabels, function(noteName, colIdx) {
      return noteName + statsDir + (colIdx + 1);
    }, mode, gridDiv);

    // Legend
    const legendDiv = document.createElement('div');
    legendDiv.innerHTML = buildStatsLegend(mode);
    statsContainer.appendChild(legendDiv);

    statsContainer.style.display = '';
    btn.textContent = mode === 'retention' ? 'Show Speed' : 'Show Recall';
  }

  function hideStats() {
    statsMode = null;
    const statsContainer = container.querySelector('.stats-container');
    statsContainer.style.display = 'none';
    statsContainer.innerHTML = '';
  }

  function toggleStats() {
    if (statsMode === 'retention') showStats('speed');
    else showStats('retention');
  }

  const mode = {
    id: 'semitoneMath',
    name: 'Semitone Math',
    storageNamespace: 'semitoneMath',

    getEnabledItems() {
      return ALL_ITEMS;
    },

    presentQuestion(itemId) {
      currentItem = parseItem(itemId);
      const prompt = container.querySelector('.quiz-prompt');
      prompt.textContent = currentItem.note.displayName + ' ' + currentItem.op + ' ' + currentItem.semitones + ' = ?';
    },

    checkAnswer(itemId, input) {
      const correct = noteMatchesInput(currentItem.answer, input);
      return { correct, correctAnswer: currentItem.answer.displayName };
    },

    onStart() {
      noteKeyHandler.reset();
      hideStats();
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    },

    onStop() {
      noteKeyHandler.reset();
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
      showStats('retention');
    },

    handleKey(e, { submitAnswer }) {
      return noteKeyHandler.handleKey(e);
    },
  };

  const engine = createQuizEngine(mode, container);
  engine.storage.preload(ALL_ITEMS);

  const noteKeyHandler = createNoteKeyHandler(
    (input) => engine.submitAnswer(input),
    () => true
  );

  function init() {
    // Note answer buttons
    container.querySelectorAll('.answer-btn-note').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.note);
      });
    });

    // Start/stop/stats
    container.querySelector('.start-btn').addEventListener('click', () => engine.start());
    container.querySelector('.stop-btn').addEventListener('click', () => engine.stop());
    container.querySelector('.heatmap-btn').addEventListener('click', toggleStats);

    updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    showStats('retention');
  }

  return {
    mode,
    engine,
    init,
    activate() { engine.attach(); },
    deactivate() {
      if (engine.isActive) engine.stop();
      engine.detach();
      noteKeyHandler.reset();
    },
  };
}

// Interval Math quiz mode: note +/- interval = note.
// "C + m3 = ?" -> D#/Eb,  "G - P4 = ?" -> D
// 264 items: 12 notes x 11 intervals (m2-M7) x 2 directions (+/-).
// Excludes octave/P8 (adding 12 semitones gives same note).
// Grouped by interval for future group toggles.
//
// Depends on globals: NOTES, INTERVALS, noteAdd, noteSub,
// noteMatchesInput, createQuizEngine, createNoteKeyHandler, updateModeStats,
// renderStatsGrid, buildStatsLegend

function createIntervalMathMode() {
  const container = document.getElementById('mode-intervalMath');

  // Intervals 1-11 only (no octave)
  const MATH_INTERVALS = INTERVALS.filter(i => i.num >= 1 && i.num <= 11);

  // Build item list: 12 notes x 11 intervals x 2 directions
  // Item ID format: "C+m3" or "C-P4"
  const ALL_ITEMS = [];
  for (const note of NOTES) {
    for (const interval of MATH_INTERVALS) {
      ALL_ITEMS.push(note.name + '+' + interval.abbrev);
      ALL_ITEMS.push(note.name + '-' + interval.abbrev);
    }
  }

  function parseItem(itemId) {
    const match = itemId.match(/^([A-G]#?)([+-])(.+)$/);
    const noteName = match[1];
    const op = match[2];
    const abbrev = match[3];
    const note = NOTES.find(n => n.name === noteName);
    const interval = MATH_INTERVALS.find(i => i.abbrev === abbrev);
    const answer = op === '+' ? noteAdd(note.num, interval.num) : noteSub(note.num, interval.num);
    return { note, op, interval, answer };
  }

  let currentItem = null;
  let statsMode = null; // null | 'retention' | 'speed'
  let statsDir = '+';   // '+' | '-'

  function showStats(mode) {
    statsMode = mode;
    const statsContainer = container.querySelector('.stats-container');
    const btn = container.querySelector('.heatmap-btn');
    const colLabels = MATH_INTERVALS.map(i => i.abbrev);

    statsContainer.innerHTML = '';

    // Direction toggle
    const dirToggle = document.createElement('div');
    dirToggle.className = 'stats-dir-toggle';
    const plusBtn = document.createElement('button');
    plusBtn.textContent = '+';
    plusBtn.className = 'dir-btn' + (statsDir === '+' ? ' active' : '');
    plusBtn.setAttribute('aria-label', 'Show ascending stats');
    plusBtn.addEventListener('click', () => { statsDir = '+'; showStats(statsMode); });
    const minusBtn = document.createElement('button');
    minusBtn.textContent = '\u2212';
    minusBtn.className = 'dir-btn' + (statsDir === '-' ? ' active' : '');
    minusBtn.setAttribute('aria-label', 'Show descending stats');
    minusBtn.addEventListener('click', () => { statsDir = '-'; showStats(statsMode); });
    dirToggle.appendChild(plusBtn);
    dirToggle.appendChild(minusBtn);
    statsContainer.appendChild(dirToggle);

    // Grid
    const gridDiv = document.createElement('div');
    gridDiv.className = 'stats-grid-wrapper';
    statsContainer.appendChild(gridDiv);
    renderStatsGrid(engine.selector, colLabels, function(noteName, colIdx) {
      return noteName + statsDir + MATH_INTERVALS[colIdx].abbrev;
    }, mode, gridDiv);

    // Legend
    const legendDiv = document.createElement('div');
    legendDiv.innerHTML = buildStatsLegend(mode);
    statsContainer.appendChild(legendDiv);

    statsContainer.style.display = '';
    btn.textContent = mode === 'retention' ? 'Show Speed' : 'Show Recall';
  }

  function hideStats() {
    statsMode = null;
    const statsContainer = container.querySelector('.stats-container');
    statsContainer.style.display = 'none';
    statsContainer.innerHTML = '';
  }

  function toggleStats() {
    if (statsMode === 'retention') showStats('speed');
    else showStats('retention');
  }

  const mode = {
    id: 'intervalMath',
    name: 'Interval Math',
    storageNamespace: 'intervalMath',

    getEnabledItems() {
      return ALL_ITEMS;
    },

    presentQuestion(itemId) {
      currentItem = parseItem(itemId);
      const prompt = container.querySelector('.quiz-prompt');
      prompt.textContent = currentItem.note.displayName + ' ' + currentItem.op + ' ' + currentItem.interval.abbrev + ' = ?';
    },

    checkAnswer(itemId, input) {
      const correct = noteMatchesInput(currentItem.answer, input);
      return { correct, correctAnswer: currentItem.answer.displayName };
    },

    onStart() {
      noteKeyHandler.reset();
      hideStats();
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    },

    onStop() {
      noteKeyHandler.reset();
      updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
      showStats('retention');
    },

    handleKey(e, { submitAnswer }) {
      return noteKeyHandler.handleKey(e);
    },
  };

  const engine = createQuizEngine(mode, container);
  engine.storage.preload(ALL_ITEMS);

  const noteKeyHandler = createNoteKeyHandler(
    (input) => engine.submitAnswer(input),
    () => true
  );

  function init() {
    // Note answer buttons
    container.querySelectorAll('.answer-btn-note').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!engine.isActive || engine.isAnswered) return;
        engine.submitAnswer(btn.dataset.note);
      });
    });

    // Start/stop/stats
    container.querySelector('.start-btn').addEventListener('click', () => engine.start());
    container.querySelector('.stop-btn').addEventListener('click', () => engine.stop());
    container.querySelector('.heatmap-btn').addEventListener('click', toggleStats);

    updateModeStats(engine.selector, ALL_ITEMS, engine.els.stats);
    showStats('retention');
  }

  return {
    mode,
    engine,
    init,
    activate() { engine.attach(); },
    deactivate() {
      if (engine.isActive) engine.stop();
      engine.detach();
      noteKeyHandler.reset();
    },
  };
}

// Navigation: hamburger menu and mode switching.
// Persists last-used mode in localStorage.
//
// Depends on DOM: .hamburger, .nav-drawer, .mode-screen, [data-mode]

function createNavigation() {
  const LAST_MODE_KEY = 'fretboard_lastMode';
  const modes = {}; // id -> { init, activate, deactivate, name }
  let currentModeId = null;

  const hamburger = document.querySelector('.hamburger');
  const drawer = document.querySelector('.nav-drawer');
  const overlay = document.querySelector('.nav-overlay');
  const modeTitle = document.getElementById('mode-title');

  function closeDrawer() {
    if (drawer) drawer.classList.remove('open');
    if (overlay) overlay.classList.remove('open');
    if (hamburger) hamburger.setAttribute('aria-expanded', 'false');
  }

  function openDrawer() {
    if (drawer) drawer.classList.add('open');
    if (overlay) overlay.classList.add('open');
    if (hamburger) hamburger.setAttribute('aria-expanded', 'true');
  }

  function registerMode(id, modeController) {
    modes[id] = modeController;
  }

  function switchTo(modeId) {
    if (!modes[modeId]) return;
    if (currentModeId === modeId) {
      closeDrawer();
      return;
    }

    // Deactivate current mode
    if (currentModeId && modes[currentModeId]) {
      modes[currentModeId].deactivate();
      const currentScreen = document.getElementById('mode-' + currentModeId);
      if (currentScreen) currentScreen.style.display = 'none';
    }

    // Activate new mode
    currentModeId = modeId;
    const newScreen = document.getElementById('mode-' + modeId);
    if (newScreen) newScreen.style.display = '';
    modes[modeId].activate();

    // Update title
    if (modeTitle) modeTitle.textContent = modes[modeId].name || modeId;

    // Update active state in drawer
    drawer.querySelectorAll('[data-mode]').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.mode === modeId);
    });

    // Persist
    localStorage.setItem(LAST_MODE_KEY, modeId);
    closeDrawer();
  }

  function init() {
    // Hamburger toggle
    if (hamburger) {
      hamburger.addEventListener('click', () => {
        if (drawer.classList.contains('open')) {
          closeDrawer();
        } else {
          openDrawer();
        }
      });
    }

    // Overlay click closes drawer
    if (overlay) {
      overlay.addEventListener('click', closeDrawer);
    }

    // Mode buttons in drawer
    if (drawer) {
      drawer.querySelectorAll('[data-mode]').forEach(btn => {
        btn.addEventListener('click', () => {
          switchTo(btn.dataset.mode);
        });
      });
    }

    // Initialize all registered modes
    for (const id of Object.keys(modes)) {
      modes[id].init();
    }

    // Hide all mode screens initially
    document.querySelectorAll('.mode-screen').forEach(el => {
      el.style.display = 'none';
    });

    // Switch to last-used mode or default
    const lastMode = localStorage.getItem(LAST_MODE_KEY);
    const startMode = (lastMode && modes[lastMode]) ? lastMode : Object.keys(modes)[0];
    if (startMode) switchTo(startMode);
  }

  return { registerMode, switchTo, init };
}

// App initialization: registers quiz modes and starts navigation.
// Loaded last in the script — depends on all other modules being
// available as globals (adaptive.js, music-data.js, quiz-engine.js,
// quiz-fretboard.js, navigation.js).

(function () {
  const nav = createNavigation();

  // Register fretboard mode
  const fretboard = createFretboardMode();
  nav.registerMode('fretboard', {
    name: 'Fretboard',
    init: fretboard.init,
    activate: fretboard.activate,
    deactivate: fretboard.deactivate,
  });

  // Speed Tap mode
  const speedTap = createSpeedTapMode();
  nav.registerMode('speedTap', {
    name: 'Speed Tap',
    init: speedTap.init,
    activate: speedTap.activate,
    deactivate: speedTap.deactivate,
  });

  // Note <-> Semitones mode
  const noteSemitones = createNoteSemitonesMode();
  nav.registerMode('noteSemitones', {
    name: 'Note \u2194 Semitones',
    init: noteSemitones.init,
    activate: noteSemitones.activate,
    deactivate: noteSemitones.deactivate,
  });

  // Interval <-> Semitones mode
  const intervalSemitones = createIntervalSemitonesMode();
  nav.registerMode('intervalSemitones', {
    name: 'Interval \u2194 Semitones',
    init: intervalSemitones.init,
    activate: intervalSemitones.activate,
    deactivate: intervalSemitones.deactivate,
  });

  // Semitone Math mode
  const semitoneMath = createSemitoneMathMode();
  nav.registerMode('semitoneMath', {
    name: 'Semitone Math',
    init: semitoneMath.init,
    activate: semitoneMath.activate,
    deactivate: semitoneMath.deactivate,
  });

  // Interval Math mode
  const intervalMath = createIntervalMathMode();
  nav.registerMode('intervalMath', {
    name: 'Interval Math',
    init: intervalMath.init,
    activate: intervalMath.activate,
    deactivate: intervalMath.deactivate,
  });

  nav.init();

  // Register service worker for cache busting on iOS home screen
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
})();

  </script>
</body>
</html>